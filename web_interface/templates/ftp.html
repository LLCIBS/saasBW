{% extends "base.html" %}

{% block title %}FTP подключения - Call Analyzer{% endblock %}

{% block extra_css %}
<style>
.ftp-connections-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}

.ftp-connection-card {
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.ftp-connection-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.ftp-connection-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
}

.ftp-connection-card:hover::before {
    opacity: 1;
}

.ftp-connection-card.inactive {
    opacity: 0.6;
}

.ftp-connection-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.ftp-connection-info {
    flex: 1;
}

.ftp-connection-name {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.ftp-connection-host {
    font-size: 0.9rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ftp-connection-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.8125rem;
    font-weight: 600;
    white-space: nowrap;
}

.ftp-connection-status.active {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.ftp-connection-status.inactive {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #4b5563;
}

.ftp-connection-status.error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

.ftp-connection-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.ftp-detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.ftp-detail-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
}

.ftp-detail-value {
    font-size: 0.9rem;
    color: var(--text-primary);
    font-weight: 500;
}

.ftp-connection-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.ftp-stat {
    flex: 1;
    text-align: center;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.ftp-stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.ftp-stat-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.ftp-connection-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-ftp-action {
    flex: 1;
    min-width: 100px;
}

.empty-state-ftp {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    border: 2px dashed var(--border-medium);
}

.empty-state-ftp i {
    font-size: 4rem;
    color: var(--text-tertiary);
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .ftp-connections-grid {
        grid-template-columns: 1fr;
    }
    
    .ftp-connection-details {
        grid-template-columns: 1fr;
    }
    
    .ftp-connection-actions {
        flex-direction: column;
    }
    
    .btn-ftp-action {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h1 class="h3 mb-1">FTP подключения</h1>
                <p class="text-muted mb-0">Настройте FTP/SFTP подключения для автоматической загрузки файлов</p>
            </div>
            <button class="btn btn-primary" onclick="showAddModal()">
                <i class="fas fa-plus me-2"></i>Добавить подключение
            </button>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-info d-flex align-items-start gap-3 mb-4">
            <i class="fas fa-info-circle mt-1"></i>
            <div>
                <strong>Информация</strong>
                <p class="mb-0">Настройте FTP/SFTP подключения для автоматической загрузки файлов звонков с удаленных серверов. Система будет периодически синхронизировать файлы согласно указанному интервалу.</p>
            </div>
        </div>

        <!-- Connections Grid -->
        <div id="connectionsGrid" class="ftp-connections-grid">
            <!-- Loading State -->
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="text-muted">Загрузка подключений...</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно добавления/редактирования -->
<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-server me-2"></i>FTP подключение
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <input type="hidden" id="connectionId">
                    
                    <div class="mb-3">
                        <label class="form-label">Название подключения *</label>
                        <input type="text" class="form-control" id="connName" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Хост (IP или домен) *</label>
                            <input type="text" class="form-control" id="connHost" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Порт *</label>
                            <input type="number" class="form-control" id="connPort" value="21" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Протокол *</label>
                        <select class="form-select" id="connProtocol" required>
                            <option value="ftp">FTP</option>
                            <option value="sftp">SFTP</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Имя пользователя *</label>
                            <input type="text" class="form-control" id="connUser" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                Пароль <span id="passwordRequired">*</span>
                                <small class="text-muted" id="passwordHint" style="display:none;">(оставьте пустым, чтобы не менять)</small>
                            </label>
                            <input type="password" class="form-control" id="connPassword" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Удаленная папка *</label>
                        <input type="text" class="form-control" id="connRemotePath" value="/" required>
                        <small class="form-text text-muted">Путь к папке на FTP сервере (например: /calls или /recordings)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Начать обработку с даты</label>
                            <input type="datetime-local" class="form-control" id="connStartFrom">
                            <small class="form-text text-muted">Файлы старше выбранной даты игнорируются. Поле необязательное.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Последний обработанный файл</label>
                            <div class="form-control-plaintext border rounded bg-light py-2 px-3" id="connLastProcessedInfo">—</div>
                            <small class="form-text text-muted">Это поле только для чтения.</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Интервал синхронизации (секунды) *</label>
                        <input type="number" class="form-control" id="connSyncInterval" value="300" min="60" required>
                        <small class="form-text text-muted">Минимальный интервал: 60 секунд</small>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="connIsActive" checked>
                        <label class="form-check-label" for="connIsActive">
                            Активно (включить автоматическую синхронизацию)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Отмена
                </button>
                <button type="button" class="btn btn-primary" onclick="testConnection()">
                    <i class="fas fa-plug me-2"></i>Тест подключения
                </button>
                <button type="button" class="btn btn-success" onclick="saveConnection()">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let connections = [];

// Загрузка при старте
document.addEventListener('DOMContentLoaded', function() {
    loadConnections();
    
    // Обновление порта при смене протокола
    document.getElementById('connProtocol')?.addEventListener('change', function() {
        const portInput = document.getElementById('connPort');
        if (this.value === 'ftp') {
            portInput.value = '21';
        } else if (this.value === 'sftp') {
            portInput.value = '22';
        }
    });
});

async function loadConnections() {
    try {
        const response = await fetch('/api/ftp/connections');
        connections = await response.json();
        renderConnections();
    } catch (error) {
        console.error('Ошибка загрузки подключений:', error);
        showAlert('Ошибка загрузки подключений', 'danger');
    }
}

function renderConnections() {
    const grid = document.getElementById('connectionsGrid');
    
    if (connections.error) {
        grid.innerHTML = `<div class="col-12"><div class="alert alert-danger">Ошибка: ${connections.error}</div></div>`;
        return;
    }
    
    if (connections.length === 0) {
        grid.innerHTML = `
            <div class="empty-state-ftp">
                <i class="fas fa-server"></i>
                <h4>Нет подключений</h4>
                <p class="text-muted">Добавьте первое FTP/SFTP подключение для начала работы</p>
                <button class="btn btn-primary mt-3" onclick="showAddModal()">
                    <i class="fas fa-plus me-2"></i>Добавить подключение
                </button>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = connections.map(conn => {
        const statusClass = conn.is_active ? 'active' : 'inactive';
        const statusText = conn.is_active ? 'Активно' : 'Неактивно';
        
        return `
        <div class="ftp-connection-card ${!conn.is_active ? 'inactive' : ''}" data-id="${conn.id}">
            <div class="ftp-connection-header">
                <div class="ftp-connection-info">
                    <div class="ftp-connection-name">${escapeHtml(conn.name)}</div>
                    <div class="ftp-connection-host">
                        <i class="fas fa-${conn.protocol === 'sftp' ? 'lock' : 'folder-open'}"></i>
                        <span>${conn.protocol.toUpperCase()}://${escapeHtml(conn.host)}:${conn.port}</span>
                    </div>
                </div>
                <div class="ftp-connection-status ${statusClass}">
                    <span class="status-dot"></span>
                    ${statusText}
                </div>
            </div>
            
            <div class="ftp-connection-details">
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Папка</div>
                    <div class="ftp-detail-value">${escapeHtml(conn.remote_path)}</div>
                </div>
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Интервал</div>
                    <div class="ftp-detail-value">${conn.sync_interval} сек</div>
                </div>
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Последняя синхронизация</div>
                    <div class="ftp-detail-value">
                        ${conn.last_sync ? formatDateUTC(conn.last_sync) : 'Никогда'}
                        ${conn.last_error ? `<br><small class="text-danger">${escapeHtml(conn.last_error.substring(0, 30))}...</small>` : ''}
                    </div>
                </div>
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Протокол</div>
                    <div class="ftp-detail-value">${conn.protocol.toUpperCase()}</div>
                </div>
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Дата старта</div>
                    <div class="ftp-detail-value">
                        ${conn.start_from ? new Date(conn.start_from).toLocaleString('ru-RU') : 'Не задано'}
                    </div>
                </div>
                <div class="ftp-detail-item">
                    <div class="ftp-detail-label">Последний файл</div>
                    <div class="ftp-detail-value">
                        ${conn.last_processed_mtime ? formatDateUTC(conn.last_processed_mtime) : '—'}
                        ${conn.last_processed_filename ? `<br><small class="text-muted">${escapeHtml(conn.last_processed_filename.substring(0, 20))}...</small>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="ftp-connection-stats">
                <div class="ftp-stat">
                    <div class="ftp-stat-value">${conn.download_count || 0}</div>
                    <div class="ftp-stat-label">Файлов</div>
                </div>
                <div class="ftp-stat">
                    <div class="ftp-stat-value">${conn.sync_interval}с</div>
                    <div class="ftp-stat-label">Интервал</div>
                </div>
            </div>
            
            <div class="ftp-connection-actions">
                <button class="btn btn-primary btn-ftp-action btn-sm" onclick="editConnection(${conn.id})">
                    <i class="fas fa-edit me-1"></i>Изменить
                </button>
                <button class="btn btn-success btn-ftp-action btn-sm" onclick="syncConnection(${conn.id})">
                    <i class="fas fa-sync me-1"></i>Синхронизировать
                </button>
                <button class="btn btn-outline-primary btn-ftp-action btn-sm" onclick="testConnectionId(${conn.id})">
                    <i class="fas fa-vial me-1"></i>Тест
                </button>
                <button class="btn btn-danger btn-ftp-action btn-sm" onclick="deleteConnection(${conn.id})">
                    <i class="fas fa-trash me-1"></i>Удалить
                </button>
            </div>
        </div>
    `;
    }).join('');
}

function showAddModal() {
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Добавить FTP подключение';
    document.getElementById('connectionForm').reset();
    document.getElementById('connectionId').value = '';
    document.getElementById('connPort').value = '21';
    document.getElementById('connProtocol').value = 'ftp';
    document.getElementById('connSyncInterval').value = '300';
    document.getElementById('connStartFrom').value = '';
    document.getElementById('connLastProcessedInfo').innerHTML = '—';
    document.getElementById('connIsActive').checked = true;
    document.getElementById('connRemotePath').value = '/';
    document.getElementById('connPassword').required = true;
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('passwordHint').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('connectionModal'));
    modal.show();
}

function editConnection(id) {
    const conn = connections.find(c => c.id === id);
    if (!conn) {
        showAlert('Подключение не найдено', 'danger');
        return;
    }
    
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Редактировать FTP подключение';
    document.getElementById('connectionId').value = conn.id;
    document.getElementById('connName').value = conn.name;
    document.getElementById('connHost').value = conn.host;
    document.getElementById('connPort').value = conn.port;
    document.getElementById('connProtocol').value = conn.protocol;
    document.getElementById('connUser').value = conn.username;
    document.getElementById('connPassword').value = '';
    document.getElementById('connPassword').required = false;
    document.getElementById('passwordRequired').style.display = 'none';
    document.getElementById('passwordHint').style.display = 'inline';
    document.getElementById('connRemotePath').value = conn.remote_path;
    document.getElementById('connSyncInterval').value = conn.sync_interval;
    document.getElementById('connStartFrom').value = formatDatetimeLocal(conn.start_from);
    renderLastProcessedInfo(conn);
    document.getElementById('connIsActive').checked = conn.is_active;
    
    const modal = new bootstrap.Modal(document.getElementById('connectionModal'));
    modal.show();
}

async function saveConnection() {
    const form = document.getElementById('connectionForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const id = document.getElementById('connectionId').value;
    const data = {
        name: document.getElementById('connName').value,
        host: document.getElementById('connHost').value,
        port: parseInt(document.getElementById('connPort').value),
        protocol: document.getElementById('connProtocol').value,
        username: document.getElementById('connUser').value,
        password: document.getElementById('connPassword').value,
        remote_path: document.getElementById('connRemotePath').value,
        sync_interval: parseInt(document.getElementById('connSyncInterval').value),
        is_active: document.getElementById('connIsActive').checked
    };

    const startFromValue = document.getElementById('connStartFrom').value;
    data.start_from = startFromValue ? new Date(startFromValue).toISOString() : null;
    
    try {
        const url = id ? `/api/ftp/connections/${id}` : '/api/ftp/connections';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message || 'Подключение сохранено', 'success');
            bootstrap.Modal.getInstance(document.getElementById('connectionModal')).hide();
            loadConnections();
        } else {
            showAlert(result.message || 'Ошибка сохранения', 'danger');
        }
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        showAlert('Ошибка сохранения подключения', 'danger');
    }
}

async function testConnection() {
    const id = document.getElementById('connectionId').value;
    
    if (!id) {
        showAlert('Для тестирования сначала сохраните подключение', 'warning');
        return;
    }
    
    try {
        showAlert('Тестирование подключения...', 'info');
        
        const response = await fetch(`/api/ftp/connections/${id}/test`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message || 'Подключение успешно', 'success');
        } else {
            showAlert(result.message || 'Ошибка подключения', 'danger');
        }
    } catch (error) {
        console.error('Ошибка тестирования:', error);
        showAlert('Ошибка тестирования подключения', 'danger');
    }
}

async function testConnectionId(id) {
    try {
        showAlert('Тестирование подключения...', 'info');
        
        const response = await fetch(`/api/ftp/connections/${id}/test`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message || 'Подключение успешно', 'success');
        } else {
            showAlert(result.message || 'Ошибка подключения', 'danger');
        }
    } catch (error) {
        console.error('Ошибка тестирования:', error);
        showAlert('Ошибка тестирования подключения', 'danger');
    }
}

async function syncConnection(id) {
    showConfirm('Запустить синхронизацию сейчас?', async () => {
        try {
            const response = await fetch(`/api/ftp/connections/${id}/sync`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message || 'Синхронизация запущена', 'success');
                // Обновляем список для обновления статусов
                setTimeout(() => loadConnections(), 2000);
            } else {
                showAlert(result.message || 'Ошибка запуска синхронизации', 'danger');
            }
        } catch (error) {
            console.error('Ошибка синхронизации:', error);
            showAlert('Ошибка запуска синхронизации', 'danger');
        }
    });
}

async function deleteConnection(id) {
    showConfirm('Удалить это подключение?', async () => {
        try {
            const response = await fetch(`/api/ftp/connections/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message || 'Подключение удалено', 'success');
                loadConnections();
            } else {
                showAlert(result.message || 'Ошибка удаления', 'danger');
            }
        } catch (error) {
            console.error('Ошибка удаления:', error);
            showAlert('Ошибка удаления подключения', 'danger');
        }
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Форматирование UTC даты в локальную строку
function formatDateUTC(isoString) {
    if (!isoString) {
        return '';
    }
    // Создаем дату из UTC строки (должна содержать 'Z')
    const date = new Date(isoString);
    return date.toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function formatDatetimeLocal(isoString) {
    if (!isoString) {
        return '';
    }
    // Создаем дату из UTC строки
    const date = new Date(isoString);
    const pad = (value) => String(value).padStart(2, '0');
    // Используем UTC методы для получения значений
    return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())}T${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}`;
}

function renderLastProcessedInfo(conn) {
    const infoEl = document.getElementById('connLastProcessedInfo');
    if (!infoEl) {
        return;
    }
    if (!conn || !conn.last_processed_mtime) {
        infoEl.innerHTML = '—';
        return;
    }
    const datetimeText = formatDateUTC(conn.last_processed_mtime);
    let html = escapeHtml(datetimeText);
    if (conn.last_processed_filename) {
        html += `<br><small>${escapeHtml(conn.last_processed_filename)}</small>`;
    }
    infoEl.innerHTML = html;
}
</script>
{% endblock %}
