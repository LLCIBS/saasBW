{% extends "base.html" %}

{% block title %}Управление словарем - Call Analyzer{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
            <div>
                <h1 class="h3 mb-1">Управление словарем</h1>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="vocabEnabledSwitch" onchange="toggleVocabEnabled(this)">
                    <label class="form-check-label" for="vocabEnabledSwitch">
                        Использовать дополнительный словарь при транскрипции
                    </label>
                </div>
            </div>
            <button class="btn btn-save" onclick="saveVocabulary()">
                <i class="fas fa-save me-2"></i>Сохранить словарь
            </button>
        </div>

        <!-- Дополнительный словарь -->
        <div class="config-section">
            <h3 class="config-title">
                <i class="fas fa-book me-2"></i>Дополнительный словарь для транскрипции
            </h3>
            <p class="text-muted mb-4">
                Добавьте специальные термины, названия станций и другие слова, которые должны быть правильно распознаны при транскрипции звонков.
            </p>
            
            <div class="mb-4">
                <label class="form-label">Добавить новое слово</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="newVocabularyItem" 
                           placeholder="Введите слово или фразу">
                    <button class="btn btn-outline-primary" type="button" onclick="addVocabularyItem()">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
            </div>
            
            <div id="vocabularyContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Загрузка словаря...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Предустановленные слова (по отраслевому профилю) -->
        <div class="config-section">
            <h3 class="config-title">
                <i class="fas fa-magic me-2"></i>Предустановленные слова
            </h3>
            <p class="text-muted mb-4">
                Быстро добавить термины для вашей отрасли:
            </p>
            <div id="vocabPresetsContainer">
                <div class="text-muted">Загрузка пресетов...</div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let vocabularyData = [];
let vocabularyEnabled = true;

// Загрузка словаря при старте
document.addEventListener('DOMContentLoaded', function() {
    loadVocabulary();
});

async function loadVocabulary() {
    try {
        const response = await fetch('/api/vocabulary');
        const data = await response.json();
        vocabularyData = data.additional_vocab || [];
        vocabularyEnabled = (data.enabled !== undefined) ? !!data.enabled : true;
        applyVocabEnabledState();
        renderVocabulary();
        renderVocabPresets(data.vocab_presets || {});
    } catch (error) {
        console.error('Ошибка загрузки словаря:', error);
        showAlert('Ошибка загрузки словаря', 'danger');
    }
}

function renderVocabPresets(presets) {
    const container = document.getElementById('vocabPresetsContainer');
    if (!container) return;
    const stations = presets.stations || [];
    const terms = presets.terms || [];
    if (stations.length === 0 && terms.length === 0) {
        container.innerHTML = '<div class="text-muted">Нет пресетов для текущего профиля</div>';
        return;
    }
    let html = '<div class="row">';
    if (stations.length > 0) {
        html += '<div class="col-md-6"><h6 class="mb-3">Названия филиалов/локаций:</h6><div class="mb-3">';
        stations.forEach(w => {
            const esc = w.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `<button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="addPresetWord('${esc}')">${w}</button>`;
        });
        html += '</div></div>';
    }
    if (terms.length > 0) {
        html += '<div class="col-md-6"><h6 class="mb-3">Термины отрасли:</h6><div class="mb-3">';
        terms.forEach(w => {
            const esc = w.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `<button class="btn btn-outline-secondary btn-sm me-2 mb-2" onclick="addPresetWord('${esc}')">${w}</button>`;
        });
        html += '</div></div>';
    }
    html += '</div>';
    container.innerHTML = html;
}

function applyVocabEnabledState() {
    const switchEl = document.getElementById('vocabEnabledSwitch');
    const inputNew = document.getElementById('newVocabularyItem');
    const addButton = inputNew?.nextElementSibling;

    if (switchEl) {
        switchEl.checked = vocabularyEnabled;
    }

    if (inputNew) {
        inputNew.disabled = !vocabularyEnabled;
    }
    if (addButton) {
        addButton.disabled = !vocabularyEnabled;
    }
}

function toggleVocabEnabled(checkbox) {
    vocabularyEnabled = !!checkbox.checked;
    applyVocabEnabledState();
}

function renderVocabulary() {
    const container = document.getElementById('vocabularyContainer');
    
    if (vocabularyData.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">Словарь пуст</div>';
        return;
    }

    const vocabularyHtml = vocabularyData.map(item => `
        <span class="vocabulary-item" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; margin: 4px; display: inline-block; transition: all 0.3s;">
            ${item}
            <span class="remove-item" onclick="removeVocabularyItem('${item.replace(/'/g, "\\'")}')" style="cursor: pointer; margin-left: 8px; color: #d32f2f; font-weight: bold;">×</span>
        </span>
    `).join('');

    container.innerHTML = vocabularyHtml;
}

function addVocabularyItem() {
    const input = document.getElementById('newVocabularyItem');
    const item = input.value.trim();
    
    if (item) {
        if (vocabularyData.includes(item)) {
            showAlert('Это слово уже есть в словаре', 'warning');
            return;
        }
        vocabularyData.push(item);
        renderVocabulary();
        input.value = '';
    }
}

function addPresetWord(word) {
    if (!vocabularyData.includes(word)) {
        vocabularyData.push(word);
        renderVocabulary();
        showAlert(`Добавлено: ${word}`, 'success');
    } else {
        showAlert(`Слово "${word}" уже есть в словаре`, 'info');
    }
}

function removeVocabularyItem(item) {
    vocabularyData = vocabularyData.filter(v => v !== item);
    renderVocabulary();
}

async function saveVocabulary() {
    try {
        const vocabularyDataToSave = {
            enabled: vocabularyEnabled,
            additional_vocab: vocabularyData
        };

        const response = await fetch('/api/vocabulary/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(vocabularyDataToSave)
        });

        const result = await response.json();
        
        if (result.success) {
            showAlert('Словарь сохранен успешно', 'success');
        } else {
            showAlert(result.message, 'danger');
        }
        
    } catch (error) {
        console.error('Ошибка сохранения словаря:', error);
        showAlert('Ошибка сохранения словаря', 'danger');
    }
}
</script>
{% endblock %}
