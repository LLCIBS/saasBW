{% extends "base.html" %}

{% block title %}Аналитика самообучения - Система разбора звонков{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        {% include 'classification/_nav.html' %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-line me-2"></i>
        Аналитика самообучения
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshAnalytics()">
                <i class="fas fa-sync-alt me-1"></i>
                Обновить
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="exportReport()">
                <i class="fas fa-download me-1"></i>
                Экспорт отчета
            </button>
        </div>
    </div>
</div>

<!-- Общий прогресс обучения -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Прогресс обучения (последние {{ report.learning_progress.period_days }} дней)
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ "%.1f"|format(report.learning_progress.current_accuracy) }}%</h3>
                            <p class="text-muted mb-0">Текущая точность</p>
                            {% if report.learning_progress.accuracy_improvement > 0 %}
                                <span class="badge bg-success mt-1">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    +{{ "%.1f"|format(report.learning_progress.accuracy_improvement) }}%
                                </span>
                            {% elif report.learning_progress.accuracy_improvement < 0 %}
                                <span class="badge bg-danger mt-1">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    {{ "%.1f"|format(report.learning_progress.accuracy_improvement) }}%
                                </span>
                            {% else %}
                                <span class="badge bg-secondary mt-1">Без изменений</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success">{{ report.learning_progress.total_confirmations }}</h3>
                            <p class="text-muted mb-0">Подтверждено правильных</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-danger">{{ report.learning_progress.total_corrections }}</h3>
                            <p class="text-muted mb-0">Найдено ошибок</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">{{ report.learning_progress.total_interactions }}</h3>
                            <p class="text-muted mb-0">Всего взаимодействий</p>
                        </div>
                    </div>
                </div>
                {% if report.learning_progress.avg_confidence %}
                <div class="row mt-3">
                    <div class="col-12">
                        <p class="text-muted mb-0">
                            <i class="fas fa-star me-1"></i>
                            Средняя уверенность пользователей: {{ "%.1f"|format(report.learning_progress.avg_confidence) }}/10
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- График прогресса точности -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Динамика точности классификации
                </h5>
            </div>
            <div class="card-body">
                <canvas id="accuracyChart" style="max-height: 300px;"></canvas>
                <p class="text-muted mt-2 mb-0">
                    <small>График показывает изменение точности классификации за последние {{ report.learning_progress.period_days }} дней</small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Топ частых ошибок -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Частые ошибки классификации
                </h5>
            </div>
            <div class="card-body">
                {% if report.error_patterns.top_5 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Переход категорий</th>
                                    <th>Частота</th>
                                    <th>Уверенность</th>
                                    <th>Ключевые слова</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pattern in report.error_patterns.top_5 %}
                                <tr>
                                    <td>
                                        <span class="badge bg-danger">{{ pattern.original_category }}</span>
                                        <i class="fas fa-arrow-right mx-2"></i>
                                        <span class="badge bg-success">{{ pattern.corrected_category }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ pattern.frequency }}</strong> раз
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ (pattern.confidence * 100)|int }}%"
                                                 aria-valuenow="{{ pattern.confidence }}" 
                                                 aria-valuemin="0" aria-valuemax="1">
                                                {{ "%.0f"|format(pattern.confidence * 100) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if pattern.common_keywords %}
                                            {% for keyword in pattern.common_keywords[:5] %}
                                                <span class="badge bg-secondary me-1">{{ keyword }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Нет данных о частых ошибках за указанный период. Система начнет собирать статистику после корректировок.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Успешные и проблемные категории -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Успешные категории (высокая точность)
                </h5>
            </div>
            <div class="card-body">
                {% if report.success_statistics.top_performing %}
                    <div class="list-group">
                        {% for cat in report.success_statistics.top_performing %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ categories.get(cat.category, cat.category) }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Подтверждено: {{ cat.confirmed_correct }} / Всего: {{ cat.total }}
                                    </small>
                                </div>
                                <span class="badge bg-success">{{ "%.1f"|format(cat.success_rate) }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Недостаточно данных для анализа успешных категорий.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Проблемные категории (требуют внимания)
                </h5>
            </div>
            <div class="card-body">
                {% if report.success_statistics.needs_attention %}
                    <div class="list-group">
                        {% for cat in report.success_statistics.needs_attention %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ categories.get(cat.category, cat.category) }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Подтверждено: {{ cat.confirmed_correct }} / Всего: {{ cat.total }}
                                    </small>
                                </div>
                                <span class="badge bg-danger">{{ "%.1f"|format(cat.success_rate) }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Отлично! Все категории имеют приемлемую точность классификации.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Эффективность примеров -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Эффективность обучающих примеров
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-success">{{ report.example_effectiveness.effective_count }}</h4>
                            <p class="text-muted mb-0">Эффективных примеров</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-danger">{{ report.example_effectiveness.ineffective_count }}</h4>
                            <p class="text-muted mb-0">Неэффективных примеров</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-info">{{ report.error_patterns.total }}</h4>
                            <p class="text-muted mb-0">Паттернов ошибок обнаружено</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Рекомендации системы -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Рекомендации системы
                </h5>
            </div>
            <div class="card-body">
                {% if report.recommendations %}
                    <ul class="list-group">
                        {% for recommendation in report.recommendations %}
                        <li class="list-group-item">
                            <i class="fas fa-chevron-right me-2 text-primary"></i>
                            {{ recommendation }}
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Система работает стабильно, рекомендаций нет.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Предложения по улучшению -->
{% if report.suggestions.all %}
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Предложения по улучшению ({{ report.suggestions.total }})
                </h5>
            </div>
            <div class="card-body">
                {% for suggestion in report.suggestions.all %}
                <div class="alert {% if suggestion.priority == 'high' %}alert-danger{% elif suggestion.priority == 'medium' %}alert-warning{% else %}alert-info{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>
                                {% if suggestion.type == 'deactivate' %}
                                    <i class="fas fa-ban me-1"></i>
                                    Деактивировать пример #{{ suggestion.example_id }}
                                {% elif suggestion.type == 'add_examples' %}
                                    <i class="fas fa-plus-circle me-1"></i>
                                    Добавить примеры для категории {{ suggestion.category }}
                                {% else %}
                                    {{ suggestion.type }}
                                {% endif %}
                            </strong>
                            <p class="mb-0 mt-1">{{ suggestion.reason }}</p>
                            {% if suggestion.suggested_keywords %}
                                <div class="mt-2">
                                    <small>Рекомендуемые ключевые слова:</small>
                                    {% for keyword in suggestion.suggested_keywords %}
                                        <span class="badge bg-secondary me-1">{{ keyword }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <span class="badge {% if suggestion.priority == 'high' %}bg-danger{% elif suggestion.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ suggestion.priority }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
    </div>
</main>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function refreshAnalytics() {
    window.location.reload();
}

function exportReport() {
    // Показываем индикатор загрузки
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Экспорт...';
    
    // Запрашиваем экспорт отчета
    fetch('/classification/api/export-learning-report')
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка экспорта');
            }
            return response.blob();
        })
        .then(blob => {
            // Создаем ссылку для скачивания
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `learning_analytics_report_${date}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            // Показываем уведомление
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-3';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Отчет успешно экспортирован!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const content = document.querySelector('.main-content .p-4') || document.body;
            if (content) {
                content.insertBefore(alert, content.firstChild);
            }
            
            setTimeout(() => alert.remove(), 5000);
        })
        .catch(error => {
            console.error('Ошибка экспорта:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Ошибка при экспорте отчета: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const content = document.querySelector('.main-content .p-4') || document.body;
            if (content) {
                content.insertBefore(alert, content.firstChild);
            }
            
            setTimeout(() => alert.remove(), 5000);
        });
}

// Данные для графика точности
const accuracyData = {
    current: {{ report.learning_progress.current_accuracy|default(0) }},
    previous: {{ (report.learning_progress.current_accuracy - report.learning_progress.accuracy_improvement)|default(0) }},
    period_days: {{ report.learning_progress.period_days|default(30) }}
};

// Строим график прогресса точности
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('accuracyChart');
    if (ctx) {
        // Получаем данные за период (упрощенная версия - можно улучшить)
        const labels = [];
        const accuracyValues = [];
        const daysCount = Math.min(accuracyData.period_days, 30);
        
        // Создаем точки для графика (симуляция данных)
        // В реальности нужно получать данные за каждый день из БД
        for (let i = daysCount; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
            
            // Интерполяция между предыдущим и текущим значением
            const progress = (daysCount - i) / daysCount;
            const value = accuracyData.previous + (accuracyData.current - accuracyData.previous) * progress;
            accuracyValues.push(Math.max(0, Math.min(100, value)));
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Точность классификации (%)',
                    data: accuracyValues,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Точность: ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.max(0, Math.min(...accuracyValues) - 10),
                        max: Math.min(100, Math.max(...accuracyValues) + 10),
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
});

// Автообновление каждые 5 минут
setInterval(refreshAnalytics, 300000);
</script>
{% endblock %}


