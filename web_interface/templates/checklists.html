<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤ - Call Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .stub-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stub-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            {% include 'partials/sidebar.html' %}

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <main class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤</h1>
                            <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø—Ä–æ–≥–æ–Ω–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.</p>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="stub-card text-start">
                                <form id="checklistForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–§–∞–π–ª –∑–≤–æ–Ω–∫–∞</label>
                                        <input class="form-control" type="file" id="audioFile" name="file" accept=".mp3,.wav" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–°—Ç–∞–Ω—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                        <select class="form-select" id="stationSelect">
                                            <option value="">–ê–≤—Ç–æ (–∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–§–∞–π–ª —á–µ–∫-–ª–∏—Å—Ç–∞</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="scriptPromptPath" readonly>
                                            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        </div>
                                        <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –ø—É—Ç—å.</div>
                                        <input type="text" class="form-control mt-2" id="scriptPromptOverride" placeholder="–ü—É—Ç—å –∫ –¥—Ä—É–≥–æ–º—É script_prompt_8.yaml (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <button type="submit" class="btn btn-save" id="runTestBtn">
                                            <i class="fas fa-play me-2"></i>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clearBtn" onclick="clearResults()">
                                            <i class="fas fa-eraser me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                                        </button>
                                        <div class="text-muted" id="statusText"></div>
                                    </div>
                                </form>
                            </div>

                            <div id="resultsCard" class="stub-card text-start" style="display:none;">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stub-icon me-3">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h5>
                                        <small class="text-muted" id="resultMessage"></small>
                                    </div>
                                </div>
                                <div id="resultLinks"></div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="stub-card text-start" id="checklistCard" style="display:none;">
                                <h5 class="mb-3">–†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É</h5>
                                <div class="mb-2 text-muted" id="checklistCaption"></div>
                                
                                <!-- –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è -->
                                <div id="checklistItemsList"></div>
                                
                                <div class="mt-3" id="checklistOverall" style="white-space:pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;"></div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-primary" id="analyzeBtn" onclick="analyzeChecklist()">
                                        <i class="fas fa-search me-2"></i>–ê–Ω–∞–ª–∏–∑
                                    </button>
                                    <span class="ms-2 text-muted" id="analyzeStatus" style="display:none;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const stationSelect = document.getElementById('stationSelect');
        const scriptPromptPath = document.getElementById('scriptPromptPath');
        const scriptPromptOverride = document.getElementById('scriptPromptOverride');
        const statusText = document.getElementById('statusText');
        const resultsCard = document.getElementById('resultsCard');
        const resultMessage = document.getElementById('resultMessage');
        const resultLinks = document.getElementById('resultLinks');
        const formEl = document.getElementById('checklistForm');
        const checklistCard = document.getElementById('checklistCard');
        const checklistCaption = document.getElementById('checklistCaption');
        const checklistItemsList = document.getElementById('checklistItemsList');
        const checklistOverall = document.getElementById('checklistOverall');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeStatus = document.getElementById('analyzeStatus');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        let lastTestData = null;
        let checklistItems = [];
        let checklistPromptsData = null; // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏

        function setHtmlWithNewlines(el, text) {
            if (!text) {
                el.innerHTML = '';
                return;
            }
            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º HTML-—Ç–µ–≥–∏ –∏–∑ Telegram (`<b>`, –∏ —Ç.–ø.) –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            el.innerHTML = text.replace(/\n/g, '<br>');
        }

        function parseChecklistItems(qaText) {
            // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã –∏–∑ qa_text –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ ‚Äî –î–ê"
            const items = [];
            const lines = qaText.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç ‚Äî –î–ê/–ù–ï–¢"
                const match = line.match(/^(\d+)\.\s*(üü¢|üî¥)\s*(.+?)\s*‚Äî\s*(–î–ê|–ù–ï–¢)$/);
                if (match) {
                    items.push({
                        num: match[1],
                        icon: match[2],
                        text: match[3].trim(),
                        result: match[4],
                        explanation: '' // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
                    });
                }
            }
            
            return items;
        }

        function extractCaptionHeader(caption) {
            // –£–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –∏–∑ caption, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —à–∞–ø–∫—É
            if (!caption) return '';
            
            const lines = caption.split('\n');
            let headerLines = [];
            
            for (let line of lines) {
                line = line.trim();
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "1.", –∑–Ω–∞—á–∏—Ç –Ω–∞—á–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ - –ø—Ä–µ—Ä—ã–≤–∞–µ–º
                if (line.match(/^1\.\s*(üü¢|üî¥)/)) {
                    break;
                }
                headerLines.push(line);
            }
            
            return headerLines.join('\n').trim();
        }

        function renderChecklistItems() {
            checklistItemsList.innerHTML = '';
            
            checklistItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-2 border-bottom pb-2';
                itemDiv.style.fontFamily = "'Courier New', monospace";
                itemDiv.style.fontSize = '0.9rem';
                
                const mainLine = document.createElement('div');
                mainLine.innerHTML = `${item.num}. ${item.icon} ${item.text} ‚Äî <b>${item.result}</b>`;
                
                const explDiv = document.createElement('div');
                explDiv.id = `expl-${item.num}`;
                explDiv.className = 'mt-2 ps-3 border-start border-2 border-primary';
                explDiv.style.display = 'none';
                explDiv.style.whiteSpace = 'pre-wrap';
                explDiv.style.fontSize = '0.85rem';
                explDiv.style.color = '#666';
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-link text-decoration-none p-0 ms-2';
                toggleBtn.style.display = 'none'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
                toggleBtn.id = `toggle-${item.num}`;
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
                toggleBtn.onclick = () => {
                    const isHidden = explDiv.style.display === 'none';
                    explDiv.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.innerHTML = isHidden 
                        ? '<i class="fas fa-chevron-up"></i> –°–≤–µ—Ä–Ω—É—Ç—å'
                        : '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
                };
                
                mainLine.appendChild(toggleBtn);
                itemDiv.appendChild(mainLine);
                itemDiv.appendChild(explDiv);
                checklistItemsList.appendChild(itemDiv);
            });
        }

        async function loadMeta() {
            try {
                const resp = await fetch('/api/checklists/meta');
                const data = await resp.json();
                (data.stations || []).forEach(st => {
                    const opt = document.createElement('option');
                    opt.value = st.code;
                    opt.textContent = `${st.code} ‚Äî ${st.name}`;
                    stationSelect.appendChild(opt);
                });
                if (data.script_prompt_file) {
                    scriptPromptPath.value = data.script_prompt_file;
                }
            } catch (e) {
                statusText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
            }
        }

        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–º
            resultsCard.style.display = 'none';
            checklistCard.style.display = 'none';
            checklistItemsList.innerHTML = '';
            checklistOverall.innerHTML = '';
            analyzeStatus.style.display = 'none';
            analyzeStatus.textContent = '';
            lastTestData = null;
            checklistItems = [];
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage
            localStorage.removeItem('checklistAnalysisResults');
            
            statusText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞...';
            const file = document.getElementById('audioFile').files[0];
            if (!file) {
                statusText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            if (stationSelect.value) {
                formData.append('station_code', stationSelect.value);
            }
            if (scriptPromptOverride.value.trim()) {
                formData.append('script_prompt_file', scriptPromptOverride.value.trim());
            }

            try {
                const resp = await fetch('/api/checklists/test', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    statusText.textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.';
                    return;
                }
                statusText.textContent = '';
                resultMessage.textContent = data.message || '–ì–æ—Ç–æ–≤–æ.';
                resultLinks.innerHTML = '';
                const paths = data.paths || {};
                Object.entries(paths).forEach(([key, val]) => {
                    if (!val) return;
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                    resultLinks.appendChild(div);
                });
                resultsCard.style.display = 'block';

                // –†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É
                const checklist = data.checklist || null;
                if (checklist && checklist.qa_text) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤ (—Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –Ω–∏–∂–µ —Å —Ä–∞—Å–∫—Ä—ã–≤–∞—à–∫–∞–º–∏)
                    setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                    
                    // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                    checklistItems = parseChecklistItems(checklist.qa_text);
                    renderChecklistItems();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                    if (checklist.overall) {
                        setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                    }
                    
                    checklistCard.style.display = 'block';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    lastTestData = {
                        transcript_text: data.transcript_text || '',
                        qa_text: checklist.qa_text || ''
                    };
                    analyzeBtn.style.display = 'inline-block';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ localStorage
                    saveResultsToStorage(data);
                } else {
                    checklistCaption.innerHTML = '';
                    checklistItemsList.innerHTML = '';
                    checklistOverall.innerHTML = '';
                    checklistCard.style.display = 'none';
                    lastTestData = null;
                    analyzeBtn.style.display = 'none';
                    checklistItems = [];
                    
                    // –û—á–∏—â–∞–µ–º localStorage –µ—Å–ª–∏ –Ω–µ—Ç —á–µ–∫-–ª–∏—Å—Ç–∞
                    localStorage.removeItem('checklistTestResults');
                }
            } catch (err) {
                statusText.textContent = '–°–±–æ–π –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.';
            }
        });

        async function analyzeChecklist() {
            if (!lastTestData || !lastTestData.transcript_text || !lastTestData.qa_text) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞.');
                return;
            }
            
            if (checklistItems.length === 0) {
                alert('–°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –ø—É—Å—Ç.');
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ...';
            analyzeStatus.style.display = 'inline';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                await loadChecklistPrompts();
                
                const resp = await fetch('/api/checklists/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        transcript_text: lastTestData.transcript_text,
                        qa_text: lastTestData.qa_text
                    })
                });
                
                const data = await resp.json();
                
                if (!resp.ok || !data.success) {
                    analyzeStatus.textContent = data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞.';
                    analyzeStatus.className = 'ms-2 text-danger';
                    analyzeBtn.disabled = false;
                    return;
                }
                
                analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω';
                analyzeStatus.className = 'ms-2 text-success';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                const explanations = data.explanations || {};
                checklistItems.forEach(item => {
                    const explDiv = document.getElementById(`expl-${item.num}`);
                    const toggleBtn = document.getElementById(`toggle-${item.num}`);
                    
                    if (explanations[item.num]) {
                        item.explanation = explanations[item.num];
                        renderExplanationWithRefinement(explDiv, item);
                        toggleBtn.style.display = 'inline-block';
                    }
                });
                
                analyzeBtn.disabled = false;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage
                saveAnalysisToStorage(explanations);
                
            } catch (err) {
                console.error(err);
                analyzeStatus.textContent = '–°–±–æ–π –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–Ω–∞–ª–∏–∑–∞.';
                analyzeStatus.className = 'ms-2 text-danger';
                analyzeBtn.disabled = false;
            }
        }

        async function loadChecklistPrompts() {
            try {
                const resp = await fetch('/api/script-prompt');
                const result = await resp.json();
                if (result.success && result.data) {
                    checklistPromptsData = result.data;
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞:', err);
            }
        }

        function renderExplanationWithRefinement(explDiv, item) {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
            explDiv.innerHTML = '';
            explDiv.style.whiteSpace = 'normal'; // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
            
            // –¢–µ–∫—Å—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
            const explanationText = document.createElement('div');
            explanationText.style.whiteSpace = 'pre-wrap';
            explanationText.style.marginBottom = '15px';
            explanationText.textContent = item.explanation;
            explDiv.appendChild(explanationText);
            
            // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
            const refinementSection = document.createElement('div');
            refinementSection.className = 'mt-3 pt-3 border-top';
            refinementSection.innerHTML = `
                <div class="small text-muted mb-2">
                    <i class="fas fa-magic me-1"></i>–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–º–ø—Ç —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —á–µ—Ä–µ–∑ AI
                </div>
                <div class="input-group input-group-sm">
                    <input type="text"
                           class="form-control form-control-sm"
                           id="refine-condition-${item.num}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ..."
                           style="font-size: 0.85rem;">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="refine-btn-${item.num}"
                            onclick="refineChecklistPromptFromAnalysis(${item.num})">
                        <i class="fas fa-sync-alt me-1"></i>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
                <div class="small text-muted mt-1">
                    –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç
                </div>
            `;
            explDiv.appendChild(refinementSection);
        }

        async function refineChecklistPromptFromAnalysis(itemNum) {
            const conditionInput = document.getElementById(`refine-condition-${itemNum}`);
            const refineBtn = document.getElementById(`refine-btn-${itemNum}`);
            
            if (!conditionInput || !refineBtn) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
                return;
            }
            
            const additionalCondition = (conditionInput.value || '').trim();
            if (!additionalCondition) {
                alert('–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ');
                conditionInput.focus();
                return;
            }
            
            if (!checklistPromptsData || !checklistPromptsData.checklist) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ–∫-–ª–∏—Å—Ç–∞');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–∏–Ω–¥–µ–∫—Å = –Ω–æ–º–µ—Ä - 1)
            const itemIndex = parseInt(itemNum) - 1;
            const checklistItem = checklistPromptsData.checklist[itemIndex];
            
            if (!checklistItem || !checklistItem.prompt) {
                alert('–ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const currentPrompt = checklistItem.prompt;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–æ–ø–∫–∏
            const originalContent = refineBtn.innerHTML;
            refineBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI...';
            refineBtn.disabled = true;
            
            try {
                const response = await fetch('/api/regenerate-checklist-item-prompt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_prompt: currentPrompt,
                        additional_condition: additionalCondition,
                        item_title: checklistItem.title || ''
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
                    alert(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success && result.prompt) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
                    checklistPromptsData.checklist[itemIndex].prompt = result.prompt;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç
                    const saveResp = await fetch('/api/script-prompt/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            data: checklistPromptsData
                        })
                    });
                    
                    const saveResult = await saveResp.json();
                    
                    if (saveResult.success) {
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —É—Å–ª–æ–≤–∏—è
                        conditionInput.value = '';
                        alert('‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç!\n\n–ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
                    } else {
                        alert('–ü—Ä–æ–º–ø—Ç –¥–æ—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (saveResult.message || '–û—à–∏–±–∫–∞'));
                    }
                } else {
                    alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                refineBtn.innerHTML = originalContent;
                refineBtn.disabled = false;
            }
        }

        function saveResultsToStorage(data) {
            try {
                const storageData = {
                    message: data.message || '',
                    paths: data.paths || {},
                    checklist: data.checklist || null,
                    transcript_text: data.transcript_text || '',
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('checklistTestResults', JSON.stringify(storageData));
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', err);
            }
        }

        function saveAnalysisToStorage(explanations) {
            try {
                localStorage.setItem('checklistAnalysisResults', JSON.stringify(explanations));
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage:', err);
            }
        }

        async function restoreAnalysisFromStorage() {
            try {
                const stored = localStorage.getItem('checklistAnalysisResults');
                if (!stored) return;
                
                const explanations = JSON.parse(stored);
                
                if (Object.keys(explanations).length === 0) {
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                await loadChecklistPrompts();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞
                checklistItems.forEach(item => {
                    const explDiv = document.getElementById(`expl-${item.num}`);
                    const toggleBtn = document.getElementById(`toggle-${item.num}`);
                    
                    if (explanations[item.num] && explDiv && toggleBtn) {
                        item.explanation = explanations[item.num];
                        renderExplanationWithRefinement(explDiv, item);
                        toggleBtn.style.display = 'inline-block';
                    }
                });
                
                analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∫—ç—à–∞';
                analyzeStatus.className = 'ms-2 text-success';
                analyzeStatus.style.display = 'inline';
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage:', err);
            }
        }

        async function restoreResultsFromStorage() {
            try {
                const stored = localStorage.getItem('checklistTestResults');
                if (!stored) return;
                
                const data = JSON.parse(stored);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º paths
                resultMessage.textContent = data.message || '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞.';
                resultLinks.innerHTML = '';
                const paths = data.paths || {};
                Object.entries(paths).forEach(([key, val]) => {
                    if (!val) return;
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                    resultLinks.appendChild(div);
                });
                resultsCard.style.display = 'block';
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫-–ª–∏—Å—Ç
                const checklist = data.checklist || null;
                if (checklist && checklist.qa_text) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤
                    setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                    
                    // –ü–∞—Ä—Å–∏–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                    checklistItems = parseChecklistItems(checklist.qa_text);
                    renderChecklistItems();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                    if (checklist.overall) {
                        setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                    }
                    
                    checklistCard.style.display = 'block';
                    
                    lastTestData = {
                        transcript_text: data.transcript_text || '',
                        qa_text: checklist.qa_text || ''
                    };
                    analyzeBtn.style.display = 'inline-block';
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                    await restoreAnalysisFromStorage();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ localStorage:', err);
            }
        }

        function clearResults() {
            // –û—á–∏—â–∞–µ–º localStorage
            localStorage.removeItem('checklistTestResults');
            localStorage.removeItem('checklistAnalysisResults');
            
            // –û—á–∏—â–∞–µ–º UI
            resultsCard.style.display = 'none';
            resultMessage.textContent = '';
            resultLinks.innerHTML = '';
            
            checklistCard.style.display = 'none';
            checklistCaption.innerHTML = '';
            checklistItemsList.innerHTML = '';
            checklistOverall.innerHTML = '';
            
            analyzeBtn.style.display = 'none';
            analyzeStatus.style.display = 'none';
            analyzeStatus.textContent = '';
            
            lastTestData = null;
            checklistItems = [];
            statusText.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã';
            setTimeout(() => { statusText.textContent = ''; }, 2000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadMeta();
            await restoreResultsFromStorage();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

