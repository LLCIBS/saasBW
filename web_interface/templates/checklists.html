<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤ - Call Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .stub-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stub-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 16px;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —è–∫–æ—Ä—è */
        .anchor-section-improved {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #667eea;
            animation: fadeIn 0.5s ease-in;
        }
        
        .anchor-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .anchor-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .anchor-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 10px;
            cursor: help;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .badge-improved {
            font-size: 1rem;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .badge-target {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .badge-non-target {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .result-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 1rem;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .result-box ul {
            list-style: none;
            padding-left: 0;
        }
        
        .result-box ul li {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .result-box ul li:before {
            content: "‚úì ";
            color: #27ae60;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .explanation-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            animation: slideDown 0.3s ease-in;
        }
        
        .explanation-box h6 {
            color: #2980b9;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .explanation-box p {
            color: #34495e;
            line-height: 1.8;
            margin-bottom: 10px;
        }
        
        .btn-analyze-improved {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        .btn-analyze-improved:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .refinement-section {
            background: #fff9e6;
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .refinement-title {
            color: #e67e22;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .refinement-description {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 0;
            list-style: none;
        }
        
        .progress-steps li {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .progress-steps li:before {
            content: attr(data-step);
            display: block;
            width: 40px;
            height: 40px;
            background: #ecf0f1;
            border-radius: 50%;
            line-height: 40px;
            margin: 0 auto 10px;
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .progress-steps li.completed:before {
            background: #27ae60;
            color: white;
            content: "‚úì";
        }
        
        .progress-steps li.active:before {
            background: #3498db;
            color: white;
        }
        
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .copy-button:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            {% include 'partials/sidebar.html' %}

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <main class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤</h1>
                            <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø—Ä–æ–≥–æ–Ω–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.</p>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="stub-card text-start">
                                <form id="checklistForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–§–∞–π–ª –∑–≤–æ–Ω–∫–∞</label>
                                        <input class="form-control" type="file" id="audioFile" name="file" accept=".mp3,.wav" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–°—Ç–∞–Ω—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                        <select class="form-select" id="stationSelect">
                                            <option value="">–ê–≤—Ç–æ (–∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">–§–∞–π–ª —á–µ–∫-–ª–∏—Å—Ç–∞</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="scriptPromptPath" readonly>
                                            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        </div>
                                        <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –ø—É—Ç—å.</div>
                                        <input type="text" class="form-control mt-2" id="scriptPromptOverride" placeholder="–ü—É—Ç—å –∫ –¥—Ä—É–≥–æ–º—É script_prompt_8.yaml (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <button type="submit" class="btn btn-save" id="runTestBtn">
                                            <i class="fas fa-play me-2"></i>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clearBtn" onclick="clearResults()">
                                            <i class="fas fa-eraser me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                                        </button>
                                        <div class="text-muted" id="statusText"></div>
                                    </div>
                                </form>
                            </div>

                            <div id="resultsCard" class="stub-card text-start" style="display:none;">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stub-icon me-3">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h5>
                                        <small class="text-muted" id="resultMessage"></small>
                                    </div>
                                </div>
                                <div id="resultLinks"></div>

                                <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —è–∫–æ—Ä—è - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
                                <div id="anchorSection" class="mt-4" style="display:none;">
                                    <div class="anchor-section-improved">
                                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º -->
                                        <div class="anchor-header">
                                            <div style="flex: 1;">
                                                <h5 class="anchor-title">
                                                    <i class="fas fa-phone-alt me-2"></i>üìû –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
                                                    <span class="info-tooltip">
                                                        <i class="fas fa-info-circle" style="font-size: 0.9rem; color: #3498db;"></i>
                                                        <span class="tooltip-text">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–≤–æ–Ω–æ–∫ —Ü–µ–ª–µ–≤—ã–º (–∫–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω) –∏–ª–∏ –Ω–µ—Ü–µ–ª–µ–≤—ã–º (–æ—à–∏–±–æ—á–Ω—ã–π –∑–≤–æ–Ω–æ–∫, —Å–ø–∞–º).</span>
                                                    </span>
                                                </h5>
                                                <p class="anchor-subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∑–≤–æ–Ω–∫–∞</p>
                                            </div>
                                            <div id="anchorTargetBadge"></div>
                                        </div>
                                        
                                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                                        <ul class="progress-steps" id="anchorProgressSteps">
                                            <li data-step="1" class="completed">
                                                <small>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</small>
                                            </li>
                                            <li data-step="2" class="completed">
                                                <small>–ê–Ω–∞–ª–∏–∑</small>
                                            </li>
                                            <li data-step="3" id="detailsStep">
                                                <small>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</small>
                                            </li>
                                        </ul>
                                        
                                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ -->
                                        <div class="result-box position-relative">
                                            <button class="copy-button" onclick="copyAnchorResult()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
                                                <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                            <h6 style="color: #2c3e50; margin-bottom: 15px; font-weight: 600;">
                                                üìù –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:
                                            </h6>
                                            <div id="anchorResult"></div>
                                        </div>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
                                        <div class="text-center my-3">
                                            <button type="button" class="btn-analyze-improved" id="analyzeAnchorBtn" onclick="analyzeAnchor()">
                                                <i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫
                                            </button>
                                            <div id="analyzeAnchorStatus" class="mt-2" style="display:none;"></div>
                                        </div>

                                        <!-- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
                                        <div id="anchorExplanation" class="explanation-box" style="display:none;">
                                            <h6><i class="fas fa-lightbulb me-2"></i>üí° –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</h6>
                                            <div id="anchorExplanationContent"></div>
                                        </div>

                                        <!-- –ë–ª–æ–∫ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —è–∫–æ—Ä—è -->
                                        <div id="anchorRefinementBlock" class="refinement-section" style="display:none;">
                                            <div class="refinement-title">
                                                <i class="fas fa-sliders-h me-2"></i>üéØ –•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏?
                                            </div>
                                            <p class="refinement-description">
                                                –û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –∑–≤–æ–Ω–∫–æ–≤. 
                                                –ù–∞–ø—Ä–∏–º–µ—Ä: "—É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" –∏–ª–∏ "–æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–æ–∫—É–ø–∫–µ".
                                            </p>
                                            <div class="input-group mb-3">
                                                <input type="text"
                                                       class="form-control"
                                                       id="anchorRefineInput"
                                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–¥–µ–ª–∫–µ..."
                                                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); regenerateAnchorPromptFromTest(); }">
                                                <button type="button"
                                                        class="btn btn-warning"
                                                        onclick="regenerateAnchorPromptFromTest()"
                                                        id="anchorRegenerateBtn">
                                                    <i class="fas fa-magic me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏
                                                </button>
                                            </div>
                                            
                                            <div id="newAnchorPromptPreview" class="alert alert-success" style="display:none;">
                                                <h6 class="alert-heading">‚úÖ –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –≥–æ—Ç–æ–≤—ã!</h6>
                                                <p class="small mb-2">–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:</p>
                                                <textarea class="form-control mb-2" id="newAnchorPromptText" rows="5" readonly style="background: white;"></textarea>
                                                <button type="button" class="btn btn-success me-2" onclick="saveNewAnchorFromTest()">
                                                    <i class="fas fa-check me-1"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                                </button>
                                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('newAnchorPromptPreview').style.display='none'">
                                                    <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="stub-card text-start" id="checklistCard" style="display:none;">
                                <h5 class="mb-3">–†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É</h5>
                                <div class="mb-2 text-muted" id="checklistCaption"></div>
                                
                                <!-- –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è -->
                                <div id="checklistItemsList"></div>
                                
                                <div class="mt-3" id="checklistOverall" style="white-space:pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;"></div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-primary" id="analyzeBtn" onclick="analyzeChecklist()">
                                        <i class="fas fa-search me-2"></i>–ê–Ω–∞–ª–∏–∑
                                    </button>
                                    <span class="ms-2 text-muted" id="analyzeStatus" style="display:none;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const stationSelect = document.getElementById('stationSelect');
        const scriptPromptPath = document.getElementById('scriptPromptPath');
        const scriptPromptOverride = document.getElementById('scriptPromptOverride');
        const statusText = document.getElementById('statusText');
        const resultsCard = document.getElementById('resultsCard');
        const resultMessage = document.getElementById('resultMessage');
        const resultLinks = document.getElementById('resultLinks');
        const formEl = document.getElementById('checklistForm');
        const checklistCard = document.getElementById('checklistCard');
        const checklistCaption = document.getElementById('checklistCaption');
        const checklistItemsList = document.getElementById('checklistItemsList');
        const checklistOverall = document.getElementById('checklistOverall');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeStatus = document.getElementById('analyzeStatus');
        
        const anchorSection = document.getElementById('anchorSection');
        const anchorResult = document.getElementById('anchorResult');
        const anchorTargetBadge = document.getElementById('anchorTargetBadge');
        const analyzeAnchorBtn = document.getElementById('analyzeAnchorBtn');
        const analyzeAnchorStatus = document.getElementById('analyzeAnchorStatus');
        const anchorExplanation = document.getElementById('anchorExplanation');
        const anchorRefinementBlock = document.getElementById('anchorRefinementBlock');
        const anchorRefineInput = document.getElementById('anchorRefineInput');
        const anchorRegenerateBtn = document.getElementById('anchorRegenerateBtn');
        const newAnchorPromptPreview = document.getElementById('newAnchorPromptPreview');
        const newAnchorPromptText = document.getElementById('newAnchorPromptText');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        let lastTestData = null;
        let lastAnchorData = null;
        let checklistItems = [];
        let checklistPromptsData = null; // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏

        function setHtmlWithNewlines(el, text) {
            if (!text) {
                el.innerHTML = '';
                return;
            }
            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º HTML-—Ç–µ–≥–∏ –∏–∑ Telegram (`<b>`, –∏ —Ç.–ø.) –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
            el.innerHTML = text.replace(/\n/g, '<br>');
        }

        function parseChecklistItems(qaText) {
            // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã –∏–∑ qa_text –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ ‚Äî –î–ê"
            const items = [];
            const lines = qaText.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç ‚Äî –î–ê/–ù–ï–¢"
                const match = line.match(/^(\d+)\.\s*(üü¢|üî¥)\s*(.+?)\s*‚Äî\s*(–î–ê|–ù–ï–¢)$/);
                if (match) {
                    items.push({
                        num: match[1],
                        icon: match[2],
                        text: match[3].trim(),
                        result: match[4],
                        explanation: '' // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
                    });
                }
            }
            
            return items;
        }

        function extractCaptionHeader(caption) {
            // –£–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –∏–∑ caption, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —à–∞–ø–∫—É
            if (!caption) return '';
            
            const lines = caption.split('\n');
            let headerLines = [];
            
            for (let line of lines) {
                line = line.trim();
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "1.", –∑–Ω–∞—á–∏—Ç –Ω–∞—á–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ - –ø—Ä–µ—Ä—ã–≤–∞–µ–º
                if (line.match(/^1\.\s*(üü¢|üî¥)/)) {
                    break;
                }
                headerLines.push(line);
            }
            
            return headerLines.join('\n').trim();
        }

        function renderChecklistItems() {
            checklistItemsList.innerHTML = '';
            
            checklistItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-2 border-bottom pb-2';
                itemDiv.style.fontFamily = "'Courier New', monospace";
                itemDiv.style.fontSize = '0.9rem';
                
                const mainLine = document.createElement('div');
                mainLine.innerHTML = `${item.num}. ${item.icon} ${item.text} ‚Äî <b>${item.result}</b>`;
                
                const explDiv = document.createElement('div');
                explDiv.id = `expl-${item.num}`;
                explDiv.className = 'mt-2 ps-3 border-start border-2 border-primary';
                explDiv.style.display = 'none';
                explDiv.style.whiteSpace = 'pre-wrap';
                explDiv.style.fontSize = '0.85rem';
                explDiv.style.color = '#666';
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-link text-decoration-none p-0 ms-2';
                toggleBtn.style.display = 'none'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
                toggleBtn.id = `toggle-${item.num}`;
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
                toggleBtn.onclick = () => {
                    const isHidden = explDiv.style.display === 'none';
                    explDiv.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.innerHTML = isHidden 
                        ? '<i class="fas fa-chevron-up"></i> –°–≤–µ—Ä–Ω—É—Ç—å'
                        : '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
                };
                
                mainLine.appendChild(toggleBtn);
                itemDiv.appendChild(mainLine);
                itemDiv.appendChild(explDiv);
                checklistItemsList.appendChild(itemDiv);
            });
        }

        async function loadMeta() {
            try {
                const resp = await fetch('/api/checklists/meta');
                const data = await resp.json();
                (data.stations || []).forEach(st => {
                    const opt = document.createElement('option');
                    opt.value = st.code;
                    opt.textContent = `${st.code} ‚Äî ${st.name}`;
                    stationSelect.appendChild(opt);
                });
                if (data.script_prompt_file) {
                    scriptPromptPath.value = data.script_prompt_file;
                }
            } catch (e) {
                statusText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
            }
        }

        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–º
            resultsCard.style.display = 'none';
            checklistCard.style.display = 'none';
            checklistItemsList.innerHTML = '';
            checklistOverall.innerHTML = '';
            analyzeStatus.style.display = 'none';
            analyzeStatus.textContent = '';
            lastTestData = null;
            checklistItems = [];
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage
            localStorage.removeItem('checklistAnalysisResults');
            
            statusText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞...';
            const file = document.getElementById('audioFile').files[0];
            if (!file) {
                statusText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            if (stationSelect.value) {
                formData.append('station_code', stationSelect.value);
            }
            if (scriptPromptOverride.value.trim()) {
                formData.append('script_prompt_file', scriptPromptOverride.value.trim());
            }

            try {
                const resp = await fetch('/api/checklists/test', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    statusText.textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.';
                    return;
                }
                statusText.textContent = '';
                resultMessage.textContent = data.message || '–ì–æ—Ç–æ–≤–æ.';
                resultLinks.innerHTML = '';
                const paths = data.paths || {};
                Object.entries(paths).forEach(([key, val]) => {
                    if (!val) return;
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                    resultLinks.appendChild(div);
                });
                resultsCard.style.display = 'block';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —è–∫–æ—Ä—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                const anchor = data.anchor || null;
                if (anchor) {
                    lastAnchorData = anchor;
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
                    const formattedResult = formatAnchorResult(anchor.analysis);
                    anchorResult.innerHTML = formattedResult;
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –±–µ–π–¥–∂–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
                    if (anchor.is_target) {
                        anchorTargetBadge.innerHTML = `
                            <span class="badge-improved badge-target">
                                <i class="fas fa-check-circle me-1"></i>‚úÖ –¶–µ–ª–µ–≤–æ–π –∑–≤–æ–Ω–æ–∫
                                <span class="info-tooltip">
                                    <i class="fas fa-info-circle ms-1" style="font-size: 0.9rem;"></i>
                                    <span class="tooltip-text">–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å –∫ —É—Å–ª—É–≥–µ, –≥–æ—Ç–æ–≤ –∫ –¥–∏–∞–ª–æ–≥—É –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø–æ–∫—É–ø–∫–µ</span>
                                </span>
                            </span>
                        `;
                    } else {
                        anchorTargetBadge.innerHTML = `
                            <span class="badge-improved badge-non-target">
                                <i class="fas fa-times-circle me-1"></i>‚ùå –ù–µ—Ü–µ–ª–µ–≤–æ–π –∑–≤–æ–Ω–æ–∫
                                <span class="info-tooltip">
                                    <i class="fas fa-info-circle ms-1" style="font-size: 0.9rem;"></i>
                                    <span class="tooltip-text">–û—à–∏–±–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä, —Å–ø–∞–º, –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –æ—Ç–∫–∞–∑ –æ—Ç —É—Å–ª—É–≥–∏</span>
                                </span>
                            </span>
                        `;
                    }
                    
                    anchorSection.style.display = 'block';
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    const explanationContent = document.getElementById('anchorExplanationContent');
                    if (explanationContent) explanationContent.innerHTML = '';
                    anchorExplanation.style.display = 'none';
                    anchorRefinementBlock.style.display = 'none';
                    newAnchorPromptPreview.style.display = 'none';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    const detailsStep = document.getElementById('detailsStep');
                    if (detailsStep) {
                        detailsStep.classList.remove('completed', 'active');
                    }
                } else {
                    anchorSection.style.display = 'none';
                    lastAnchorData = null;
                }

                // –†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É
                const checklist = data.checklist || null;
                if (checklist && checklist.qa_text) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤ (—Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –Ω–∏–∂–µ —Å —Ä–∞—Å–∫—Ä—ã–≤–∞—à–∫–∞–º–∏)
                    setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                    
                    // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                    checklistItems = parseChecklistItems(checklist.qa_text);
                    renderChecklistItems();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                    if (checklist.overall) {
                        setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                    }
                    
                    checklistCard.style.display = 'block';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    lastTestData = {
                        transcript_text: data.transcript_text || '',
                        qa_text: checklist.qa_text || ''
                    };
                    analyzeBtn.style.display = 'inline-block';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ localStorage
                    saveResultsToStorage(data);
                } else {
                    checklistCaption.innerHTML = '';
                    checklistItemsList.innerHTML = '';
                    checklistOverall.innerHTML = '';
                    checklistCard.style.display = 'none';
                    lastTestData = null;
                    analyzeBtn.style.display = 'none';
                    checklistItems = [];
                    
                    // –û—á–∏—â–∞–µ–º localStorage –µ—Å–ª–∏ –Ω–µ—Ç —á–µ–∫-–ª–∏—Å—Ç–∞
                    localStorage.removeItem('checklistTestResults');
                }
            } catch (err) {
                statusText.textContent = '–°–±–æ–π –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.';
            }
        });

        async function analyzeChecklist() {
            if (!lastTestData || !lastTestData.transcript_text || !lastTestData.qa_text) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞.');
                return;
            }
            
            if (checklistItems.length === 0) {
                alert('–°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –ø—É—Å—Ç.');
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ...';
            analyzeStatus.style.display = 'inline';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                await loadChecklistPrompts();
                
                const resp = await fetch('/api/checklists/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        transcript_text: lastTestData.transcript_text,
                        qa_text: lastTestData.qa_text
                    })
                });
                
                const data = await resp.json();
                
                if (!resp.ok || !data.success) {
                    analyzeStatus.textContent = data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞.';
                    analyzeStatus.className = 'ms-2 text-danger';
                    analyzeBtn.disabled = false;
                    return;
                }
                
                analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω';
                analyzeStatus.className = 'ms-2 text-success';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                const explanations = data.explanations || {};
                checklistItems.forEach(item => {
                    const explDiv = document.getElementById(`expl-${item.num}`);
                    const toggleBtn = document.getElementById(`toggle-${item.num}`);
                    
                    if (explanations[item.num]) {
                        item.explanation = explanations[item.num];
                        renderExplanationWithRefinement(explDiv, item);
                        toggleBtn.style.display = 'inline-block';
                    }
                });
                
                analyzeBtn.disabled = false;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage
                saveAnalysisToStorage(explanations);
                
            } catch (err) {
                console.error(err);
                analyzeStatus.textContent = '–°–±–æ–π –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–Ω–∞–ª–∏–∑–∞.';
                analyzeStatus.className = 'ms-2 text-danger';
                analyzeBtn.disabled = false;
            }
        }

        async function loadChecklistPrompts() {
            try {
                const resp = await fetch('/api/script-prompt');
                const result = await resp.json();
                if (result.success && result.data) {
                    checklistPromptsData = result.data;
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞:', err);
            }
        }

        function renderExplanationWithRefinement(explDiv, item) {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
            explDiv.innerHTML = '';
            explDiv.style.whiteSpace = 'normal'; // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
            
            // –¢–µ–∫—Å—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
            const explanationText = document.createElement('div');
            explanationText.style.whiteSpace = 'pre-wrap';
            explanationText.style.marginBottom = '15px';
            explanationText.textContent = item.explanation;
            explDiv.appendChild(explanationText);
            
            // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
            const refinementSection = document.createElement('div');
            refinementSection.className = 'mt-3 pt-3 border-top';
            refinementSection.innerHTML = `
                <div class="small text-muted mb-2">
                    <i class="fas fa-magic me-1"></i>–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–º–ø—Ç —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —á–µ—Ä–µ–∑ AI
                </div>
                <div class="input-group input-group-sm">
                    <input type="text"
                           class="form-control form-control-sm"
                           id="refine-condition-${item.num}"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ..."
                           style="font-size: 0.85rem;">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="refine-btn-${item.num}"
                            onclick="refineChecklistPromptFromAnalysis(${item.num})">
                        <i class="fas fa-sync-alt me-1"></i>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
                <div class="small text-muted mt-1">
                    –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç
                </div>
            `;
            explDiv.appendChild(refinementSection);
        }

        async function refineChecklistPromptFromAnalysis(itemNum) {
            const conditionInput = document.getElementById(`refine-condition-${itemNum}`);
            const refineBtn = document.getElementById(`refine-btn-${itemNum}`);
            
            if (!conditionInput || !refineBtn) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
                return;
            }
            
            const additionalCondition = (conditionInput.value || '').trim();
            if (!additionalCondition) {
                alert('–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ');
                conditionInput.focus();
                return;
            }
            
            if (!checklistPromptsData || !checklistPromptsData.checklist) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ–∫-–ª–∏—Å—Ç–∞');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–∏–Ω–¥–µ–∫—Å = –Ω–æ–º–µ—Ä - 1)
            const itemIndex = parseInt(itemNum) - 1;
            const checklistItem = checklistPromptsData.checklist[itemIndex];
            
            if (!checklistItem || !checklistItem.prompt) {
                alert('–ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const currentPrompt = checklistItem.prompt;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–æ–ø–∫–∏
            const originalContent = refineBtn.innerHTML;
            refineBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI...';
            refineBtn.disabled = true;
            
            try {
                const response = await fetch('/api/regenerate-checklist-item-prompt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_prompt: currentPrompt,
                        additional_condition: additionalCondition,
                        item_title: checklistItem.title || ''
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
                    alert(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success && result.prompt) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
                    checklistPromptsData.checklist[itemIndex].prompt = result.prompt;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç
                    const saveResp = await fetch('/api/script-prompt/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            data: checklistPromptsData
                        })
                    });
                    
                    const saveResult = await saveResp.json();
                    
                    if (saveResult.success) {
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —É—Å–ª–æ–≤–∏—è
                        conditionInput.value = '';
                        alert('‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç!\n\n–ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
                    } else {
                        alert('–ü—Ä–æ–º–ø—Ç –¥–æ—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (saveResult.message || '–û—à–∏–±–∫–∞'));
                    }
                } else {
                    alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                refineBtn.innerHTML = originalContent;
                refineBtn.disabled = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —è–∫–æ—Ä—è
        function formatAnchorResult(text) {
            if (!text) return '';
            
            // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
            const lines = text.split('\n').filter(line => line.trim());
            
            // –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ-–æ—Å–æ–±–æ–º—É
            if (text.includes('[') || text.includes('‚Ä¢')) {
                let formatted = '<ul style="list-style: none; padding-left: 0;">';
                lines.forEach(line => {
                    line = line.trim();
                    if (line) {
                        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
                        line = line.replace(/^[‚Ä¢\-\*]\s*/, '').replace(/^\d+\.\s*/, '');
                        formatted += `<li style="padding: 8px 0; border-bottom: 1px solid #ecf0f1;">‚úì ${line}</li>`;
                    }
                });
                formatted += '</ul>';
                return formatted;
            }
            
            // –û–±—ã—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
            return text.replace(/\n/g, '<br>');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function copyAnchorResult() {
            const resultText = anchorResult.innerText || anchorResult.textContent;
            navigator.clipboard.writeText(resultText).then(() => {
                const btn = event.target.closest('.copy-button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.style.background = '#d4edda';
                btn.style.color = '#155724';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç');
            });
        }
        
        async function analyzeAnchor() {
            if (!lastAnchorData || !lastTestData || !lastTestData.transcript_text) {
                alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.');
                return;
            }
            
            analyzeAnchorBtn.disabled = true;
            analyzeAnchorBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
            analyzeAnchorStatus.innerHTML = '<span class="text-info"><i class="fas fa-hourglass-half me-1"></i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä...</span>';
            analyzeAnchorStatus.style.display = 'block';
            
            try {
                const resp = await fetch('/api/anchors/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        transcript_text: lastTestData.transcript_text,
                        analysis_text: lastAnchorData.analysis,
                        prompt_text: lastAnchorData.prompt
                    })
                });
                
                const data = await resp.json();
                
                if (!resp.ok || !data.success) {
                    analyzeAnchorStatus.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞'}</span>`;
                    analyzeAnchorBtn.innerHTML = '<i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫';
                    analyzeAnchorBtn.disabled = false;
                    return;
                }
                
                analyzeAnchorStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>‚úÖ –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!</span>';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
                const formattedExplanation = formatExplanation(data.explanation);
                const explanationContent = document.getElementById('anchorExplanationContent');
                explanationContent.innerHTML = formattedExplanation;
                
                anchorExplanation.style.display = 'block';
                anchorRefinementBlock.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const detailsStep = document.getElementById('detailsStep');
                if (detailsStep) {
                    detailsStep.classList.add('completed');
                }
                
                analyzeAnchorBtn.innerHTML = '<i class="fas fa-check me-2"></i>‚úÖ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
                setTimeout(() => {
                    analyzeAnchorStatus.style.display = 'none';
                }, 3000);
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —è–∫–æ—Ä—è:', err);
                analyzeAnchorStatus.innerHTML = '<span class="text-danger"><i class="fas fa-wifi me-1"></i>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</span>';
                analyzeAnchorBtn.innerHTML = '<i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫';
                analyzeAnchorBtn.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
        function formatExplanation(text) {
            if (!text) return '';
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
            const paragraphs = text.split('\n\n');
            let formatted = '';
            
            paragraphs.forEach(para => {
                para = para.trim();
                if (!para) return;
                
                // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã, —ç—Ç–æ —Å–ø–∏—Å–æ–∫
                if (/^\d+\./.test(para)) {
                    const items = para.split(/\n(?=\d+\.)/);
                    formatted += '<ol style="line-height: 2;">';
                    items.forEach(item => {
                        item = item.replace(/^\d+\.\s*/, '');
                        formatted += `<li><strong>${item}</strong></li>`;
                    });
                    formatted += '</ol>';
                } else {
                    // –û–±—ã—á–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
                    formatted += `<p>${para}</p>`;
                }
            });
            
            return formatted;
        }

        async function regenerateAnchorPromptFromTest() {
            const refineInput = document.getElementById('anchorRefineInput');
            const condition = (refineInput.value || '').trim();
            if (!condition) {
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ –∑–≤–æ–Ω–∫–æ–≤.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: "—É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" –∏–ª–∏ "–æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ü–µ–Ω—É".');
                refineInput.focus();
                return;
            }

            if (!lastAnchorData || !lastAnchorData.prompt) {
                alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏.');
                return;
            }

            anchorRegenerateBtn.disabled = true;
            const originalContent = anchorRegenerateBtn.innerHTML;
            anchorRegenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';

            try {
                const response = await fetch('/api/regenerate-anchor-prompt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_prompt: lastAnchorData.prompt,
                        additional_condition: condition
                    })
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`);
                }

                const result = await response.json();

                if (result.success && result.prompt) {
                    newAnchorPromptText.value = result.prompt;
                    newAnchorPromptPreview.style.display = 'block';
                    refineInput.value = '';
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø—Ä–µ–≤—å—é
                    newAnchorPromptPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('‚ùå ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            } finally {
                anchorRegenerateBtn.innerHTML = originalContent;
                anchorRegenerateBtn.disabled = false;
            }
        }

        async function saveNewAnchorFromTest() {
            if (!lastAnchorData) return;
            
            const newPrompt = newAnchorPromptText.value.trim();
            if (!newPrompt) {
                alert('‚ö†Ô∏è –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.');
                return;
            }

            const confirmMessage = `üìã –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –∑–≤–æ–Ω–∫–æ–≤.\n\n` +
                                  `–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ –±—É–¥—É—â–∏–µ –∑–≤–æ–Ω–∫–∏ –±—É–¥—É—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å—Å—è –ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º.\n\n` +
                                  `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const saveBtn = event.target;
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
                saveBtn.disabled = true;
                
                // –ù–∞–º –Ω—É–∂–Ω—ã —Ç–µ–∫—É—â–∏–µ —è–∫–æ—Ä—è –∏ —Å—Ç–∞–Ω—Ü–∏–∏
                const respPrompts = await fetch('/api/prompts');
                let promptsData = await respPrompts.json();
                
                if (lastAnchorData.anchor_name) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —è–∫–æ—Ä—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                    promptsData.anchors[lastAnchorData.anchor_name] = newPrompt;
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–Ω—Ü–∏—é
                    promptsData.stations[lastAnchorData.station_code] = newPrompt;
                }

                const saveResp = await fetch('/api/prompts/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(promptsData)
                });

                const saveResult = await saveResp.json();

                if (saveResult.success) {
                    alert('‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n' +
                          'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏.');
                    newAnchorPromptPreview.style.display = 'none';
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    lastAnchorData.prompt = newPrompt;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (saveResult.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'));
                    saveBtn.innerHTML = originalBtnText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        function saveResultsToStorage(data) {
            try {
                const storageData = {
                    message: data.message || '',
                    paths: data.paths || {},
                    checklist: data.checklist || null,
                    transcript_text: data.transcript_text || '',
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('checklistTestResults', JSON.stringify(storageData));
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', err);
            }
        }

        function saveAnalysisToStorage(explanations) {
            try {
                localStorage.setItem('checklistAnalysisResults', JSON.stringify(explanations));
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage:', err);
            }
        }

        async function restoreAnalysisFromStorage() {
            try {
                const stored = localStorage.getItem('checklistAnalysisResults');
                if (!stored) return;
                
                const explanations = JSON.parse(stored);
                
                if (Object.keys(explanations).length === 0) {
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
                await loadChecklistPrompts();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞
                checklistItems.forEach(item => {
                    const explDiv = document.getElementById(`expl-${item.num}`);
                    const toggleBtn = document.getElementById(`toggle-${item.num}`);
                    
                    if (explanations[item.num] && explDiv && toggleBtn) {
                        item.explanation = explanations[item.num];
                        renderExplanationWithRefinement(explDiv, item);
                        toggleBtn.style.display = 'inline-block';
                    }
                });
                
                analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∫—ç—à–∞';
                analyzeStatus.className = 'ms-2 text-success';
                analyzeStatus.style.display = 'inline';
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage:', err);
            }
        }

        async function restoreResultsFromStorage() {
            try {
                const stored = localStorage.getItem('checklistTestResults');
                if (!stored) return;
                
                const data = JSON.parse(stored);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º paths
                resultMessage.textContent = data.message || '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞.';
                resultLinks.innerHTML = '';
                const paths = data.paths || {};
                Object.entries(paths).forEach(([key, val]) => {
                    if (!val) return;
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                    resultLinks.appendChild(div);
                });
                resultsCard.style.display = 'block';
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫-–ª–∏—Å—Ç
                const checklist = data.checklist || null;
                if (checklist && checklist.qa_text) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤
                    setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                    
                    // –ü–∞—Ä—Å–∏–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                    checklistItems = parseChecklistItems(checklist.qa_text);
                    renderChecklistItems();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                    if (checklist.overall) {
                        setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                    }
                    
                    checklistCard.style.display = 'block';
                    
                    lastTestData = {
                        transcript_text: data.transcript_text || '',
                        qa_text: checklist.qa_text || ''
                    };
                    analyzeBtn.style.display = 'inline-block';
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                    await restoreAnalysisFromStorage();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ localStorage:', err);
            }
        }

        function clearResults() {
            // –û—á–∏—â–∞–µ–º localStorage
            localStorage.removeItem('checklistTestResults');
            localStorage.removeItem('checklistAnalysisResults');
            
            // –û—á–∏—â–∞–µ–º UI
            resultsCard.style.display = 'none';
            resultMessage.textContent = '';
            resultLinks.innerHTML = '';
            
            checklistCard.style.display = 'none';
            checklistCaption.innerHTML = '';
            checklistItemsList.innerHTML = '';
            checklistOverall.innerHTML = '';
            
            analyzeBtn.style.display = 'none';
            analyzeStatus.style.display = 'none';
            analyzeStatus.textContent = '';
            
            lastTestData = null;
            checklistItems = [];
            statusText.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã';
            setTimeout(() => { statusText.textContent = ''; }, 2000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadMeta();
            await restoreResultsFromStorage();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

