{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤ - Call Analyzer{% endblock %}

{% block content %}
<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
{% include 'partials/sidebar.html' %}

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ–∫-–ª–∏—Å—Ç–æ–≤</h1>
                <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø—Ä–æ–≥–æ–Ω–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.</p>
            </div>
        </div>

        <div class="row g-4">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <form id="checklistForm">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">–§–∞–π–ª –∑–≤–æ–Ω–∫–∞</label>
                                <input class="form-control" type="file" id="audioFile" name="file" accept=".mp3,.wav" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">–°—Ç–∞–Ω—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <select class="form-select" id="stationSelect">
                                    <option value="">–ê–≤—Ç–æ (–∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">–§–∞–π–ª —á–µ–∫-–ª–∏—Å—Ç–∞</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="scriptPromptPath" readonly>
                                    <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                </div>
                                <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –ø—É—Ç—å.</div>
                                <input type="text" class="form-control mt-2" id="scriptPromptOverride" placeholder="–ü—É—Ç—å –∫ –¥—Ä—É–≥–æ–º—É script_prompt_8.yaml (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <button type="submit" class="btn btn-save" id="runTestBtn">
                                    <i class="fas fa-play me-2"></i>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="clearBtn" onclick="clearResults()">
                                    <i class="fas fa-eraser me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                                </button>
                                <div class="text-muted" id="statusText"></div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞ -->
                <div id="resultsCard" class="card mt-4" style="display:none;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h5>
                                <small class="text-muted" id="resultMessage"></small>
                            </div>
                        </div>
                        <div id="resultLinks"></div>

                        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —è–∫–æ—Ä—è -->
                        <div id="anchorSection" class="mt-4" style="display:none;">
                            <div class="config-section">
                                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º -->
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1">
                                        <h5 class="config-title mb-1">
                                            <i class="fas fa-phone-alt me-2"></i>üìû –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
                                            <i class="fas fa-info-circle text-info ms-2" 
                                               style="cursor: help; font-size: 0.9rem;" 
                                               title="–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–≤–æ–Ω–æ–∫ —Ü–µ–ª–µ–≤—ã–º (–∫–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω) –∏–ª–∏ –Ω–µ—Ü–µ–ª–µ–≤—ã–º (–æ—à–∏–±–æ—á–Ω—ã–π –∑–≤–æ–Ω–æ–∫, —Å–ø–∞–º)."></i>
                                        </h5>
                                        <p class="text-muted small mb-0">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∑–≤–æ–Ω–∫–∞</p>
                                    </div>
                                    <div id="anchorTargetBadge"></div>
                                </div>
                                
                                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                                <ul class="list-inline text-center mb-3" id="anchorProgressSteps">
                                    <li class="list-inline-item me-4">
                                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</span>
                                    </li>
                                    <li class="list-inline-item me-4">
                                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>–ê–Ω–∞–ª–∏–∑</span>
                                    </li>
                                    <li class="list-inline-item" id="detailsStep">
                                        <span class="badge bg-secondary">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</span>
                                    </li>
                                </ul>
                                
                                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ -->
                                <div class="card position-relative mb-3">
                                    <div class="card-body">
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                onclick="copyAnchorResult()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
                                            <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                        <h6 class="card-title mb-3">
                                            <i class="fas fa-clipboard-list me-2"></i>üìù –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:
                                        </h6>
                                        <div id="anchorResult"></div>
                                    </div>
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
                                <div class="text-center my-3">
                                    <button type="button" class="btn btn-primary" id="analyzeAnchorBtn" onclick="analyzeAnchor()">
                                        <i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫
                                    </button>
                                    <div id="analyzeAnchorStatus" class="mt-2" style="display:none;"></div>
                                </div>

                                <!-- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
                                <div id="anchorExplanation" class="alert alert-info" style="display:none;">
                                    <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>üí° –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</h6>
                                    <div id="anchorExplanationContent"></div>
                                </div>

                                <!-- –ë–ª–æ–∫ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —è–∫–æ—Ä—è -->
                                <div id="anchorRefinementBlock" class="card bg-light border-warning" style="display:none;">
                                    <div class="card-body">
                                        <h6 class="text-warning mb-2">
                                            <i class="fas fa-sliders-h me-2"></i>üéØ –•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏?
                                        </h6>
                                        <p class="text-muted small mb-3">
                                            –û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –∑–≤–æ–Ω–∫–æ–≤. 
                                            –ù–∞–ø—Ä–∏–º–µ—Ä: "—É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" –∏–ª–∏ "–æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–æ–∫—É–ø–∫–µ".
                                        </p>
                                        <div class="input-group mb-3">
                                            <input type="text"
                                                   class="form-control"
                                                   id="anchorRefineInput"
                                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–¥–µ–ª–∫–µ..."
                                                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); regenerateAnchorPromptFromTest(); }">
                                            <button type="button"
                                                    class="btn btn-warning"
                                                    onclick="regenerateAnchorPromptFromTest()"
                                                    id="anchorRegenerateBtn">
                                                <i class="fas fa-magic me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏
                                            </button>
                                        </div>
                                        
                                        <div id="newAnchorPromptPreview" class="alert alert-success" style="display:none;">
                                            <h6 class="alert-heading">‚úÖ –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –≥–æ—Ç–æ–≤—ã!</h6>
                                            <p class="small mb-2">–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:</p>
                                            <textarea class="form-control mb-2" id="newAnchorPromptText" rows="5" readonly style="background: white;"></textarea>
                                            <button type="button" class="btn btn-success me-2" onclick="saveNewAnchorFromTest()">
                                                <i class="fas fa-check me-1"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('newAnchorPromptPreview').style.display='none'">
                                                <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É -->
            <div class="col-lg-6">
                <div class="card" id="checklistCard" style="display:none;">
                    <div class="card-body">
                        <h5 class="card-title mb-3">–†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É</h5>
                        <div class="mb-2 text-muted" id="checklistCaption"></div>
                        
                        <!-- –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è -->
                        <div id="checklistItemsList"></div>
                        
                        <div class="mt-3" id="checklistOverall" style="white-space:pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;"></div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="analyzeBtn" onclick="analyzeChecklist()">
                                <i class="fas fa-search me-2"></i>–ê–Ω–∞–ª–∏–∑
                            </button>
                            <span class="ms-2 text-muted" id="analyzeStatus" style="display:none;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    const stationSelect = document.getElementById('stationSelect');
    const scriptPromptPath = document.getElementById('scriptPromptPath');
    const scriptPromptOverride = document.getElementById('scriptPromptOverride');
    const statusText = document.getElementById('statusText');
    const resultsCard = document.getElementById('resultsCard');
    const resultMessage = document.getElementById('resultMessage');
    const resultLinks = document.getElementById('resultLinks');
    const formEl = document.getElementById('checklistForm');
    const checklistCard = document.getElementById('checklistCard');
    const checklistCaption = document.getElementById('checklistCaption');
    const checklistItemsList = document.getElementById('checklistItemsList');
    const checklistOverall = document.getElementById('checklistOverall');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeStatus = document.getElementById('analyzeStatus');
    
    const anchorSection = document.getElementById('anchorSection');
    const anchorResult = document.getElementById('anchorResult');
    const anchorTargetBadge = document.getElementById('anchorTargetBadge');
    const analyzeAnchorBtn = document.getElementById('analyzeAnchorBtn');
    const analyzeAnchorStatus = document.getElementById('analyzeAnchorStatus');
    const anchorExplanation = document.getElementById('anchorExplanation');
    const anchorRefinementBlock = document.getElementById('anchorRefinementBlock');
    const anchorRefineInput = document.getElementById('anchorRefineInput');
    const anchorRegenerateBtn = document.getElementById('anchorRegenerateBtn');
    const newAnchorPromptPreview = document.getElementById('newAnchorPromptPreview');
    const newAnchorPromptText = document.getElementById('newAnchorPromptText');

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    let lastTestData = null;
    let lastAnchorData = null;
    let checklistItems = [];
    let checklistPromptsData = null; // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏

    function setHtmlWithNewlines(el, text) {
        if (!text) {
            el.innerHTML = '';
            return;
        }
        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º HTML-—Ç–µ–≥–∏ –∏–∑ Telegram (`<b>`, –∏ —Ç.–ø.) –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        el.innerHTML = text.replace(/\n/g, '<br>');
    }

    function parseChecklistItems(qaText) {
        // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã –∏–∑ qa_text –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞ ‚Äî –î–ê"
        const items = [];
        const lines = qaText.split('\n');
        
        for (let line of lines) {
            line = line.trim();
            // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "1. üü¢ —Ç–µ–∫—Å—Ç ‚Äî –î–ê/–ù–ï–¢"
            const match = line.match(/^(\d+)\.\s*(üü¢|üî¥)\s*(.+?)\s*‚Äî\s*(–î–ê|–ù–ï–¢)$/);
            if (match) {
                items.push({
                    num: match[1],
                    icon: match[2],
                    text: match[3].trim(),
                    result: match[4],
                    explanation: '' // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
                });
            }
        }
        
        return items;
    }

    function extractCaptionHeader(caption) {
        // –£–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –∏–∑ caption, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —à–∞–ø–∫—É
        if (!caption) return '';
        
        const lines = caption.split('\n');
        let headerLines = [];
        
        for (let line of lines) {
            line = line.trim();
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "1.", –∑–Ω–∞—á–∏—Ç –Ω–∞—á–∞–ª—Å—è —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ - –ø—Ä–µ—Ä—ã–≤–∞–µ–º
            if (line.match(/^1\.\s*(üü¢|üî¥)/)) {
                break;
            }
            headerLines.push(line);
        }
        
        return headerLines.join('\n').trim();
    }

    function renderChecklistItems() {
        checklistItemsList.innerHTML = '';
        
        checklistItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'mb-2 border-bottom pb-2';
            itemDiv.style.fontFamily = "'Courier New', monospace";
            itemDiv.style.fontSize = '0.9rem';
            
            const mainLine = document.createElement('div');
            mainLine.innerHTML = `${item.num}. ${item.icon} ${item.text} ‚Äî <b>${item.result}</b>`;
            
            const explDiv = document.createElement('div');
            explDiv.id = `expl-${item.num}`;
            explDiv.className = 'mt-2 ps-3 border-start border-2 border-primary';
            explDiv.style.display = 'none';
            explDiv.style.whiteSpace = 'pre-wrap';
            explDiv.style.fontSize = '0.85rem';
            explDiv.style.color = '#666';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn btn-sm btn-link text-decoration-none p-0 ms-2';
            toggleBtn.style.display = 'none'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞
            toggleBtn.id = `toggle-${item.num}`;
            toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
            toggleBtn.onclick = () => {
                const isHidden = explDiv.style.display === 'none';
                explDiv.style.display = isHidden ? 'block' : 'none';
                toggleBtn.innerHTML = isHidden 
                    ? '<i class="fas fa-chevron-up"></i> –°–≤–µ—Ä–Ω—É—Ç—å'
                    : '<i class="fas fa-chevron-down"></i> –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ';
            };
            
            mainLine.appendChild(toggleBtn);
            itemDiv.appendChild(mainLine);
            itemDiv.appendChild(explDiv);
            checklistItemsList.appendChild(itemDiv);
        });
    }

    async function loadMeta() {
        try {
            const resp = await fetch('/api/checklists/meta');
            const data = await resp.json();
            (data.stations || []).forEach(st => {
                const opt = document.createElement('option');
                opt.value = st.code;
                opt.textContent = `${st.code} ‚Äî ${st.name}`;
                stationSelect.appendChild(opt);
            });
            if (data.script_prompt_file) {
                scriptPromptPath.value = data.script_prompt_file;
            }
        } catch (e) {
            statusText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
        }
    }

    formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–º
        resultsCard.style.display = 'none';
        checklistCard.style.display = 'none';
        checklistItemsList.innerHTML = '';
        checklistOverall.innerHTML = '';
        analyzeStatus.style.display = 'none';
        analyzeStatus.textContent = '';
        lastTestData = null;
        checklistItems = [];
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage
        localStorage.removeItem('checklistAnalysisResults');
        
        statusText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞...';
        const file = document.getElementById('audioFile').files[0];
        if (!file) {
            statusText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        if (stationSelect.value) {
            formData.append('station_code', stationSelect.value);
        }
        if (scriptPromptOverride.value.trim()) {
            formData.append('script_prompt_file', scriptPromptOverride.value.trim());
        }

        try {
            const resp = await fetch('/api/checklists/test', {
                method: 'POST',
                body: formData
            });
            const data = await resp.json();
            if (!resp.ok || !data.success) {
                statusText.textContent = data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.';
                return;
            }
            statusText.textContent = '';
            resultMessage.textContent = data.message || '–ì–æ—Ç–æ–≤–æ.';
            resultLinks.innerHTML = '';
            const paths = data.paths || {};
            Object.entries(paths).forEach(([key, val]) => {
                if (!val) return;
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                resultLinks.appendChild(div);
            });
            resultsCard.style.display = 'block';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —è–∫–æ—Ä—è
            const anchor = data.anchor || null;
            if (anchor) {
                lastAnchorData = anchor;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
                const formattedResult = formatAnchorResult(anchor.analysis);
                anchorResult.innerHTML = formattedResult;
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–π–¥–∂–∞
                if (anchor.is_target) {
                    anchorTargetBadge.innerHTML = `
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-check-circle me-1"></i>‚úÖ –¶–µ–ª–µ–≤–æ–π –∑–≤–æ–Ω–æ–∫
                        </span>
                    `;
                } else {
                    anchorTargetBadge.innerHTML = `
                        <span class="badge bg-danger fs-6">
                            <i class="fas fa-times-circle me-1"></i>‚ùå –ù–µ—Ü–µ–ª–µ–≤–æ–π –∑–≤–æ–Ω–æ–∫
                        </span>
                    `;
                }
                
                anchorSection.style.display = 'block';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const explanationContent = document.getElementById('anchorExplanationContent');
                if (explanationContent) explanationContent.innerHTML = '';
                anchorExplanation.style.display = 'none';
                anchorRefinementBlock.style.display = 'none';
                newAnchorPromptPreview.style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const detailsStep = document.getElementById('detailsStep');
                if (detailsStep) {
                    detailsStep.classList.remove('bg-success');
                    detailsStep.classList.add('bg-secondary');
                }
            } else {
                anchorSection.style.display = 'none';
                lastAnchorData = null;
            }

            // –†–∞–∑–±–æ—Ä –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É
            const checklist = data.checklist || null;
            if (checklist && checklist.qa_text) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤
                setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                
                // –ü–∞—Ä—Å–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                checklistItems = parseChecklistItems(checklist.qa_text);
                renderChecklistItems();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                if (checklist.overall) {
                    setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                }
                
                checklistCard.style.display = 'block';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                lastTestData = {
                    transcript_text: data.transcript_text || '',
                    qa_text: checklist.qa_text || ''
                };
                analyzeBtn.style.display = 'inline-block';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ localStorage
                saveResultsToStorage(data);
            } else {
                checklistCaption.innerHTML = '';
                checklistItemsList.innerHTML = '';
                checklistOverall.innerHTML = '';
                checklistCard.style.display = 'none';
                lastTestData = null;
                analyzeBtn.style.display = 'none';
                checklistItems = [];
                
                // –û—á–∏—â–∞–µ–º localStorage –µ—Å–ª–∏ –Ω–µ—Ç —á–µ–∫-–ª–∏—Å—Ç–∞
                localStorage.removeItem('checklistTestResults');
            }
        } catch (err) {
            statusText.textContent = '–°–±–æ–π –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.';
        }
    });

    async function analyzeChecklist() {
        if (!lastTestData || !lastTestData.transcript_text || !lastTestData.qa_text) {
            showAlert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞.', 'warning');
            return;
        }
        
        if (checklistItems.length === 0) {
            showAlert('‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞ –ø—É—Å—Ç.', 'warning');
            return;
        }
        
        analyzeBtn.disabled = true;
        analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ...';
        analyzeStatus.style.display = 'inline';
        
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
            await loadChecklistPrompts();
            
            const resp = await fetch('/api/checklists/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transcript_text: lastTestData.transcript_text,
                    qa_text: lastTestData.qa_text
                })
            });
            
            const data = await resp.json();
            
            if (!resp.ok || !data.success) {
                analyzeStatus.textContent = data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞.';
                analyzeStatus.className = 'ms-2 text-danger';
                analyzeBtn.disabled = false;
                return;
            }
            
            analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω';
            analyzeStatus.className = 'ms-2 text-success';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–æ—Ä–∞–±–æ—Ç–∫–∏
            const explanations = data.explanations || {};
            checklistItems.forEach(item => {
                const explDiv = document.getElementById(`expl-${item.num}`);
                const toggleBtn = document.getElementById(`toggle-${item.num}`);
                
                if (explanations[item.num]) {
                    item.explanation = explanations[item.num];
                    renderExplanationWithRefinement(explDiv, item);
                    toggleBtn.style.display = 'inline-block';
                }
            });
            
            analyzeBtn.disabled = false;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage
            saveAnalysisToStorage(explanations);
            
        } catch (err) {
            console.error(err);
            analyzeStatus.textContent = '–°–±–æ–π –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∞–Ω–∞–ª–∏–∑–∞.';
            analyzeStatus.className = 'ms-2 text-danger';
            analyzeBtn.disabled = false;
        }
    }

    async function loadChecklistPrompts() {
        try {
            const scriptPromptPathValue = scriptPromptPath.value || '';
            const url = scriptPromptPathValue 
                ? `/api/script-prompt?file_path=${encodeURIComponent(scriptPromptPathValue)}`
                : '/api/script-prompt';
                
            const resp = await fetch(url);
            const result = await resp.json();
            if (result.success && result.data) {
                checklistPromptsData = result.data;
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞:', err);
        }
    }

    function renderExplanationWithRefinement(explDiv, item) {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
        explDiv.innerHTML = '';
        explDiv.style.whiteSpace = 'normal'; // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
        
        // –¢–µ–∫—Å—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è
        const explanationText = document.createElement('div');
        explanationText.style.whiteSpace = 'pre-wrap';
        explanationText.style.marginBottom = '15px';
        explanationText.textContent = item.explanation;
        explDiv.appendChild(explanationText);
        
        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
        const refinementSection = document.createElement('div');
        refinementSection.className = 'mt-3 pt-3 border-top';
        refinementSection.innerHTML = `
            <div class="small text-muted mb-2">
                <i class="fas fa-magic me-1"></i>–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–º–ø—Ç —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —á–µ—Ä–µ–∑ AI
            </div>
            <div class="input-group input-group-sm">
                <input type="text"
                       class="form-control form-control-sm"
                       id="refine-condition-${item.num}"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ..."
                       style="font-size: 0.85rem;">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        id="refine-btn-${item.num}"
                        onclick="refineChecklistPromptFromAnalysis(${item.num})">
                    <i class="fas fa-sync-alt me-1"></i>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            <div class="small text-muted mt-1">
                –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç
            </div>
        `;
        explDiv.appendChild(refinementSection);
    }

    async function refineChecklistPromptFromAnalysis(itemNum) {
        const conditionInput = document.getElementById(`refine-condition-${itemNum}`);
        const refineBtn = document.getElementById(`refine-btn-${itemNum}`);
        
        if (!conditionInput || !refineBtn) {
            showAlert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞', 'danger');
            return;
        }
        
        const additionalCondition = (conditionInput.value || '').trim();
        if (!additionalCondition) {
            showAlert('–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ', 'warning');
            conditionInput.focus();
            return;
        }
        
        if (!checklistPromptsData || !checklistPromptsData.checklist) {
            showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ–∫-–ª–∏—Å—Ç–∞', 'danger');
            return;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–∏–Ω–¥–µ–∫—Å = –Ω–æ–º–µ—Ä - 1)
        const itemIndex = parseInt(itemNum) - 1;
        const checklistItem = checklistPromptsData.checklist[itemIndex];
        
        if (!checklistItem || !checklistItem.prompt) {
            showAlert('–ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
            return;
        }
        
        const currentPrompt = checklistItem.prompt;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–æ–ø–∫–∏
        const originalContent = refineBtn.innerHTML;
        refineBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI...';
        refineBtn.disabled = true;
        
        try {
            const response = await fetch('/api/regenerate-checklist-item-prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    current_prompt: currentPrompt,
                    additional_condition: additionalCondition,
                    item_title: checklistItem.title || ''
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
                showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`, 'danger');
                return;
            }
            
            const result = await response.json();
            
            if (result.success && result.prompt) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
                checklistPromptsData.checklist[itemIndex].prompt = result.prompt;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç
                const scriptPromptPathValue = scriptPromptPath.value || '';
                const saveResp = await fetch('/api/script-prompt/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        data: checklistPromptsData,
                        file_path: scriptPromptPathValue
                    })
                });
                
                const saveResult = await saveResp.json();
                
                if (saveResult.success) {
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —É—Å–ª–æ–≤–∏—è
                    conditionInput.value = '';
                    showAlert('‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —á–µ–∫-–ª–∏—Å—Ç!<br><br>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.', 'success');
                } else {
                    showAlert('–ü—Ä–æ–º–ø—Ç –¥–æ—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (saveResult.message || '–û—à–∏–±–∫–∞'), 'warning');
                }
            } else {
                showAlert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞', 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–º–ø—Ç–∞:', error);
            showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'danger');
        } finally {
            refineBtn.innerHTML = originalContent;
            refineBtn.disabled = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —è–∫–æ—Ä—è
    function formatAnchorResult(text) {
        if (!text) return '';
        
        // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
        const lines = text.split('\n').filter(line => line.trim());
        
        // –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ-–æ—Å–æ–±–æ–º—É
        if (text.includes('[') || text.includes('‚Ä¢')) {
            let formatted = '<ul style="list-style: none; padding-left: 0;">';
            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
                    line = line.replace(/^[‚Ä¢\-\*]\s*/, '').replace(/^\d+\.\s*/, '');
                    formatted += `<li style="padding: 8px 0; border-bottom: 1px solid #ecf0f1;">‚úì ${line}</li>`;
                }
            });
            formatted += '</ul>';
            return formatted;
        }
        
        // –û–±—ã—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
        return text.replace(/\n/g, '<br>');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    function copyAnchorResult() {
        const resultText = anchorResult.innerText || anchorResult.textContent;
        navigator.clipboard.writeText(resultText).then(() => {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç', 'danger');
        });
    }

    async function analyzeAnchor() {
        if (!lastAnchorData || !lastTestData || !lastTestData.transcript_text) {
            showAlert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.', 'warning');
            return;
        }
        
        analyzeAnchorBtn.disabled = true;
        analyzeAnchorBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
        analyzeAnchorStatus.innerHTML = '<span class="text-info"><i class="fas fa-hourglass-half me-1"></i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä...</span>';
        analyzeAnchorStatus.style.display = 'block';
        
        try {
            const resp = await fetch('/api/anchors/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transcript_text: lastTestData.transcript_text,
                    analysis_text: lastAnchorData.analysis,
                    prompt_text: lastAnchorData.prompt
                })
            });
            
            const data = await resp.json();
            
            if (!resp.ok || !data.success) {
                analyzeAnchorStatus.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${data.message || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞'}</span>`;
                analyzeAnchorBtn.innerHTML = '<i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫';
                analyzeAnchorBtn.disabled = false;
                return;
            }
            
            analyzeAnchorStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>‚úÖ –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!</span>';
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
            const formattedExplanation = formatExplanation(data.explanation);
            const explanationContent = document.getElementById('anchorExplanationContent');
            explanationContent.innerHTML = formattedExplanation;
            
            anchorExplanation.style.display = 'block';
            anchorRefinementBlock.style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const detailsStep = document.getElementById('detailsStep');
            if (detailsStep) {
                detailsStep.classList.remove('bg-secondary');
                detailsStep.classList.add('bg-success');
            }
            
            analyzeAnchorBtn.innerHTML = '<i class="fas fa-check me-2"></i>‚úÖ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ';
            setTimeout(() => {
                analyzeAnchorStatus.style.display = 'none';
            }, 3000);
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —è–∫–æ—Ä—è:', err);
            analyzeAnchorStatus.innerHTML = '<span class="text-danger"><i class="fas fa-wifi me-1"></i>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</span>';
            analyzeAnchorBtn.innerHTML = '<i class="fas fa-search-plus me-2"></i>üîç –£–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∑–≤–æ–Ω–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫';
            analyzeAnchorBtn.disabled = false;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
    function formatExplanation(text) {
        if (!text) return '';
        
        // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
        const paragraphs = text.split('\n\n');
        let formatted = '';
        
        paragraphs.forEach(para => {
            para = para.trim();
            if (!para) return;
            
            // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã, —ç—Ç–æ —Å–ø–∏—Å–æ–∫
            if (/^\d+\./.test(para)) {
                const items = para.split(/\n(?=\d+\.)/);
                formatted += '<ol style="line-height: 2;">';
                items.forEach(item => {
                    item = item.replace(/^\d+\.\s*/, '');
                    formatted += `<li><strong>${item}</strong></li>`;
                });
                formatted += '</ol>';
            } else {
                // –û–±—ã—á–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
                formatted += `<p>${para}</p>`;
            }
        });
        
        return formatted;
    }

    async function regenerateAnchorPromptFromTest() {
        const refineInput = document.getElementById('anchorRefineInput');
        const condition = (refineInput.value || '').trim();
        if (!condition) {
            showAlert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ –∑–≤–æ–Ω–æ–∫.<br><br>–ù–∞–ø—Ä–∏–º–µ—Ä: "—É—á–∏—Ç—ã–≤–∞—Ç—å –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" –∏–ª–∏ "–æ–±—Ä–∞—â–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ü–µ–Ω—É".', 'warning');
            refineInput.focus();
            return;
        }

        if (!lastAnchorData || !lastAnchorData.prompt) {
            showAlert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–≤–æ–Ω–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏.', 'warning');
            return;
        }

        anchorRegenerateBtn.disabled = true;
        const originalContent = anchorRegenerateBtn.innerHTML;
        anchorRegenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';

        try {
            const response = await fetch('/api/regenerate-anchor-prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    current_prompt: lastAnchorData.prompt,
                    additional_condition: condition
                })
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`);
            }

            const result = await response.json();

            if (result.success && result.prompt) {
                newAnchorPromptText.value = result.prompt;
                newAnchorPromptPreview.style.display = 'block';
                refineInput.value = '';
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø—Ä–µ–≤—å—é
                newAnchorPromptPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                showAlert('‚ùå ' + (result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'), 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:', error);
            showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message + '<br><br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
        } finally {
            anchorRegenerateBtn.innerHTML = originalContent;
            anchorRegenerateBtn.disabled = false;
        }
    }

    async function saveNewAnchorFromTest() {
        if (!lastAnchorData) return;
        
        const newPrompt = newAnchorPromptText.value.trim();
        if (!newPrompt) {
            showAlert('‚ö†Ô∏è –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.', 'warning');
            return;
        }

        const confirmMessage = `üìã –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ –∑–≤–æ–Ω–æ–∫.<br><br>` +
                              `–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ –±—É–¥—É—â–∏–µ –∑–≤–æ–Ω–∫–∏ –±—É–¥—É—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å—Å—è –ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º.<br><br>` +
                              `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
        
        if (!confirm(confirmMessage.replace(/<br>/g, '\n'))) {
            return;
        }

        try {
            // –ù–∞–º –Ω—É–∂–Ω—ã —Ç–µ–∫—É—â–∏–µ —è–∫–æ—Ä—è –∏ —Å—Ç–∞–Ω—Ü–∏–∏
            const respPrompts = await fetch('/api/prompts');
            let promptsData = await respPrompts.json();
            
            if (lastAnchorData.anchor_name) {
                // –ï—Å–ª–∏ —ç—Ç–æ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —è–∫–æ—Ä—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                promptsData.anchors[lastAnchorData.anchor_name] = newPrompt;
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–Ω—Ü–∏—é
                promptsData.stations[lastAnchorData.station_code] = newPrompt;
            }

            const saveResp = await fetch('/api/prompts/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(promptsData)
            });

            const saveResult = await saveResp.json();

            if (saveResult.success) {
                showAlert('‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ù–æ–≤—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!<br><br>' +
                      'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏.', 'success');
                newAnchorPromptPreview.style.display = 'none';
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                lastAnchorData.prompt = newPrompt;
            } else {
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (saveResult.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'), 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:', error);
            showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.<br><br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
        }
    }

    function saveResultsToStorage(data) {
        try {
            const storageData = {
                message: data.message || '',
                paths: data.paths || {},
                checklist: data.checklist || null,
                transcript_text: data.transcript_text || '',
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('checklistTestResults', JSON.stringify(storageData));
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', err);
        }
    }

    function saveAnalysisToStorage(explanations) {
        try {
            localStorage.setItem('checklistAnalysisResults', JSON.stringify(explanations));
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤ localStorage:', err);
        }
    }

    async function restoreAnalysisFromStorage() {
        try {
            const stored = localStorage.getItem('checklistAnalysisResults');
            if (!stored) return;
            
            const explanations = JSON.parse(stored);
            
            if (Object.keys(explanations).length === 0) {
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
            await loadChecklistPrompts();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö —á–µ–∫-–ª–∏—Å—Ç–∞
            checklistItems.forEach(item => {
                const explDiv = document.getElementById(`expl-${item.num}`);
                const toggleBtn = document.getElementById(`toggle-${item.num}`);
                
                if (explanations[item.num] && explDiv && toggleBtn) {
                    item.explanation = explanations[item.num];
                    renderExplanationWithRefinement(explDiv, item);
                    toggleBtn.style.display = 'inline-block';
                }
            });
            
            analyzeStatus.textContent = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∫—ç—à–∞';
            analyzeStatus.className = 'ms-2 text-success';
            analyzeStatus.style.display = 'inline';
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ localStorage:', err);
        }
    }

    async function restoreResultsFromStorage() {
        try {
            const stored = localStorage.getItem('checklistTestResults');
            if (!stored) return;
            
            const data = JSON.parse(stored);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º paths
            resultMessage.textContent = data.message || '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞.';
            resultLinks.innerHTML = '';
            const paths = data.paths || {};
            Object.entries(paths).forEach(([key, val]) => {
                if (!val) return;
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `<strong>${key}:</strong> <code>${val}</code>`;
                resultLinks.appendChild(div);
            });
            resultsCard.style.display = 'block';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫-–ª–∏—Å—Ç
            const checklist = data.checklist || null;
            if (checklist && checklist.qa_text) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤
                setHtmlWithNewlines(checklistCaption, extractCaptionHeader(checklist.caption || ''));
                
                // –ü–∞—Ä—Å–∏–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
                checklistItems = parseChecklistItems(checklist.qa_text);
                renderChecklistItems();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
                if (checklist.overall) {
                    setHtmlWithNewlines(checklistOverall, checklist.overall.trim());
                }
                
                checklistCard.style.display = 'block';
                
                lastTestData = {
                    transcript_text: data.transcript_text || '',
                    qa_text: checklist.qa_text || ''
                };
                analyzeBtn.style.display = 'inline-block';
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                await restoreAnalysisFromStorage();
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ localStorage:', err);
        }
    }

    function clearResults() {
        resultsCard.style.display = 'none';
        checklistCard.style.display = 'none';
        checklistItemsList.innerHTML = '';
        checklistOverall.innerHTML = '';
        checklistCaption.innerHTML = '';
        analyzeStatus.style.display = 'none';
        analyzeStatus.textContent = '';
        lastTestData = null;
        checklistItems = [];
        lastAnchorData = null;
        
        // –û—á–∏—â–∞–µ–º localStorage
        localStorage.removeItem('checklistTestResults');
        localStorage.removeItem('checklistAnalysisResults');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        formEl.reset();
        
        showAlert('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async () => {
        await loadMeta();
        await restoreResultsFromStorage();
    });
</script>
{% endblock %}
