{% extends "base.html" %}

{% block title %}Управление промптами - Call Analyzer{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 gap-3">
            <div>
                <h1 class="h3 mb-0">Управление промптами</h1>
                <p class="text-muted mb-0">Настройка AI промптов для анализа звонков</p>
            </div>
            <div>
                <button class="btn btn-save" onclick="savePrompts()">
                    <i class="fas fa-save me-2"></i>Сохранить промпты
                </button>
            </div>
        </div>

        <!-- Якоря промптов -->
        <div class="config-section">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <h3 class="config-title mb-0 flex-grow-1">
                    <i class="fas fa-anchor me-2"></i>Шаблоны промптов (якоря)
                </h3>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#anchorModal" onclick="resetAnchorModal()">
                    <i class="fas fa-plus me-1"></i>Добавить якорь
                </button>
            </div>
            <div id="anchorsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Загрузка промптов...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Промпты для станций -->
        <div class="config-section">
            <h3 class="config-title">
                <i class="fas fa-comments me-2"></i>Промпты для анализа звонков по станциям
            </h3>
            <div id="stationPromptsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Загрузка промптов...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Промпт по умолчанию -->
        <div class="config-section">
            <h3 class="config-title">
                <i class="fas fa-cog me-2"></i>Промпт по умолчанию
            </h3>
            <div class="mb-3">
                <label class="form-label">Промпт для станций без специального промпта</label>
                <textarea class="form-control prompt-textarea" id="defaultPrompt" 
                          placeholder="Введите промпт по умолчанию..." style="min-height: 150px; font-family: 'Courier New', monospace; font-size: 0.9rem;"></textarea>
            </div>
        </div>
    </div>
</main>

<!-- Модалка для добавления якоря -->
<div class="modal fade" id="anchorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form id="anchorForm" onsubmit="createAnchor(event)">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-anchor me-2"></i>Новый якорь промпта</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newAnchorName" class="form-label">Название якоря</label>
                        <input type="text" class="form-control" id="newAnchorName" placeholder="Например, Общий скрипт" required>
                    </div>
                    <div class="mb-3">
                        <label for="newAnchorPrompt" class="form-label">Текст промпта (или описание задачи для генерации)</label>
                        <textarea class="form-control prompt-textarea" id="newAnchorPrompt" placeholder="Введите текст промпта или опишите задачу (например: Хочу искать звонки с первичными обращениями клиента...)" required style="min-height: 200px; font-family: 'Courier New', monospace; font-size: 0.9rem;"></textarea>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="generateAnchorPrompt()">
                                <i class="fas fa-magic me-2"></i>Сгенерировать промпт из описания
                            </button>
                        </div>
                    </div>
                    <div class="text-muted small">
                        Якорь можно будет выбрать для любой станции или использовать как шаблон для кастомного текста.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let promptsData = { anchors: {}, stations: {}, "default": '' };
let scriptPromptData = { checklist: [], prompt: '' };

function ensurePromptsStructure() {
    if (!promptsData || typeof promptsData !== 'object') {
        promptsData = { anchors: {}, stations: {}, default: '' };
        return;
    }
    if (!promptsData.anchors || typeof promptsData.anchors !== 'object') {
        promptsData.anchors = {};
    }
    if (!promptsData.stations || typeof promptsData.stations !== 'object') {
        promptsData.stations = {};
    }
    if (typeof promptsData.default !== 'string') {
        promptsData.default = promptsData.default ? String(promptsData.default) : '';
    }
}

function escapeHtml(str = '') {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/`/g, '&#96;');
}

function decodeKey(value) {
    try {
        return decodeURIComponent(value);
    } catch {
        return value;
    }
}

// Загрузка промптов при старте
document.addEventListener('DOMContentLoaded', function() {
    loadPrompts();
});

async function loadPrompts() {
    try {
        const response = await fetch('/api/prompts');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        promptsData = data || { anchors: {}, stations: {}, default: '' };
        ensurePromptsStructure();
        renderPrompts();
    } catch (error) {
        console.error('Ошибка загрузки промптов:', error);
        let msg = error.message;
        if (msg.includes('Unexpected token')) {
            msg = 'Ошибка сервера (получен некорректный ответ). Проверьте логи.';
        }
        showAlert('Ошибка загрузки промптов: ' + msg, 'danger');
    }
}

function renderPrompts() {
    ensurePromptsStructure();
    // Заполняем промпт по умолчанию
    document.getElementById('defaultPrompt').value = promptsData.default || '';
    
    // Рендерим якоря
    renderAnchors();
    
    // Рендерим станции
    renderStations();
}

function renderAnchors() {
    ensurePromptsStructure();
    const container = document.getElementById('anchorsContainer');
    if (!container) {
        return;
    }
    const anchors = promptsData.anchors || {};
    const anchorNames = Object.keys(anchors);

    if (anchorNames.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">Якоря пока не созданы</div>';
        return;
    }

    const anchorsHtml = anchorNames.map(anchorName => {
        const encodedName = encodeURIComponent(anchorName);
        const anchorPrompt = anchors[anchorName] || '';
        return `
            <div class="anchor-section" data-anchor="${encodedName}" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                <div class="d-flex flex-column flex-md-row gap-3 mb-3">
                    <div class="flex-grow-1">
                        <label class="form-label text-muted small mb-1">Название якоря</label>
                        <input type="text"
                               class="form-control"
                               value="${escapeHtml(anchorName)}"
                               onchange="renameAnchor('${encodedName}', this.value.trim())"
                               placeholder="Название якоря">
                    </div>
                    <div class="text-end">
                        <label class="form-label text-muted small mb-1 d-block">Действие</label>
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="removeAnchor('${encodedName}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <label class="form-label text-muted small mb-1">Текст промпта</label>
                <textarea class="form-control prompt-textarea"
                          id="anchor-prompt-${encodedName}"
                          oninput="updateAnchorPrompt('${encodedName}', this.value)"
                          placeholder="Введите промпт для якоря..." style="min-height: 200px; font-family: 'Courier New', monospace; font-size: 0.9rem;">${escapeHtml(anchorPrompt)}</textarea>
                <div class="mt-3">
                    <label class="form-label text-muted small mb-1">
                        <i class="fas fa-magic me-1"></i>Доработать промпт через AI
                    </label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="additional-condition-${encodedName}"
                               placeholder="Введите дополнительное условие или требование (например: добавить проверку на вежливость)..."
                               onkeypress="if(event.key === 'Enter') { event.preventDefault(); regenerateAnchorPrompt('${encodedName}'); }">
                        <button type="button"
                                class="btn btn-outline-primary"
                                onclick="regenerateAnchorPrompt('${encodedName}')"
                                id="regenerate-btn-${encodedName}">
                            <i class="fas fa-sync-alt me-1"></i>Перегенерировать
                        </button>
                    </div>
                    <small class="text-muted">Введите новое условие и нажмите "Перегенерировать" для доработки промпта через AI</small>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = anchorsHtml;
}

function resetAnchorModal() {
    const form = document.getElementById('anchorForm');
    if (form) {
        form.reset();
    }
}

async function generateAnchorPrompt() {
    const promptInput = document.getElementById('newAnchorPrompt');
    const intent = (promptInput?.value || '').trim();

    if (!intent) {
        showAlert('Введите описание задачи в поле промпта', 'warning');
        return;
    }

    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Генерация...';
    button.disabled = true;

    try {
        const response = await fetch('/api/generate-anchor-prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                intent: intent
            })
        });

        const result = await response.json();

        if (result.success) {
            promptInput.value = result.prompt;
            showAlert('Промпт успешно сгенерирован!', 'success');
        } else {
            showAlert('Ошибка генерации: ' + (result.message || 'Неизвестная ошибка'), 'danger');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showAlert('Ошибка соединения: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

function createAnchor(event) {
    event.preventDefault();
    ensurePromptsStructure();
    const form = event.target;
    const nameInput = document.getElementById('newAnchorName');
    const promptInput = document.getElementById('newAnchorPrompt');
    const name = (nameInput?.value || '').trim();
    const prompt = promptInput?.value || '';

    if (!name) {
        showAlert('Введите название якоря', 'warning');
        return;
    }
    if (promptsData.anchors[name]) {
        showAlert('Якорь с таким названием уже существует', 'warning');
        return;
    }

    promptsData.anchors[name] = prompt;

    const modalElement = document.getElementById('anchorModal');
    const modal = modalElement ? bootstrap.Modal.getInstance(modalElement) : null;
    if (modal) {
        modal.hide();
    }
    if (form) {
        form.reset();
    }

    renderAnchors();
    renderStations();
    showAlert('Якорь добавлен', 'success');
}

function renameAnchor(encodedOldName, newName) {
    const oldName = decodeKey(encodedOldName);
    ensurePromptsStructure();
    if (!oldName) {
        return;
    }
    const cleaned = (newName || '').trim();
    if (!cleaned) {
        renderAnchors();
        return;
    }
    if (cleaned === oldName) {
        return;
    }
    if (promptsData.anchors[cleaned]) {
        showAlert('Якорь с таким названием уже существует', 'warning');
        renderAnchors();
        return;
    }
    const value = promptsData.anchors[oldName] || '';
    delete promptsData.anchors[oldName];
    promptsData.anchors[cleaned] = value;
    renderAnchors();
    renderStations();
}

function updateAnchorPrompt(encodedName, value) {
    const name = decodeKey(encodedName);
    ensurePromptsStructure();
    if (!name) {
        return;
    }
    const previousValue = promptsData.anchors[name] || '';
    promptsData.anchors[name] = value;

    if (previousValue === value) {
        return;
    }

    Object.keys(promptsData.stations || {}).forEach(code => {
        if (promptsData.stations[code] === previousValue) {
            promptsData.stations[code] = value;
        }
    });

    renderStations();
}

async function regenerateAnchorPrompt(encodedName) {
    const name = decodeKey(encodedName);
    if (!name) {
        return;
    }

    const conditionInput = document.getElementById(`additional-condition-${encodedName}`);
    const regenerateBtn = document.getElementById(`regenerate-btn-${encodedName}`);
    const promptTextarea = document.getElementById(`anchor-prompt-${encodedName}`);

    if (!conditionInput || !regenerateBtn || !promptTextarea) {
        showAlert('Ошибка: не найдены элементы интерфейса', 'danger');
        return;
    }

    const additionalCondition = (conditionInput.value || '').trim();
    if (!additionalCondition) {
        showAlert('Введите дополнительное условие или требование', 'warning');
        conditionInput.focus();
        return;
    }

    const currentPrompt = (promptTextarea.value || '').trim();
    if (!currentPrompt) {
        showAlert('Текущий промпт не может быть пустым', 'warning');
        return;
    }

    const originalContent = regenerateBtn.innerHTML;
    regenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Генерация...';
    regenerateBtn.disabled = true;

    try {
        const response = await fetch('/api/regenerate-anchor-prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_prompt: currentPrompt,
                additional_condition: additionalCondition
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Ошибка сервера:', response.status, errorText);
            showAlert(`Ошибка сервера (${response.status})`, 'danger');
            return;
        }

        const result = await response.json();

        if (result.success && result.prompt) {
            promptTextarea.value = result.prompt;
            updateAnchorPrompt(encodedName, result.prompt);
            conditionInput.value = '';
            showAlert('Промпт успешно доработан через AI', 'success');
        } else {
            showAlert(result.message || 'Ошибка при перегенерации промпта', 'danger');
        }
    } catch (error) {
        console.error('Ошибка при перегенерации промпта:', error);
        showAlert('Ошибка соединения при перегенерации промпта: ' + error.message, 'danger');
    } finally {
        regenerateBtn.innerHTML = originalContent;
        regenerateBtn.disabled = false;
    }
}

function removeAnchor(encodedName) {
    const name = decodeKey(encodedName);
    ensurePromptsStructure();
    if (!name || !promptsData.anchors[name]) {
        return;
    }
    if (!confirm(`Удалить якорь "${name}"? Тексты станций останутся без изменений.`)) {
        return;
    }
    delete promptsData.anchors[name];
    renderAnchors();
    renderStations();
}

function renderStations() {
    ensurePromptsStructure();
    const container = document.getElementById('stationPromptsContainer');
    if (!container) {
        return;
    }

    const stations = promptsData.stations || {};
    const stationCodes = Object.keys(stations);

    if (stationCodes.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">Станции пока не настроены</div>';
        return;
    }

    const anchors = promptsData.anchors || {};
    const anchorNames = Object.keys(anchors);
    stationCodes.sort();

    const promptsHtml = stationCodes.map(stationCode => {
        const currentPrompt = stations[stationCode] || '';
        let usedAnchor = null;
        for (const name of anchorNames) {
            if ((anchors[name] || '') === currentPrompt) {
                usedAnchor = name;
                break;
            }
        }
        const isCustomPrompt = !usedAnchor;
        const safeStationCode = escapeHtml(stationCode);
        const previewSource = usedAnchor ? (anchors[usedAnchor] || '') : currentPrompt;
        const previewText = previewSource
            ? escapeHtml(previewSource.length > 220 ? `${previewSource.slice(0, 220)}…` : previewSource)
            : '—';

        const anchorOptions = anchorNames.map(name => `
            <option value="${escapeHtml(name)}" ${usedAnchor === name ? 'selected' : ''}>${escapeHtml(name)}</option>
        `).join('');

        return `
            <div class="station-item" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="station-code mb-2" style="font-weight: bold; color: #667eea;">
                            <i class="fas fa-building me-2"></i>Станция ${safeStationCode}
                        </h6>
                        <div class="station-comment" style="color: #6c757d; font-style: italic;">
                            ${usedAnchor ? `Используется якорь: ${escapeHtml(usedAnchor)}` : 'Пользовательский текст'}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small mb-1">Связанный якорь</label>
                        <select class="form-select"
                                data-station-select="true"
                                data-station-code="${safeStationCode}"
                                onchange="updateStationPrompt(this)">
                            <option value="">Выберите якорь</option>
                            ${anchorOptions}
                            <option value="custom" ${isCustomPrompt ? 'selected' : ''}>Свой текст</option>
                        </select>
                    </div>
                </div>
                ${isCustomPrompt ? `
                    <div class="mt-3">
                        <textarea class="form-control prompt-textarea"
                                  data-station-text="true"
                                  data-station-code="${safeStationCode}"
                                  placeholder="Введите промпт для станции ${safeStationCode}..."
                                  oninput="handleStationPromptInput(this)" style="min-height: 150px; font-family: 'Courier New', monospace; font-size: 0.9rem;">${escapeHtml(currentPrompt)}</textarea>
                    </div>
                ` : `
                    <div class="text-muted small mt-2">
                        <strong>Фрагмент текста:</strong> ${previewText}
                    </div>
                `}
            </div>
        `;
    }).join('');

    container.innerHTML = promptsHtml;
}

function updateStationPrompt(selectEl) {
    if (!selectEl) return;
    const stationCode = selectEl.dataset.stationCode;
    if (!stationCode) return;
    ensurePromptsStructure();
    const selectedValue = selectEl.value;

    if (selectedValue === 'custom') {
        promptsData.stations[stationCode] = promptsData.stations[stationCode] || '';
    } else if (!selectedValue) {
        promptsData.stations[stationCode] = promptsData.default || '';
    } else {
        const anchorText = (promptsData.anchors || {})[selectedValue];
        promptsData.stations[stationCode] = anchorText || promptsData.stations[stationCode] || '';
    }

    renderStations();
}

function handleStationPromptInput(textareaEl) {
    if (!textareaEl) return;
    const stationCode = textareaEl.dataset.stationCode;
    if (!stationCode) return;
    ensurePromptsStructure();
    promptsData.stations[stationCode] = textareaEl.value;
}

async function savePrompts() {
    try {
        ensurePromptsStructure();
        const anchors = { ...(promptsData.anchors || {}) };
        const stations = {};
        const stationSelects = document.querySelectorAll('[data-station-select="true"]');
        stationSelects.forEach(select => {
            const stationCode = select.dataset.stationCode;
            if (!stationCode) {
                return;
            }
            stations[stationCode] = (promptsData.stations && promptsData.stations[stationCode]) || '';
        });

        const defaultPrompt = document.getElementById('defaultPrompt').value || '';

        const payload = {
            anchors,
            stations,
            default: defaultPrompt
        };

        const response = await fetch('/api/prompts/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            promptsData.default = defaultPrompt;
            showAlert('Промпты сохранены успешно', 'success');
        } else {
            showAlert(result.message || 'Ошибка при сохранении промптов', 'danger');
        }
    } catch (error) {
        console.error('Ошибка сохранения промптов:', error);
        showAlert('Ошибка сохранения промптов', 'danger');
    }
}
</script>
{% endblock %}
