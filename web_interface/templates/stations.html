{% extends "base.html" %}

{% block title %}Управление станциями - Call Analyzer{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Управление станциями</h1>
                <p class="text-muted mb-0">Добавляйте и редактируйте станции для мониторинга</p>
            </div>
            <button class="btn btn-add-station" data-bs-toggle="modal" data-bs-target="#addStationModal">
                <i class="fas fa-plus me-2"></i>Добавить станцию
            </button>
        </div>

        <!-- Список станций -->
        <div id="stationsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Загрузка станций...</span>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно добавления станции -->
<div class="modal fade" id="addStationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Добавить новую станцию
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Код станции</label>
                                <input type="text" class="form-control" id="stationCode" 
                                       placeholder="Например: 9322" required>
                                <div class="form-text">Уникальный код станции (4 цифры)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Название станции</label>
                                <input type="text" class="form-control" id="stationName" 
                                       placeholder="Например: Бринского" required>
                                <div class="form-text">Человекочитаемое название</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telegram Chat IDs</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="newChatId" 
                                   placeholder="Введите Chat ID">
                            <button class="btn btn-outline-primary" type="button" onclick="addChatId()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div id="chatIdsContainer"></div>
                        <div class="form-text">ID чатов для отправки уведомлений</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Подстанции (коды)</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="newSubStation" 
                                   placeholder="Введите код подстанции">
                            <button class="btn btn-outline-primary" type="button" onclick="addSubStation()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div id="subStationsContainer"></div>
                        <div class="form-text">Коды подстанций, привязанных к основной станции</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveStation()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования станции -->
<div class="modal fade" id="editStationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Редактировать станцию
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStationForm">
                    <input type="hidden" id="editStationCode">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Код станции</label>
                                <input type="text" class="form-control" id="editStationCodeDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Название станции</label>
                                <input type="text" class="form-control" id="editStationName" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telegram Chat IDs</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="editNewChatId" 
                                   placeholder="Введите Chat ID">
                            <button class="btn btn-outline-primary" type="button" onclick="addEditChatId()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div id="editChatIdsContainer"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Подстанции (коды)</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="editNewSubStation" 
                                   placeholder="Введите код подстанции">
                            <button class="btn btn-outline-primary" type="button" onclick="addEditSubStation()">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                        <div id="editSubStationsContainer"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="updateStation()">Сохранить</button>
                <button type="button" class="btn btn-danger" onclick="deleteStation()">Удалить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stationsData = [];
let currentEditStation = null;

// Загрузка станций при старте
document.addEventListener('DOMContentLoaded', function() {
    loadStations();
});

async function loadStations() {
    try {
        const response = await fetch('/api/stations');
        stationsData = await response.json();
        renderStations();
    } catch (error) {
        console.error('Ошибка загрузки станций:', error);
        showAlert('Ошибка загрузки станций', 'danger');
    }
}

function renderStations() {
    const container = document.getElementById('stationsContainer');
    
    if (stationsData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                <p class="text-muted mb-0">Станции не найдены</p>
                <p class="text-muted">Нажмите "Добавить станцию" для создания первой</p>
            </div>`;
        return;
    }

    const stationsHtml = stationsData.map(station => `
        <div class="station-card animate-fade-in">
            <div class="station-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="station-code">${station.code}</span>
                    <h4 class="d-inline ms-3 mb-0">${station.name}</h4>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="editStation('${station.code}')">
                    <i class="fas fa-edit me-1"></i> Редактировать
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-comments me-2"></i>Telegram Chat IDs
                    </h6>
                    <div>
                        ${station.chat_ids && station.chat_ids.length > 0 
                            ? station.chat_ids.map(chatId => `
                                <span class="chat-id-tag">${chatId}</span>
                            `).join('')
                            : '<span class="text-muted">Не заданы</span>'
                        }
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-sitemap me-2"></i>Подстанции
                    </h6>
                    <div>
                        ${station.sub_stations && station.sub_stations.length > 0
                            ? station.sub_stations.map(subCode => `
                                <span class="sub-station-tag">${subCode}</span>
                            `).join('')
                            : '<span class="text-muted">Не заданы</span>'
                        }
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = stationsHtml;
}

function addChatId() {
    const input = document.getElementById('newChatId');
    const chatId = input.value.trim();
    
    if (chatId) {
        const container = document.getElementById('chatIdsContainer');
        const tag = document.createElement('span');
        tag.className = 'chat-id-tag';
        tag.innerHTML = `
            ${chatId}
            <span class="remove-chat-id" onclick="removeChatId(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
        `;
        container.appendChild(tag);
        input.value = '';
    }
}

function removeChatId(element) {
    element.parentElement.remove();
}

function addSubStation() {
    const input = document.getElementById('newSubStation');
    const subStation = input.value.trim();
    
    if (subStation) {
        const container = document.getElementById('subStationsContainer');
        const tag = document.createElement('span');
        tag.className = 'sub-station-tag';
        tag.innerHTML = `
            ${subStation}
            <span class="remove-sub-station" onclick="removeSubStation(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
        `;
        container.appendChild(tag);
        input.value = '';
    }
}

function removeSubStation(element) {
    element.parentElement.remove();
}

function addEditChatId() {
    const input = document.getElementById('editNewChatId');
    const chatId = input.value.trim();
    
    if (chatId) {
        const container = document.getElementById('editChatIdsContainer');
        const tag = document.createElement('span');
        tag.className = 'chat-id-tag';
        tag.innerHTML = `
            ${chatId}
            <span class="remove-chat-id" onclick="removeChatId(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
        `;
        container.appendChild(tag);
        input.value = '';
    }
}

function addEditSubStation() {
    const input = document.getElementById('editNewSubStation');
    const subStation = input.value.trim();
    
    if (subStation) {
        const container = document.getElementById('editSubStationsContainer');
        const tag = document.createElement('span');
        tag.className = 'sub-station-tag';
        tag.innerHTML = `
            ${subStation}
            <span class="remove-sub-station" onclick="removeSubStation(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
        `;
        container.appendChild(tag);
        input.value = '';
    }
}

function editStation(stationCode) {
    const station = stationsData.find(s => s.code === stationCode);
    if (!station) return;

    currentEditStation = station;
    
    document.getElementById('editStationCode').value = station.code;
    document.getElementById('editStationCodeDisplay').value = station.code;
    document.getElementById('editStationName').value = station.name;
    
    // Заполняем Chat IDs
    const chatIdsContainer = document.getElementById('editChatIdsContainer');
    chatIdsContainer.innerHTML = '';
    if (station.chat_ids && station.chat_ids.length > 0) {
        station.chat_ids.forEach(chatId => {
            const tag = document.createElement('span');
            tag.className = 'chat-id-tag';
            tag.innerHTML = `
                ${chatId}
                <span class="remove-chat-id" onclick="removeChatId(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
            `;
            chatIdsContainer.appendChild(tag);
        });
    }
    
    // Заполняем подстанции
    const subStationsContainer = document.getElementById('editSubStationsContainer');
    subStationsContainer.innerHTML = '';
    if (station.sub_stations && station.sub_stations.length > 0) {
        station.sub_stations.forEach(subCode => {
            const tag = document.createElement('span');
            tag.className = 'sub-station-tag';
            tag.innerHTML = `
                ${subCode}
                <span class="remove-sub-station" onclick="removeSubStation(this)" style="cursor: pointer; margin-left: 5px; color: #d32f2f;">×</span>
            `;
            subStationsContainer.appendChild(tag);
        });
    }
    
    const modal = new bootstrap.Modal(document.getElementById('editStationModal'));
    modal.show();
}

async function saveStation() {
    const code = document.getElementById('stationCode').value.trim();
    const name = document.getElementById('stationName').value.trim();
    
    if (!code || !name) {
        showAlert('Заполните все обязательные поля', 'warning');
        return;
    }
    
    // Собираем Chat IDs
    const chatIds = [];
    document.querySelectorAll('#chatIdsContainer .chat-id-tag').forEach(tag => {
        const text = tag.textContent.trim();
        const chatId = text.replace('×', '').trim();
        if (chatId) chatIds.push(chatId);
    });
    
    // Собираем подстанции
    const subStations = [];
    document.querySelectorAll('#subStationsContainer .sub-station-tag').forEach(tag => {
        const text = tag.textContent.trim();
        const subCode = text.replace('×', '').trim();
        if (subCode) subStations.push(subCode);
    });
    
    const stationData = {
        station_mapping: {
            [code]: {
                name: name,
                chat_ids: chatIds,
                sub_stations: subStations
            }
        }
    };

    try {
        const response = await fetch('/api/stations/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(stationData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Станция добавлена', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addStationModal'));
            modal.hide();
            document.getElementById('addStationForm').reset();
            document.getElementById('chatIdsContainer').innerHTML = '';
            document.getElementById('subStationsContainer').innerHTML = '';
            
            loadStations();
        } else {
            showAlert('Ошибка при добавлении станции: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('Ошибка при сохранении станции:', error);
        showAlert('Ошибка при добавлении станции', 'danger');
    }
}

async function updateStation() {
    if (!currentEditStation) return;
    
    const name = document.getElementById('editStationName').value.trim();
    
    if (!name) {
        showAlert('Заполните название станции', 'warning');
        return;
    }
    
    // Собираем Chat IDs
    const chatIds = [];
    document.querySelectorAll('#editChatIdsContainer .chat-id-tag').forEach(tag => {
        const text = tag.textContent.trim();
        const chatId = text.replace('×', '').trim();
        if (chatId) chatIds.push(chatId);
    });
    
    // Собираем подстанции
    const subStations = [];
    document.querySelectorAll('#editSubStationsContainer .sub-station-tag').forEach(tag => {
        const text = tag.textContent.trim();
        const subCode = text.replace('×', '').trim();
        if (subCode) subStations.push(subCode);
    });
    
    const stationData = {
        code: currentEditStation.code,
        name: name,
        chat_ids: chatIds,
        sub_stations: subStations
    };
    
    try {
        const response = await fetch('/api/stations/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                station_mapping: {
                    [stationData.code]: {
                        name: stationData.name,
                        chat_ids: stationData.chat_ids,
                        sub_stations: stationData.sub_stations
                    }
                }
            })
        });
        
        if (response.ok) {
            showAlert('Станция обновлена', 'success');
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('editStationModal'));
            modal.hide();
            
            // Обновляем список станций
            loadStations();
        } else {
            const error = await response.json();
            showAlert(`Ошибка при обновлении станции: ${error.message}`, 'danger');
        }
    } catch (error) {
        console.error('Ошибка при обновлении станции:', error);
        showAlert('Ошибка при обновлении станции', 'danger');
    }
}

async function deleteStation() {
    if (!currentEditStation) return;
    
    showConfirm(`Вы уверены, что хотите удалить станцию "${currentEditStation.name}"?`, async () => {
        try {
            const response = await fetch('/api/stations/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    station_mapping: {
                        [currentEditStation.code]: null  // null означает удаление
                    }
                })
            });
            
            if (response.ok) {
                showAlert('Станция удалена', 'success');
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStationModal'));
                modal.hide();
                
                // Перезагружаем список станций
                loadStations();
            } else {
                const error = await response.json();
                showAlert(`Ошибка при удалении станции: ${error.message}`, 'danger');
            }
        } catch (error) {
            console.error('Ошибка при удалении станции:', error);
            showAlert('Ошибка при удалении станции', 'danger');
        }
    });
}
</script>
{% endblock %}
