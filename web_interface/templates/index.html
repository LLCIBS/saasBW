{% extends "base.html" %}

{% block title %}Панель управления - Call Analyzer{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
            <div>
                <h1 class="h3 mb-0">Панель управления</h1>
                <p class="text-muted mb-0">Добро пожаловать! Вот текущий статус системы.</p>
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" onclick="startService()" data-bs-toggle="tooltip" title="Запустить сервис">
                    <i class="fas fa-play"></i>
                    <span class="d-none d-sm-inline">Запустить</span>
                </button>
                <button type="button" class="btn btn-danger" onclick="stopService()" data-bs-toggle="tooltip" title="Остановить сервис">
                    <i class="fas fa-stop"></i>
                    <span class="d-none d-sm-inline">Остановить</span>
                </button>
                <button type="button" class="btn btn-warning" onclick="restartService()" data-bs-toggle="tooltip" title="Перезапустить сервис">
                    <i class="fas fa-redo"></i>
                    <span class="d-none d-sm-inline">Перезапустить</span>
                </button>
                <button type="button" class="btn btn-info" onclick="rescanCurrentDay()" data-bs-toggle="tooltip" title="Переобойти папку текущего дня">
                    <i class="fas fa-folder-open"></i>
                    <span class="d-none d-sm-inline">Переобход файлов</span>
                </button>
            </div>
        </div>

        <!-- Статус сервиса -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card" id="statusCard">
                    <div class="card-body text-center">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="card-title mb-2">
                                    <i class="fas fa-server me-2"></i>
                                    Статус сервиса
                                </h4>
                                <p class="card-text mb-0" id="statusText">Проверка...</p>
                            </div>
                            <div class="col-md-4">
                                <div class="spinner-border text-light" id="statusSpinner" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Метрики -->
        <div class="row mb-4">
            <div class="col-6 col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="totalCalls">-</div>
                    <div class="metric-label">
                        <i class="fas fa-phone-alt me-1"></i>
                        Всего звонков
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="activeTransfers">-</div>
                    <div class="metric-label">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Активные переводы
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="activeRecalls">-</div>
                    <div class="metric-label">
                        <i class="fas fa-redo me-1"></i>
                        Активные перезвоны
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="stationsCount">-</div>
                    <div class="metric-label">
                        <i class="fas fa-building me-1"></i>
                        Станций
                    </div>
                </div>
            </div>
        </div>

        <!-- Лидерборд и таблица консультантов -->
        <div class="row mb-4" id="realtimeBlocks" style="display:none;">
            <div class="col-lg-5 mb-4 mb-lg-0">
                <div class="leaderboard-card">
                    <h5 class="mb-3">
                        <i class="fas fa-trophy me-2 text-warning"></i>
                        Лидерборд станций (Итог %)
                    </h5>
                    <div id="leaderboardContainer">
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">Нет данных</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="consultants-card">
                    <h5 class="mb-3">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Показатели по консультантам
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle" id="consultantsTable">
                            <thead>
                                <tr>
                                    <th>Станция</th>
                                    <th>Консультант</th>
                                    <th>Звонков</th>
                                    <th>Итог, %</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние логи -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            Последние логи
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()" data-bs-toggle="tooltip" title="Обновить логи">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logsContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Загрузка логов...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
// Обновление статуса каждые 5 секунд
setInterval(updateStatus, 5000);

// Загрузка данных при старте
document.addEventListener('DOMContentLoaded', function() {
    updateStatus();
    loadLogs();
});

async function updateStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        updateServiceStatus(data.service);
        updateMetrics(data);
        updateLogs(data.recent_logs);
        
    } catch (error) {
        console.error('Ошибка обновления статуса:', error);
    }
}

function updateServiceStatus(service) {
    const statusCard = document.getElementById('statusCard');
    const statusText = document.getElementById('statusText');
    const statusSpinner = document.getElementById('statusSpinner');
    
    statusSpinner.style.display = 'none';
    
    if (service.running) {
        statusCard.className = 'card status-card status-running';
        statusText.innerHTML = '<i class="fas fa-check-circle me-2"></i>Сервис работает';
    } else {
        statusCard.className = 'card status-card status-stopped';
        statusText.innerHTML = '<i class="fas fa-times-circle me-2"></i>Сервис остановлен';
    }
}

function updateMetrics(data) {
    // Подгружаем онлайн-сводку за сегодня
    fetch('/api/summary/realtime')
        .then(r => r.json())
        .then(summary => {
            if (!summary || summary.success === false) {
                document.getElementById('totalCalls').textContent = '-';
                document.getElementById('stationsCount').textContent = '-';
                document.getElementById('activeTransfers').textContent = '-';
                document.getElementById('activeRecalls').textContent = '-';
                document.getElementById('realtimeBlocks').style.display = 'none';
                return;
            }
            document.getElementById('totalCalls').textContent = summary.total_calls ?? '-';
            document.getElementById('stationsCount').textContent = summary.stations_count ?? '-';
            document.getElementById('activeTransfers').textContent = summary.active_transfers ?? '0';
            document.getElementById('activeRecalls').textContent = summary.active_recalls ?? '0';

            // Лидерборд
            const lb = (summary.ranking || []).slice(0, 10);
            const lbContainer = document.getElementById('leaderboardContainer');
            if (lb.length === 0) {
                lbContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Нет данных</p>
                    </div>`;
            } else {
                lbContainer.innerHTML = lb.map((item, index) => {
                    let badgeClass = 'bg-primary';
                    if (index === 0) badgeClass = 'bg-warning';
                    if (index === 1) badgeClass = 'bg-secondary';
                    if (index === 2) badgeClass = 'bg-danger';
                    
                    return `
                    <div class="leaderboard-item">
                        <div>
                            <span class="badge ${badgeClass} me-2">${index + 1}</span>
                            <span class="fw-bold">${item.station}</span>
                        </div>
                        <div class="percent">${(item.percent_total || 0).toFixed(1)}%</div>
                    </div>`;
                }).join('');
            }

            // Таблица консультантов по всем станциям
            const tbody = document.querySelector('#consultantsTable tbody');
            const rows = [];
            (summary.stations || []).forEach(st => {
                (st.consultants || []).forEach(c => {
                    // Создаем объект консультанта со всеми полями, включая q1-q15
                    const consultantData = {
                        station: st.station,
                        name: c.name,
                        calls: c.calls || 0,
                        total: c.percent_total || 0
                    };
                    
                    // Добавляем все поля q1-q15
                    for (let i = 1; i <= 15; i++) {
                        const questionKey = `q${i}`;
                        if (c[questionKey] !== undefined) {
                            consultantData[questionKey] = c[questionKey];
                        }
                    }
                    
                    rows.push(consultantData);
                });
            });
            rows.sort((a,b)=>b.total - a.total);
            // Сохраняем данные консультантов в глобальную переменную
            consultantsData = rows;
            
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center py-3"><i class="fas fa-inbox me-2"></i>Нет данных</td></tr>';
                document.getElementById('realtimeBlocks').style.display = 'none';
            } else {
                tbody.innerHTML = rows.map((r, index) => `
                    <tr class="consultant-row" onclick="showConsultantDetails(${index})" data-consultant='${JSON.stringify(r)}'>
                        <td><i class="fas fa-building me-2 text-muted"></i>${r.station}</td>
                        <td><i class="fas fa-user me-2 text-muted"></i>${r.name}</td>
                        <td><span class="badge bg-light text-dark">${r.calls}</span></td>
                        <td><span class="percent fw-bold">${r.total.toFixed(1)}%</span></td>
                    </tr>
                `).join('');
                document.getElementById('realtimeBlocks').style.display = 'flex';
            }
        })
        .catch(() => {
            document.getElementById('totalCalls').textContent = '-';
            document.getElementById('stationsCount').textContent = '-';
            document.getElementById('activeTransfers').textContent = '-';
            document.getElementById('activeRecalls').textContent = '-';
            document.getElementById('realtimeBlocks').style.display = 'none';
        });
}

function updateLogs(logs) {
    const container = document.getElementById('logsContainer');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">Логи не найдены</p>
            </div>`;
        return;
    }
    
    const logsHtml = logs.map(log => {
        let iconClass = 'fa-info-circle';
        if (log.level === 'WARNING') iconClass = 'fa-exclamation-triangle';
        if (log.level === 'ERROR') iconClass = 'fa-times-circle';
        if (log.level === 'SUCCESS') iconClass = 'fa-check-circle';
        
        return `
        <div class="log-entry ${log.level.toLowerCase()}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold me-2"><i class="fas ${iconClass} me-1"></i>${log.module || 'System'}</span>
                </div>
                <small class="text-muted">${new Date(log.timestamp).toLocaleString()}</small>
            </div>
            <div class="mt-1">${log.message}</div>
        </div>`;
    }).join('');
    
    container.innerHTML = logsHtml;
}

async function loadLogs() {
    try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        
        if (data.logs) {
            updateLogs(data.logs);
        }
    } catch (error) {
        console.error('Ошибка загрузки логов:', error);
    }
}

function refreshLogs() {
    loadLogs();
}

async function startService() {
    try {
        const response = await fetch('/service/start', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert('Сервис запущен', 'success');
            setTimeout(updateStatus, 2000);
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка запуска сервиса', 'danger');
    }
}

async function stopService() {
    try {
        const response = await fetch('/service/stop', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert('Сервис остановлен', 'warning');
            setTimeout(updateStatus, 2000);
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка остановки сервиса', 'danger');
    }
}

async function restartService() {
    try {
        const response = await fetch('/service/restart', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert('Сервис перезапущен', 'info');
            setTimeout(updateStatus, 3000);
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка перезапуска сервиса', 'danger');
    }
}

async function rescanCurrentDay() {
    try {
        showAlert('Запуск переобхода папки текущего дня...', 'info');
        const response = await fetch('/api/rescan-current-day', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showAlert(`Переобход запущен. Папка: ${data.path}`, 'success');
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        console.error('Ошибка переобхода файлов:', error);
        showAlert('Ошибка при запуске переобхода файлов', 'danger');
    }
}

// Глобальная переменная для хранения данных консультантов
let consultantsData = [];

function showConsultantDetails(index) {
    const consultant = consultantsData[index];
    if (!consultant) return;

    // Создаем модальное окно динамически
    const modalId = 'consultantModal';
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHtml = `
    <div class="modal fade" id="${modalId}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-circle me-2"></i>Детализация по консультанту
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <small class="text-muted">Станция</small>
                                    <div class="fw-bold fs-5" id="modalStation"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <small class="text-muted">Консультант</small>
                                    <div class="fw-bold fs-5" id="modalConsultant"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <small class="text-muted">Количество звонков</small>
                                    <div class="fw-bold fs-4" id="modalCalls"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <small class="text-white-50">Общий итог</small>
                                    <div class="fw-bold fs-3" id="modalTotal"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-3"><i class="fas fa-list-check me-2 text-primary"></i>Детализация по вопросам чек-листа:</h6>
                    <div id="modalQuestions"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Заполняем основную информацию
    document.getElementById('modalStation').textContent = consultant.station;
    document.getElementById('modalConsultant').textContent = consultant.name;
    document.getElementById('modalCalls').textContent = consultant.calls;
    document.getElementById('modalTotal').textContent = consultant.total.toFixed(1) + '%';

    // Заполняем детализацию по вопросам
    const questionsContainer = document.getElementById('modalQuestions');
    questionsContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Загрузка детализации...</span>
        </div>`;

    // Получаем названия вопросов из чек-листа
    fetch('/api/script-prompt')
        .then(r => r.json())
        .then(data => {
            const checklist = data.data?.checklist || [];
            const questionsHtml = [];
            
            // Проходим по всем вопросам (1-15)
            for (let i = 1; i <= 15; i++) {
                const questionKey = `q${i}`;
                if (consultant[questionKey] !== undefined) {
                    // Берем название из чек-листа по индексу (i-1)
                    const questionTitle = checklist[i-1]?.title || `Вопрос ${i}`;
                    const percent = consultant[questionKey];
                    
                    // Определяем цвет и иконку в зависимости от процента
                    let colorClass = 'text-danger';
                    let iconClass = 'fa-times-circle';
                    let bgClass = 'bg-danger bg-opacity-10';
                    
                    if (percent >= 70) {
                        colorClass = 'text-success';
                        iconClass = 'fa-check-circle';
                        bgClass = 'bg-success bg-opacity-10';
                    } else if (percent >= 40) {
                        colorClass = 'text-warning';
                        iconClass = 'fa-exclamation-circle';
                        bgClass = 'bg-warning bg-opacity-10';
                    }
                    
                    questionsHtml.push(`
                        <div class="question-detail ${bgClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="question-title">
                                    <i class="fas ${iconClass} me-2 ${colorClass}"></i>
                                    ${i}. ${questionTitle}
                                </div>
                                <div class="question-percent fw-bold ${colorClass}">${percent.toFixed(1)}%</div>
                            </div>
                        </div>
                    `);
                }
            }
            
            // Если нет данных по вопросам, показываем сообщение
            if (questionsHtml.length === 0) {
                questionsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Нет данных по вопросам чек-листа</p>
                    </div>`;
            } else {
                questionsContainer.innerHTML = questionsHtml.join('');
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки чек-листа:', error);
            questionsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка загрузки детализации
                </div>`;
        });

    // Показываем модальное окно
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
    
    // Удаляем модал при закрытии
    document.getElementById(modalId).addEventListener('hidden.bs.modal', () => {
        setTimeout(() => {
            const modalEl = document.getElementById(modalId);
            if (modalEl) {
                modalEl.remove();
            }
        }, 300);
    });
}
</script>
{% endblock %}
