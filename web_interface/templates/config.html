{% extends "base.html" %}

{% block title %}Конфигурация системы - Call Analyzer{% endblock %}

{% block extra_css %}
<style>
/* Config Page Specific Styles */
.config-tabs {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-light);
    scrollbar-width: thin;
}

.config-tab {
    flex-shrink: 0;
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.config-tab:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.config-tab.active {
    background: var(--primary-gradient);
    color: white;
}

.config-tab i {
    font-size: 1rem;
}

.config-panel {
    display: none;
    animation: fadeIn 0.3s ease;
}

.config-panel.active {
    display: block;
}

.form-card {
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    margin-bottom: 1.5rem;
    transition: all var(--transition-base);
}

.form-card:hover {
    box-shadow: var(--shadow-md);
}

.form-card-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-card-title i {
    color: var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-row-single {
    margin-bottom: 1.5rem;
}

.input-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.input-wrapper label {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.input-wrapper .help-text {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
}

.password-input-group {
    display: flex;
    gap: 0.5rem;
}

.password-input-group .form-control {
    flex: 1;
}

.switch-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
}

.switch-wrapper label {
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--text-primary);
    margin: 0;
    flex: 1;
}

.action-bar {
    position: sticky;
    bottom: 0;
    background: var(--bg-primary);
    padding: 1rem 0;
    border-top: 1px solid var(--border-light);
    margin-top: 2rem;
    z-index: 100;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .config-tabs {
        gap: 0.25rem;
    }
    
    .config-tab {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .form-card {
        padding: 1rem;
    }
    
    .password-input-group {
        flex-direction: column;
    }
    
    .password-input-group .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Боковая панель -->
{% include 'partials/sidebar.html' %}

<!-- Основной контент -->
<main class="col-md-9 col-lg-10 main-content">
    <div class="p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h1 class="h3 mb-1">Конфигурация системы</h1>
                <p class="text-muted mb-0">Настройте параметры приложения</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="resetConfig()">
                    <i class="fas fa-undo me-2"></i>Сбросить
                </button>
                <button class="btn btn-primary" onclick="saveAllConfig()">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="config-tabs">
            <button class="config-tab active" data-tab="api">
                <i class="fas fa-key"></i>
                <span>API</span>
            </button>
            <button class="config-tab" data-tab="telegram">
                <i class="fab fa-telegram"></i>
                <span>Telegram</span>
            </button>
            <button class="config-tab" data-tab="paths">
                <i class="fas fa-folder-open"></i>
                <span>Пути</span>
            </button>
            <button class="config-tab" data-tab="transcription">
                <i class="fas fa-microphone"></i>
                <span>Транскрипция</span>
            </button>
            <button class="config-tab" data-tab="formats">
                <i class="fas fa-file-audio"></i>
                <span>Форматы файлов</span>
            </button>
            <button class="config-tab" data-tab="stations">
                <i class="fas fa-map-marker-alt"></i>
                <span>Станции</span>
            </button>
            <button class="config-tab" data-tab="extensions">
                <i class="fas fa-user-tag"></i>
                <span>Привязка номеров</span>
            </button>
        </div>

        <!-- API Panel -->
        <div class="config-panel active" id="api-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-shield-alt"></i>
                    <span>Ключи доступа к сервисам</span>
                </div>
                <form id="apiConfigForm">
                    <div class="form-row">
                        <div class="input-wrapper">
                            <label for="speechmaticsApiKey">Speechmatics API Key</label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="speechmaticsApiKey" 
                                       placeholder="Введите ключ">
                                <button class="btn btn-outline-secondary" type="button" id="toggleSpeechmatics"
                                        onclick="togglePassword('speechmaticsApiKey', 'toggleSpeechmatics')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="help-text">Ключ для сервиса транскрипции речи в текст</div>
                        </div>

                        <div class="input-wrapper">
                            <label for="thebaiApiKey">TheB.ai API Key</label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="thebaiApiKey" 
                                       placeholder="Введите ключ">
                                <button class="btn btn-outline-secondary" type="button" id="toggleThebai"
                                        onclick="togglePassword('thebaiApiKey', 'toggleThebai')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="help-text">Ключ для AI-анализа звонков</div>
                        </div>
                    </div>

                    <div class="form-row-single">
                        <div class="input-wrapper">
                            <label for="telegramBotToken">Telegram Bot Token</label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="telegramBotToken" 
                                       placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                                <button class="btn btn-outline-secondary" type="button" id="toggleTelegram"
                                        onclick="togglePassword('telegramBotToken', 'toggleTelegram')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="help-text">Токен бота для отправки уведомлений и отчетов</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Telegram Panel -->
        <div class="config-panel" id="telegram-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fab fa-telegram"></i>
                    <span>Настройки уведомлений</span>
                </div>
                <form id="telegramConfigForm">
                    <div class="form-row">
                        <div class="input-wrapper">
                            <label for="alertChatId">Alert Chat ID</label>
                            <input type="text" class="form-control" id="alertChatId" 
                                   placeholder="-1001234567890">
                            <div class="help-text">Чат для критических уведомлений об ошибках</div>
                        </div>

                        <div class="input-wrapper">
                            <label for="reportsChatId">Чат для отчетов</label>
                            <input type="text" class="form-control" id="reportsChatId" 
                                   placeholder="-1001234567890">
                            <div class="help-text">Чат для отправки сгенерированных Excel-отчетов</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-wrapper">
                            <label for="tgChannelNizh">Нижегородский канал</label>
                            <input type="text" class="form-control" id="tgChannelNizh" 
                                   placeholder="@channel_nizhny">
                            <div class="help-text">Канал для Нижегородских станций</div>
                        </div>

                        <div class="input-wrapper">
                            <label for="tgChannelOther">Канал остальных станций</label>
                            <input type="text" class="form-control" id="tgChannelOther" 
                                   placeholder="@channel_other">
                            <div class="help-text">Канал для остальных станций</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Paths Panel -->
        <div class="config-panel" id="paths-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-hdd"></i>
                    <span>Источник файлов</span>
                </div>
                
                <div class="mb-4">
                    <label class="form-label mb-2">Источник звонков</label>
                    <div class="btn-group" role="group" id="sourceTypeGroup">
                        <input type="radio" class="btn-check" name="sourceType" id="sourceTypeLocal" value="local" checked>
                        <label class="btn btn-outline-primary" for="sourceTypeLocal">
                            <i class="fas fa-folder me-1"></i> Локальная папка
                        </label>
                        <input type="radio" class="btn-check" name="sourceType" id="sourceTypeFtp" value="ftp">
                        <label class="btn btn-outline-primary" for="sourceTypeFtp">
                            <i class="fas fa-server me-1"></i> FTP подключение
                        </label>
                    </div>
                    <div class="form-text mt-2">Выберите откуда брать файлы звонков для обработки</div>
                </div>

                <form id="pathsConfigForm">
                    <div class="input-wrapper mb-3" id="localPathGroup">
                        <label for="baseRecordsPath">Базовый путь к записям</label>
                        <input type="text" class="form-control" id="baseRecordsPath" 
                               placeholder="/path/to/records">
                        <div class="help-text">Локальный путь к папке с аудиозаписями</div>
                    </div>

                    <div class="row mb-3 d-none" id="ftpPathGroup">
                        <div class="col-md-6">
                            <div class="input-wrapper">
                                <label for="ftpConnectionId">FTP подключение</label>
                                <select class="form-select" id="ftpConnectionId">
                                    <option value="">-- Выберите подключение --</option>
                                </select>
                                <div class="help-text">Выберите настроенное FTP-подключение</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-wrapper">
                                <label for="baseRecordsPathFtp">Локальная папка для сохранения</label>
                                <input type="text" class="form-control" id="baseRecordsPathFtp" 
                                       placeholder="/path/to/records">
                                <div class="help-text">Папка, куда будут скачиваться файлы с FTP</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-file-alt"></i>
                    <span>Файлы конфигурации</span>
                </div>
                
                <form id="filesConfigForm">
                    <div class="form-row">
                        <div class="input-wrapper">
                            <label for="promptsFile">Файл промптов</label>
                            <input type="text" class="form-control" id="promptsFile" 
                                   placeholder="/path/to/prompts.yaml">
                            <div class="help-text">Путь к YAML-файлу с промптами для AI</div>
                        </div>

                        <div class="input-wrapper">
                            <label for="additionalVocabFile">Файл словаря</label>
                            <input type="text" class="form-control" id="additionalVocabFile" 
                                   placeholder="/path/to/vocab.txt">
                            <div class="help-text">Путь к файлу со специализированным словарем</div>
                        </div>
                    </div>

                    <div class="form-row-single">
                        <div class="input-wrapper">
                            <label for="scriptPromptFile">Файл скриптов</label>
                            <input type="text" class="form-control" id="scriptPromptFile" 
                                   placeholder="/path/to/scripts.yaml">
                            <div class="help-text">Путь к YAML-файлу со скриптами операторов</div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transcription Panel -->
        <div class="config-panel" id="transcription-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-cogs"></i>
                    <span>Параметры транскрипции</span>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="tbankStereoEnabled">
                    <label class="form-check-label" for="tbankStereoEnabled">Стерео режим (2 спикера, диаризация по каналам)</label>
                </div>
                <div class="form-text mb-3">При включении используется стерео алгоритм из T‑Bank с анализом голосов; при выключении — стандартный моно режим.</div>
                
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoDetectOperatorName" checked>
                    <label class="form-check-label" for="autoDetectOperatorName">Автоматическое определение имени оператора</label>
                </div>
                <div class="form-text mt-2">При включении система пытается извлечь имя оператора из транскрипции (когда консультант представляется), затем использует таблицу привязки. При выключении сразу берет имя из таблицы EMPLOYEE_BY_EXTENSION.</div>
            </div>
        </div>

        <!-- File Formats Panel -->
        <div class="config-panel" id="formats-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-file-audio"></i>
                    <span>Форматы аудиофайлов</span>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="filenameEnabled">
                    <label class="form-check-label" for="filenameEnabled">Использовать свои правила для имён файлов</label>
                </div>
                
                <div id="customFilenameSection" style="display: none;">
                    <div class="alert alert-info py-2 mb-3" style="font-size: 0.9rem;">
                        <i class="fas fa-info-circle me-2"></i>
                        Используйте теги: <strong>{телефон}</strong>, <strong>{станция}</strong>, <strong>{дата_время}</strong> и <strong>{любой}</strong>.
                        <br>Пример: <code>{телефон}_{станция}_{дата_время}</code> или <code>rec-{телефон}-{дата_время}</code>
                    </div>

                    <div class="mb-3">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th style="width:15%">Название (Бренд АТС)</th>
                                        <th>Шаблон (как выглядит имя файла)</th>
                                        <th style="width:15%">Формат даты</th>
                                        <th style="width:12%">Направление</th>
                                        <th style="width:10%" title="Запускать ли детальный анализ по чек-листу для этих звонков?">Чек-лист</th>
                                        <th style="width:50px"></th>
                                    </tr>
                                </thead>
                                <tbody id="filenamePatternsContainer">
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="addFilenamePattern()">
                            <i class="fas fa-plus me-1"></i> Добавить правило
                        </button>
                    </div>

                    <!-- Блок тестирования -->
                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2"><i class="fas fa-vial me-2"></i>Проверить шаблон</h6>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <input type="text" class="form-control form-control-sm" id="filenameTestInput" 
                                           placeholder="Вставьте сюда реальное имя файла (например: 79001112233_101_2023-12-01.mp3)">
                                </div>
                                <div class="col-md-4">
                                    <div id="filenameTestResult" class="small mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Разрешенные расширения</label>
                    <div id="filenameExtensionsContainer" class="d-flex flex-wrap gap-1 mb-2"></div>
                    <div class="input-group input-group-sm" style="max-width: 200px;">
                        <input type="text" class="form-control" id="filenameExtensionInput" placeholder=".mp3">
                        <button class="btn btn-outline-primary" type="button" onclick="addFilenameExtension()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="form-text small">Если свои правила отключены, система использует стандартные форматы (fs_*, external-*, вход_*).</div>
            </div>
        </div>

        <!-- Stations Panel -->
        <div class="config-panel" id="stations-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Коды станций Нижегородского региона</span>
                </div>
                
                <div class="input-wrapper mb-3">
                    <label>Добавить код станции</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newStationCode" 
                               placeholder="Введите код станции (например: 9322)">
                        <button class="btn btn-outline-primary" type="button" onclick="addStationCode()">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                </div>
                <div id="stationCodesContainer">
                    <!-- Коды станций будут загружены динамически -->
                </div>
            </div>
        </div>

        <!-- Extensions Panel -->
        <div class="config-panel" id="extensions-panel">
            <div class="form-card">
                <div class="form-card-title">
                    <i class="fas fa-user-tag"></i>
                    <span>Привязка внутренних номеров к сотрудникам</span>
                </div>
                
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Код станции/подстанции</label>
                        <input type="text" id="extCode" class="form-control" placeholder="например: 202 или 403">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Сотрудник (ФИО/фамилия)</label>
                        <input type="text" id="extEmployee" class="form-control" placeholder="например: Иванов">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" type="button" onclick="addExtension()">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                </div>
                <div id="extensionsContainer" class="table-responsive">
                    <!-- Таблица привязок загружается динамически -->
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="d-flex justify-content-end gap-3">
                <button class="btn btn-outline-secondary" onclick="resetConfig()">
                    <i class="fas fa-undo me-2"></i>Сбросить изменения
                </button>
                <button class="btn btn-primary" onclick="saveAllConfig()">
                    <i class="fas fa-save me-2"></i>Сохранить все настройки
                </button>
            </div>
        </div>
    </div>
</main>

<script>
let configData = {};

// Tab Navigation
document.querySelectorAll('.config-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // Remove active from all tabs and panels
        document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.config-panel').forEach(p => p.classList.remove('active'));
        
        // Add active to clicked tab and corresponding panel
        this.classList.add('active');
        const tabName = this.dataset.tab;
        document.getElementById(tabName + '-panel').classList.add('active');
    });
});

// Source type toggle
document.querySelectorAll('input[name="sourceType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateSourceTypeUI(this.value);
    });
});

// Toggle password visibility
function togglePassword(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
        button.title = 'Скрыть пароль';
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
        button.title = 'Показать пароль';
    }
}

// Функция переключения UI между локальной папкой и FTP
function updateSourceTypeUI(sourceType) {
    const localGroup = document.getElementById('localPathGroup');
    const ftpGroup = document.getElementById('ftpPathGroup');
    
    if (sourceType === 'local') {
        localGroup.classList.remove('d-none');
        ftpGroup.classList.add('d-none');
    } else {
        localGroup.classList.add('d-none');
        ftpGroup.classList.remove('d-none');
    }
}

// Загрузка списка FTP подключений
async function loadFtpConnections() {
    try {
        const response = await fetch('/api/ftp/connections');
        const connections = await response.json();
        
        const select = document.getElementById('ftpConnectionId');
        // Сохраняем текущее значение
        const currentValue = select.value;
        
        // Очищаем и заполняем список
        select.innerHTML = '<option value="">-- Выберите подключение --</option>';
        
        connections.forEach(conn => {
            const option = document.createElement('option');
            option.value = conn.id;
            option.textContent = `${conn.name} (${conn.host})`;
            if (conn.id == currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки FTP подключений:', error);
    }
}

// Load configuration on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/config/load');
        configData = await response.json();
        ensureFilenameConfig();
        
        // Заполняем поля формы
        document.getElementById('speechmaticsApiKey').value = configData.api_keys?.speechmatics_api_key || '';
        document.getElementById('thebaiApiKey').value = configData.api_keys?.thebai_api_key || '';
        document.getElementById('telegramBotToken').value = configData.api_keys?.telegram_bot_token || '';
        
        document.getElementById('alertChatId').value = configData.telegram?.alert_chat_id || '';
        document.getElementById('reportsChatId').value = configData.telegram?.reports_chat_id || '';
        document.getElementById('tgChannelNizh').value = configData.telegram?.tg_channel_nizh || '';
        document.getElementById('tgChannelOther').value = configData.telegram?.tg_channel_other || '';
        
        // Источник звонков
        const sourceType = configData.paths?.source_type || 'local';
        document.getElementById('sourceTypeLocal').checked = (sourceType === 'local');
        document.getElementById('sourceTypeFtp').checked = (sourceType === 'ftp');
        
        // Загружаем FTP подключения для выпадающего списка
        await loadFtpConnections();
        
        // Устанавливаем выбранное FTP подключение
        const ftpConnectionId = configData.paths?.ftp_connection_id;
        if (ftpConnectionId) {
            document.getElementById('ftpConnectionId').value = ftpConnectionId;
        }
        
        // Обновляем UI после загрузки подключений
        updateSourceTypeUI(sourceType);
        
        document.getElementById('baseRecordsPath').value = configData.paths?.base_records_path || '';
        document.getElementById('baseRecordsPathFtp').value = configData.paths?.base_records_path || '';
        document.getElementById('promptsFile').value = configData.paths?.prompts_file || '';
        document.getElementById('additionalVocabFile').value = configData.paths?.additional_vocab_file || '';
        document.getElementById('scriptPromptFile').value = configData.paths?.script_prompt_file || '';
        
        // Транскрипция
        const stereo = configData.transcription?.tbank_stereo_enabled === true;
        document.getElementById('tbankStereoEnabled').checked = stereo;
        const autoDetectOperator = configData.transcription?.auto_detect_operator_name !== false;
        document.getElementById('autoDetectOperatorName').checked = autoDetectOperator;

        // Форматы файлов
        document.getElementById('filenameEnabled').checked = configData.filename?.enabled === true;
        updateFilenameUI();
        renderFilenamePatterns();
        renderFilenameExtensions();
        
        // Слушатель на изменение чекбокса
        document.getElementById('filenameEnabled').addEventListener('change', updateFilenameUI);
        document.getElementById('filenameTestInput').addEventListener('input', testActivePatterns);
        
        // Загружаем коды станций
        loadStationCodes(configData.nizh_station_codes || []);
        // Привязки сотрудников
        renderExtensions(configData.employee_by_extension || {});
        
    } catch (error) {
        console.error('Ошибка загрузки конфигурации:', error);
        showAlert('Ошибка загрузки конфигурации', 'danger');
    }
});

function ensureFilenameConfig() {
    if (!configData.filename) {
        configData.filename = {
            enabled: false,
            patterns: [],
            extensions: ['.mp3', '.wav']
        };
    }
    if (!Array.isArray(configData.filename.patterns)) {
        configData.filename.patterns = [];
    }
    if (!Array.isArray(configData.filename.extensions) || configData.filename.extensions.length === 0) {
        configData.filename.extensions = ['.mp3', '.wav'];
    }
}

function loadStationCodes(codes) {
    const container = document.getElementById('stationCodesContainer');
    container.innerHTML = '';
    
    codes.forEach(code => {
        const tag = document.createElement('span');
        tag.className = 'keyword-tag';
        tag.innerHTML = `
            ${code}
            <span class="remove-keyword" onclick="removeStationCode('${code}')">×</span>
        `;
        container.appendChild(tag);
    });
}

function addStationCode() {
    const input = document.getElementById('newStationCode');
    const code = input.value.trim();
    
    if (code && !configData.nizh_station_codes.includes(code)) {
        configData.nizh_station_codes.push(code);
        loadStationCodes(configData.nizh_station_codes);
        input.value = '';
    }
}

function removeStationCode(code) {
    configData.nizh_station_codes = configData.nizh_station_codes.filter(c => c !== code);
    loadStationCodes(configData.nizh_station_codes);
}

function renderExtensions(map) {
    configData.employee_by_extension = map;
    const container = document.getElementById('extensionsContainer');
    const entries = Object.entries(map);
    if (entries.length === 0) {
        container.innerHTML = '<div class="text-muted">Пока нет привязок</div>';
        return;
    }
    let html = '<table class="table table-sm table-bordered align-middle"><thead><tr><th>Код</th><th>Сотрудник</th><th style="width:80px"></th></tr></thead><tbody>';
    for (const [ext, name] of entries) {
        html += `<tr>
            <td><input class="form-control form-control-sm" value="${ext}" disabled></td>
            <td><input class="form-control form-control-sm" value="${name}" data-ext="${ext}" onchange="onEmployeeChange(this)"></td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeExtension('${ext}')"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}

function addExtension() {
    const code = document.getElementById('extCode').value.trim();
    const emp = document.getElementById('extEmployee').value.trim();
    if (!code || !emp) return;
    if (!configData.employee_by_extension) configData.employee_by_extension = {};
    configData.employee_by_extension[code] = emp;
    document.getElementById('extCode').value = '';
    document.getElementById('extEmployee').value = '';
    renderExtensions(configData.employee_by_extension);
}

function onEmployeeChange(input) {
    const code = input.getAttribute('data-ext');
    configData.employee_by_extension[code] = input.value;
}

function removeExtension(code) {
    if (!configData.employee_by_extension) return;
    delete configData.employee_by_extension[code];
    renderExtensions(configData.employee_by_extension);
}

function updateFilenameUI() {
    const enabled = document.getElementById('filenameEnabled').checked;
    document.getElementById('customFilenameSection').style.display = enabled ? 'block' : 'none';
}

function renderFilenamePatterns() {
    ensureFilenameConfig();
    const tbody = document.getElementById('filenamePatternsContainer');
    const patterns = configData.filename.patterns || [];
    
    if (patterns.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-3">Правила не добавлены. Нажмите "+ Добавить правило"</td></tr>`;
        return;
    }

    tbody.innerHTML = patterns.map((p, idx) => `
        <tr>
            <td><input class="form-control form-control-sm" value="${p.key || ''}" data-idx="${idx}" data-field="key" oninput="onFilenamePatternChange(this)" placeholder="Напр. Asterisk"></td>
            <td><input class="form-control form-control-sm font-monospace" value="${p.template || ''}" data-idx="${idx}" data-field="template" oninput="onFilenamePatternChange(this)" placeholder="{телефон}_{станция}_{дата_время}"></td>
            <td>
                <select class="form-select form-select-sm" data-idx="${idx}" data-field="datetime_format" onchange="onFilenamePatternChange(this)">
                    <option value="%Y-%m-%d-%H-%M-%S" ${p.datetime_format === '%Y-%m-%d-%H-%M-%S' ? 'selected' : ''}>ГГГГ-ММ-ДД-ЧЧ-ММ-СС</option>
                    <option value="%Y%m%d-%H%M%S" ${p.datetime_format === '%Y%m%d-%H%M%S' ? 'selected' : ''}>ГГГГММДД-ЧЧММСС</option>
                    <option value="%Y%m%d%H%M%S" ${p.datetime_format === '%Y%m%d%H%M%S' ? 'selected' : ''}>ГГГГММДДЧЧММСС</option>
                    <option value="%Y_%m_%d" ${p.datetime_format === '%Y_%m_%d' ? 'selected' : ''}>ГГГГ_ММ_ДД</option>
                </select>
            </td>
            <td>
                <select class="form-select form-select-sm" data-idx="${idx}" data-field="direction" onchange="onFilenamePatternChange(this)">
                    <option value="auto" ${p.direction === 'auto' || !p.direction ? 'selected' : ''}>Авто</option>
                    <option value="incoming" ${p.direction === 'incoming' ? 'selected' : ''}>Входящий</option>
                    <option value="outgoing" ${p.direction === 'outgoing' ? 'selected' : ''}>Исходящий</option>
                </select>
            </td>
            <td class="text-center">
                <input type="checkbox" class="form-check-input" data-idx="${idx}" data-field="process_checklist" onchange="onFilenamePatternChange(this)" ${p.process_checklist !== false ? 'checked' : ''}>
            </td>
            <td class="text-end">
                <button class="btn btn-sm btn-outline-danger border-0" type="button" onclick="removeFilenamePattern(${idx})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    testActivePatterns();
}

function templateToRegex(template, dtFormat = '') {
    if (!template) return "";
    // Экранируем спецсимволы регекса, кроме наших тегов
    let res = template.replace(/[.*+?^${}()|[\]\\]/g, (match) => {
        if (match === '{' || match === '}') return match;
        return '\\' + match;
    });
    
    // Более специфичные регексы для даты, чтобы не обрезались на дефисах
    let dtRegex = '.*?';
    if (dtFormat === '%Y%m%d-%H%M%S') dtRegex = '\\d{8}-\\d{6}';
    else if (dtFormat === '%Y-%m-%d-%H-%M-%S') dtRegex = '\\d{4}-\\d{2}-\\d{2}-\\d{2}-\\d{2}-\\d{2}';
    else if (dtFormat === '%Y%m%d%H%M%S') dtRegex = '\\d{14}';
    else if (dtFormat === '%Y_%m_%d') dtRegex = '\\d{4}_\\d{2}_\\d{2}';

    // Заменяем наши теги на именованные группы захвата (формат Python)
    // Используем [^-_]+ для телефона и станции, чтобы они не поглощали лишнего
    res = res.replace(/\{телефон\}/g, '(?P<phone>[^-_]+)')
             .replace(/\{станция\}/g, '(?P<station>[^-_]+)')
             .replace(/\{дата_время\}/g, '(?P<datetime>' + dtRegex + ')')
             .replace(/\{любой\}/g, '.*?');
    
    return '^' + res + '(?:\\..+)?$';
}

function onFilenamePatternChange(input) {
    ensureFilenameConfig();
    const idx = parseInt(input.getAttribute('data-idx'));
    const field = input.getAttribute('data-field');
    if (!configData.filename.patterns[idx]) return;
    
    if (input.type === 'checkbox') {
        configData.filename.patterns[idx][field] = input.checked;
    } else {
        configData.filename.patterns[idx][field] = input.value;
    }
    
    // Если изменился шаблон или формат даты, обновляем скрытый regex
    if (field === 'template' || field === 'datetime_format') {
        const pattern = configData.filename.patterns[idx];
        pattern.regex = templateToRegex(pattern.template, pattern.datetime_format);
    }
    testActivePatterns();
}

function testActivePatterns() {
    const testStr = document.getElementById('filenameTestInput').value.trim();
    const resultDiv = document.getElementById('filenameTestResult');
    
    if (!testStr) {
        resultDiv.innerHTML = '';
        return;
    }

    let found = false;
    const patterns = configData.filename.patterns || [];
    
    for (let p of patterns) {
        let regexStr = templateToRegex(p.template, p.datetime_format);
        if (!regexStr) continue;
        
        try {
            // Конвертируем Python-style (?P<name>) в JS-style (?<name>) для теста в браузере
            const jsRegexStr = regexStr.replace(/\(\?P<(\w+)>/g, '(?<$1>');
            const re = new RegExp(jsRegexStr, 'i');
            const match = testStr.match(re);
            if (match) {
                const phone = (match.groups && match.groups.phone) || '---';
                const station = (match.groups && match.groups.station) || '---';
                const dt = (match.groups && match.groups.datetime) || '---';
                resultDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i> Шаблон: <strong>${p.key || 'Без имени'}</strong></span><br>` +
                                    `<span class="text-muted">Тел: ${phone}, Стац: ${station}, Дата: ${dt}</span>`;
                found = true;
                break;
            }
        } catch(e) {
            console.error("Ошибка теста регекса:", e);
        }
    }

    if (!found && patterns.length > 0) {
        resultDiv.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i> Ни один шаблон не подошёл</span>';
    }
}

function addFilenamePattern() {
    ensureFilenameConfig();
    configData.filename.patterns.push({ 
        key: '', 
        template: '', 
        regex: '', 
        datetime_format: '%Y-%m-%d-%H-%M-%S',
        direction: 'auto',
        process_checklist: true,
        example: '' 
    });
    renderFilenamePatterns();
}

function removeFilenamePattern(idx) {
    ensureFilenameConfig();
    configData.filename.patterns.splice(idx, 1);
    renderFilenamePatterns();
}

function renderFilenameExtensions() {
    ensureFilenameConfig();
    const container = document.getElementById('filenameExtensionsContainer');
    const exts = configData.filename.extensions || [];
    if (exts.length === 0) {
        container.innerHTML = '<span class="text-muted">Нет расширений</span>';
        return;
    }
    container.innerHTML = exts.map(ext => `
        <span class="badge bg-light text-dark border">
            ${ext}
            <button class="btn btn-sm btn-link text-danger p-0 ms-1" type="button" onclick="removeFilenameExtension('${ext}')">
                <i class="fas fa-times"></i>
            </button>
        </span>
    `).join(' ');
}

function addFilenameExtension() {
    ensureFilenameConfig();
    const input = document.getElementById('filenameExtensionInput');
    let value = (input.value || '').trim();
    if (!value) return;
    if (!value.startsWith('.')) {
        value = '.' + value;
    }
    if (!configData.filename.extensions.includes(value)) {
        configData.filename.extensions.push(value);
        renderFilenameExtensions();
    }
    input.value = '';
}

function removeFilenameExtension(ext) {
    ensureFilenameConfig();
    configData.filename.extensions = (configData.filename.extensions || []).filter(e => e !== ext);
    renderFilenameExtensions();
}

// Save configuration
async function saveAllConfig() {
    try {
        const sourceType = document.querySelector('input[name="sourceType"]:checked').value;
        const basePath = sourceType === 'ftp' 
            ? document.getElementById('baseRecordsPathFtp').value 
            : document.getElementById('baseRecordsPath').value;

        ensureFilenameConfig();
        
        // Собираем все данные в один объект
        const fullPayload = {
            api_keys: {
                speechmatics_api_key: document.getElementById('speechmaticsApiKey').value,
                thebai_api_key: document.getElementById('thebaiApiKey').value,
                telegram_bot_token: document.getElementById('telegramBotToken').value
            },
            telegram: {
                alert_chat_id: document.getElementById('alertChatId').value,
                reports_chat_id: document.getElementById('reportsChatId').value,
                tg_channel_nizh: document.getElementById('tgChannelNizh').value,
                tg_channel_other: document.getElementById('tgChannelOther').value
            },
            paths: {
                base_records_path: basePath,
                prompts_file: document.getElementById('promptsFile').value,
                additional_vocab_file: document.getElementById('additionalVocabFile').value,
                script_prompt_file: document.getElementById('scriptPromptFile').value,
                source_type: sourceType,
                ftp_connection_id: sourceType === 'ftp' ? parseInt(document.getElementById('ftpConnectionId').value) || null : null
            },
            transcription: {
                tbank_stereo_enabled: document.getElementById('tbankStereoEnabled').checked,
                auto_detect_operator_name: document.getElementById('autoDetectOperatorName').checked
            },
            filename: {
                enabled: document.getElementById('filenameEnabled').checked,
                patterns: configData.filename.patterns,
                extensions: (configData.filename.extensions || []).map(e => e.trim()).filter(Boolean)
            },
            stations: {
                nizh_station_codes: configData.nizh_station_codes,
                stations: configData.stations,
                station_chat_ids: configData.station_chat_ids,
                station_mapping: configData.station_mapping
            },
            employee_by_extension: configData.employee_by_extension || {}
        };

        const response = await fetch('/api/config/save_all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fullPayload)
        });

        const result = await response.json();
        if (result.success) {
            showAlert('Все настройки успешно сохранены', 'success');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        showAlert('Ошибка сохранения: ' + error.message, 'danger');
    }
}

// Reset configuration
function resetConfig() {
    showConfirm('Вы уверены, что хотите сбросить все настройки?', function() {
        showAlert('Настройки сброшены', 'info');
    });
}
</script>
{% endblock %}

{% block extra_js %}
<!-- Additional config-specific JS can go here -->
{% endblock %}
