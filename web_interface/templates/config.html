<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигурация - Call Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .config-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .config-title {
            color: #667eea;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            color: white;
        }
        .keyword-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin: 2px;
            display: inline-block;
        }
        .keyword-tag .remove-keyword {
            cursor: pointer;
            margin-left: 5px;
            color: #d32f2f;
        }
        .input-group .btn-outline-secondary {
            border-left: none;
            border-color: #ced4da;
        }
        .input-group .btn-outline-secondary:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
        .input-group .form-control:focus + .btn-outline-secondary {
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Боковая панель -->
                                                {% include 'partials/sidebar.html' %}

            <!-- Основной контент -->
            <main class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h3 mb-0">Конфигурация системы</h1>
                        <button class="btn btn-save" onclick="saveAllConfig()">
                            <i class="fas fa-save me-2"></i>Сохранить все настройки
                        </button>
                    </div>

                    <!-- API Ключи -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-key me-2"></i>API Ключи
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Speechmatics API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="speechmaticsApiKey" 
                                               placeholder="Введите ключ Speechmatics">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleSpeechmatics" onclick="togglePassword('speechmaticsApiKey', 'toggleSpeechmatics')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Ключ для сервиса транскрипции речи</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">TheB.ai API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="thebaiApiKey" 
                                               placeholder="Введите ключ TheB.ai">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleThebai" onclick="togglePassword('thebaiApiKey', 'toggleThebai')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Ключ для AI анализа звонков</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telegram Bot Token</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="telegramBotToken" 
                                               placeholder="Введите токен Telegram бота">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleTelegram" onclick="togglePassword('telegramBotToken', 'toggleTelegram')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Токен для отправки уведомлений</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Telegram настройки -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fab fa-telegram me-2"></i>Telegram настройки
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Alert Chat ID</label>
                                    <input type="text" class="form-control" id="alertChatId" 
                                           placeholder="ID чата для критических уведомлений">
                                    <div class="form-text">Основной чат для уведомлений об ошибках</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Нижегородский канал</label>
                                    <input type="text" class="form-control" id="tgChannelNizh" 
                                           placeholder="ID канала для Нижегородских станций">
                                    <div class="form-text">Канал для станций Нижегородского региона</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Остальные станции канал</label>
                                    <input type="text" class="form-control" id="tgChannelOther" 
                                           placeholder="ID канала для остальных станций">
                                    <div class="form-text">Канал для станций других регионов</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Пути к файлам -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-folder me-2"></i>Пути к файлам
                        </h3>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Источник звонков</label>
                                <div class="btn-group" role="group" id="sourceTypeGroup">
                                    <input type="radio" class="btn-check" name="sourceType" id="sourceTypeLocal" value="local" checked>
                                    <label class="btn btn-outline-primary" for="sourceTypeLocal">
                                        <i class="fas fa-folder me-1"></i> Локальная папка
                                    </label>
                                    <input type="radio" class="btn-check" name="sourceType" id="sourceTypeFtp" value="ftp">
                                    <label class="btn btn-outline-primary" for="sourceTypeFtp">
                                        <i class="fas fa-server me-1"></i> FTP подключение
                                    </label>
                                </div>
                                <div class="form-text">Выберите откуда брать файлы звонков для обработки</div>
                            </div>
                        </div>
                        <div class="row" id="localPathRow">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Базовая папка записей</label>
                                    <input type="text" class="form-control" id="baseRecordsPath" 
                                           placeholder="E:/CallRecords">
                                    <div class="form-text">Основная папка для хранения записей звонков</div>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="ftpConnectionRow" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">FTP подключение</label>
                                    <select class="form-select" id="ftpConnectionId">
                                        <option value="">-- Выберите подключение --</option>
                                    </select>
                                    <div class="form-text">Выберите FTP подключение для синхронизации файлов</div>
                                    <small class="text-muted">Файлы будут скачиваться в локальную папку и обрабатываться автоматически</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Локальная папка для сохранения</label>
                                    <input type="text" class="form-control" id="baseRecordsPathFtp" 
                                           placeholder="E:/CallRecords">
                                    <div class="form-text">Папка, куда будут скачиваться файлы с FTP</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Файл промптов</label>
                                    <input type="text" class="form-control" id="promptsFile" 
                                           placeholder="E:/CallRecords/mon/prompts.yaml">
                                    <div class="form-text">Файл с промптами для анализа</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Файл словаря</label>
                                    <input type="text" class="form-control" id="additionalVocabFile" 
                                           placeholder="E:/CallRecords/mon/additional_vocab.yaml">
                                    <div class="form-text">Дополнительный словарь для транскрипции</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">������� script_prompt_8</label>
                                    <input type="text" class="form-control" id="scriptPromptFile" 
                                           placeholder="E:/CallRecords/mon/script_prompt_8.yaml">
                                    <div class="form-text">YAML ������ script_prompt_8</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Транскрипция -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-wave-square me-2"></i>Транскрипция
                        </h3>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="tbankStereoEnabled">
                            <label class="form-check-label" for="tbankStereoEnabled">Стерео режим (2 спикера, диаризация по каналам)</label>
                        </div>
                        <div class="form-text mb-3">При включении используется стерео алгоритм из T‑Bank с анализом голосов; при выключении — стандартный моно режим.</div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoDetectOperatorName">
                            <label class="form-check-label" for="autoDetectOperatorName">Автоматическое определение имени оператора</label>
                        </div>
                        <div class="form-text mt-2">При включении система пытается извлечь имя оператора из транскрипции (когда консультант представляется), затем использует таблицу привязки. При выключении сразу берет имя из таблицы EMPLOYEE_BY_EXTENSION.</div>
                    </div>

                    <!-- Форматы файлов -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-file-audio me-2"></i>Форматы аудиофайлов
                        </h3>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="filenameEnabled">
                            <label class="form-check-label" for="filenameEnabled">Использовать свои правила для имён файлов</label>
                        </div>
                        
                        <div id="customFilenameSection" style="display: none;">
                            <div class="alert alert-info py-2 mb-3" style="font-size: 0.9rem;">
                                <i class="fas fa-info-circle me-2"></i>
                                Используйте теги: <strong>{телефон}</strong>, <strong>{станция}</strong>, <strong>{дата_время}</strong> и <strong>{любой}</strong>.
                                <br>Пример: <code>{телефон}_{станция}_{дата_время}</code> или <code>rec-{телефон}-{дата_время}</code>
                            </div>

                            <div class="mb-3">
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle">
                                        <thead>
                                            <tr>
                                                <th style="width:15%">Название (Бренд АТС)</th>
                                                <th>Шаблон (как выглядит имя файла)</th>
                                                <th style="width:15%">Формат даты</th>
                                                <th style="width:12%">Направление</th>
                                                <th style="width:10%" title="Запускать ли детальный анализ по чек-листу для этих звонков?">Чек-лист</th>
                                                <th style="width:50px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="filenamePatternsContainer">
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" type="button" onclick="addFilenamePattern()">
                                    <i class="fas fa-plus me-1"></i> Добавить правило
                                </button>
                            </div>

                            <!-- Блок тестирования -->
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2"><i class="fas fa-vial me-2"></i>Проверить шаблон</h6>
                                    <div class="row g-2">
                                        <div class="col-md-8">
                                            <input type="text" class="form-control form-control-sm" id="filenameTestInput" 
                                                   placeholder="Вставьте сюда реальное имя файла (например: 79001112233_101_2023-12-01.mp3)">
                                        </div>
                                        <div class="col-md-4">
                                            <div id="filenameTestResult" class="small mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Разрешенные расширения</label>
                            <div id="filenameExtensionsContainer" class="d-flex flex-wrap gap-1 mb-2"></div>
                            <div class="input-group input-group-sm" style="max-width: 200px;">
                                <input type="text" class="form-control" id="filenameExtensionInput" placeholder=".mp3">
                                <button class="btn btn-outline-primary" type="button" onclick="addFilenameExtension()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-text small">Если свои правила отключены, система использует стандартные форматы (fs_*, external-*, вход_*).</div>
                    </div>

                    <!-- Коды станций Нижегородского региона -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-map-marker-alt me-2"></i>Коды станций Нижегородского региона
                        </h3>
                        <div class="mb-3">
                            <label class="form-label">Добавить код станции</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newStationCode" 
                                       placeholder="Введите код станции (например: 9322)">
                                <button class="btn btn-outline-primary" type="button" onclick="addStationCode()">
                                    <i class="fas fa-plus"></i> Добавить
                                </button>
                            </div>
                        </div>
                        <div id="stationCodesContainer">
                            <!-- Коды станций будут загружены динамически -->
                        </div>
                    </div>

                    <!-- Привязка внутренних номеров к сотрудникам -->
                    <div class="config-section">
                        <h3 class="config-title">
                            <i class="fas fa-user-tag me-2"></i>Привязка вн. номеров к сотрудникам
                        </h3>
                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Код станции/подстанции</label>
                                <input type="text" id="extCode" class="form-control" placeholder="например: 202 или 403">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Сотрудник (ФИО/фамилия)</label>
                                <input type="text" id="extEmployee" class="form-control" placeholder="например: Иванов">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" type="button" onclick="addExtension()">
                                    <i class="fas fa-plus"></i> Добавить
                                </button>
                            </div>
                        </div>
                        <div id="extensionsContainer" class="table-responsive">
                            <!-- Таблица привязок загружается динамически -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let configData = {};

        // Загрузка конфигурации при старте
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            
            // Обработчики переключения типа источника
            document.querySelectorAll('input[name="sourceType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateSourceTypeUI(this.value);
                });
            });
        });
        
        // Функция переключения UI между локальной папкой и FTP
        function updateSourceTypeUI(sourceType) {
            const localRow = document.getElementById('localPathRow');
            const ftpRow = document.getElementById('ftpConnectionRow');
            
            if (sourceType === 'local') {
                localRow.style.display = 'flex';
                ftpRow.style.display = 'none';
            } else {
                localRow.style.display = 'none';
                ftpRow.style.display = 'flex';
            }
        }
        
        // Загрузка списка FTP подключений
        async function loadFtpConnections() {
            try {
                const response = await fetch('/api/ftp/connections');
                const connections = await response.json();
                
                const select = document.getElementById('ftpConnectionId');
                // Сохраняем текущее значение
                const currentValue = select.value;
                
                // Очищаем и заполняем список
                select.innerHTML = '<option value="">-- Выберите подключение --</option>';
                
                connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.id;
                    option.textContent = `${conn.name} (${conn.host})`;
                    if (conn.id == currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки FTP подключений:', error);
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config/load');
                configData = await response.json();
                ensureFilenameConfig();
                
                // Заполняем поля формы
                document.getElementById('speechmaticsApiKey').value = configData.api_keys?.speechmatics_api_key || '';
                document.getElementById('thebaiApiKey').value = configData.api_keys?.thebai_api_key || '';
                document.getElementById('telegramBotToken').value = configData.api_keys?.telegram_bot_token || '';
                
                document.getElementById('alertChatId').value = configData.telegram?.alert_chat_id || '';
                document.getElementById('tgChannelNizh').value = configData.telegram?.tg_channel_nizh || '';
                document.getElementById('tgChannelOther').value = configData.telegram?.tg_channel_other || '';
                
                // Источник звонков
                const sourceType = configData.paths?.source_type || 'local';
                document.getElementById('sourceTypeLocal').checked = (sourceType === 'local');
                document.getElementById('sourceTypeFtp').checked = (sourceType === 'ftp');
                
                // Загружаем FTP подключения для выпадающего списка
                await loadFtpConnections();
                
                // Устанавливаем выбранное FTP подключение
                const ftpConnectionId = configData.paths?.ftp_connection_id;
                if (ftpConnectionId) {
                    document.getElementById('ftpConnectionId').value = ftpConnectionId;
                }
                
                // Обновляем UI после загрузки подключений
                updateSourceTypeUI(sourceType);
                
                document.getElementById('baseRecordsPath').value = configData.paths?.base_records_path || '';
                document.getElementById('baseRecordsPathFtp').value = configData.paths?.base_records_path || '';
                document.getElementById('promptsFile').value = configData.paths?.prompts_file || '';
                document.getElementById('additionalVocabFile').value = configData.paths?.additional_vocab_file || '';
                document.getElementById('scriptPromptFile').value = configData.paths?.script_prompt_file || '';
                
                // Транскрипция
                const stereo = configData.transcription?.tbank_stereo_enabled === true;
                document.getElementById('tbankStereoEnabled').checked = stereo;
                const autoDetectOperator = configData.transcription?.auto_detect_operator_name !== false; // По умолчанию true
                document.getElementById('autoDetectOperatorName').checked = autoDetectOperator;

        // Форматы файлов
                document.getElementById('filenameEnabled').checked = configData.filename?.enabled === true;
                updateFilenameUI();
                renderFilenamePatterns();
                renderFilenameExtensions();
                
                // Слушатель на изменение чекбокса
                document.getElementById('filenameEnabled').addEventListener('change', updateFilenameUI);
                document.getElementById('filenameTestInput').addEventListener('input', testActivePatterns);
                
                // Загружаем коды станций
                loadStationCodes(configData.nizh_station_codes || []);
                // Привязки сотрудников
                renderExtensions(configData.employee_by_extension || {});
                
            } catch (error) {
                console.error('Ошибка загрузки конфигурации:', error);
                showAlert('Ошибка загрузки конфигурации', 'danger');
            }
        }

        function ensureFilenameConfig() {
            if (!configData.filename) {
                configData.filename = {
                    enabled: false,
                    patterns: [],
                    extensions: ['.mp3', '.wav']
                };
            }
            if (!Array.isArray(configData.filename.patterns)) {
                configData.filename.patterns = [];
            }
            if (!Array.isArray(configData.filename.extensions) || configData.filename.extensions.length === 0) {
                configData.filename.extensions = ['.mp3', '.wav'];
            }
        }

        function loadStationCodes(codes) {
            const container = document.getElementById('stationCodesContainer');
            container.innerHTML = '';
            
            codes.forEach(code => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${code}
                    <span class="remove-keyword" onclick="removeStationCode('${code}')">×</span>
                `;
                container.appendChild(tag);
            });
        }

        function addStationCode() {
            const input = document.getElementById('newStationCode');
            const code = input.value.trim();
            
            if (code && !configData.nizh_station_codes.includes(code)) {
                configData.nizh_station_codes.push(code);
                loadStationCodes(configData.nizh_station_codes);
                input.value = '';
            }
        }

        function removeStationCode(code) {
            configData.nizh_station_codes = configData.nizh_station_codes.filter(c => c !== code);
            loadStationCodes(configData.nizh_station_codes);
        }

        function renderExtensions(map) {
            configData.employee_by_extension = map;
            const container = document.getElementById('extensionsContainer');
            const entries = Object.entries(map);
            if (entries.length === 0) {
                container.innerHTML = '<div class="text-muted">Пока нет привязок</div>';
                return;
            }
            let html = '<table class="table table-sm table-bordered align-middle"><thead><tr><th>Код</th><th>Сотрудник</th><th style="width:80px"></th></tr></thead><tbody>';
            for (const [ext, name] of entries) {
                html += `<tr>
                    <td><input class="form-control form-control-sm" value="${ext}" disabled></td>
                    <td><input class="form-control form-control-sm" value="${name}" data-ext="${ext}" onchange="onEmployeeChange(this)"></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="removeExtension('${ext}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function addExtension() {
            const code = document.getElementById('extCode').value.trim();
            const emp = document.getElementById('extEmployee').value.trim();
            if (!code || !emp) return;
            if (!configData.employee_by_extension) configData.employee_by_extension = {};
            configData.employee_by_extension[code] = emp;
            document.getElementById('extCode').value = '';
            document.getElementById('extEmployee').value = '';
            renderExtensions(configData.employee_by_extension);
        }

        function onEmployeeChange(input) {
            const code = input.getAttribute('data-ext');
            configData.employee_by_extension[code] = input.value;
        }

        function removeExtension(code) {
            if (!configData.employee_by_extension) return;
            delete configData.employee_by_extension[code];
            renderExtensions(configData.employee_by_extension);
        }

        function updateFilenameUI() {
            const enabled = document.getElementById('filenameEnabled').checked;
            document.getElementById('customFilenameSection').style.display = enabled ? 'block' : 'none';
        }

        function renderFilenamePatterns() {
            ensureFilenameConfig();
            const tbody = document.getElementById('filenamePatternsContainer');
            const patterns = configData.filename.patterns || [];
            
            if (patterns.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-3">Правила не добавлены. Нажмите "+ Добавить правило"</td></tr>`;
                return;
            }

            tbody.innerHTML = patterns.map((p, idx) => `
                <tr>
                    <td><input class="form-control form-control-sm" value="${p.key || ''}" data-idx="${idx}" data-field="key" oninput="onFilenamePatternChange(this)" placeholder="Напр. Asterisk"></td>
                    <td><input class="form-control form-control-sm font-monospace" value="${p.template || ''}" data-idx="${idx}" data-field="template" oninput="onFilenamePatternChange(this)" placeholder="{телефон}_{станция}_{дата_время}"></td>
                    <td>
                        <select class="form-select form-select-sm" data-idx="${idx}" data-field="datetime_format" onchange="onFilenamePatternChange(this)">
                            <option value="%Y-%m-%d-%H-%M-%S" ${p.datetime_format === '%Y-%m-%d-%H-%M-%S' ? 'selected' : ''}>ГГГГ-ММ-ДД-ЧЧ-ММ-СС</option>
                            <option value="%Y%m%d-%H%M%S" ${p.datetime_format === '%Y%m%d-%H%M%S' ? 'selected' : ''}>ГГГГММДД-ЧЧММСС</option>
                            <option value="%Y%m%d%H%M%S" ${p.datetime_format === '%Y%m%d%H%M%S' ? 'selected' : ''}>ГГГГММДДЧЧММСС</option>
                            <option value="%Y_%m_%d" ${p.datetime_format === '%Y_%m_%d' ? 'selected' : ''}>ГГГГ_ММ_ДД</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" data-idx="${idx}" data-field="direction" onchange="onFilenamePatternChange(this)">
                            <option value="auto" ${p.direction === 'auto' || !p.direction ? 'selected' : ''}>Авто</option>
                            <option value="incoming" ${p.direction === 'incoming' ? 'selected' : ''}>Входящий</option>
                            <option value="outgoing" ${p.direction === 'outgoing' ? 'selected' : ''}>Исходящий</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input" data-idx="${idx}" data-field="process_checklist" onchange="onFilenamePatternChange(this)" ${p.process_checklist !== false ? 'checked' : ''}>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger border-0" type="button" onclick="removeFilenamePattern(${idx})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            testActivePatterns();
        }

        function templateToRegex(template, dtFormat = '') {
            if (!template) return "";
            // Экранируем спецсимволы регекса, кроме наших тегов
            let res = template.replace(/[.*+?^${}()|[\]\\]/g, (match) => {
                if (match === '{' || match === '}') return match;
                return '\\' + match;
            });
            
            // Более специфичные регексы для даты, чтобы не обрезались на дефисах
            let dtRegex = '.*?';
            if (dtFormat === '%Y%m%d-%H%M%S') dtRegex = '\\d{8}-\\d{6}';
            else if (dtFormat === '%Y-%m-%d-%H-%M-%S') dtRegex = '\\d{4}-\\d{2}-\\d{2}-\\d{2}-\\d{2}-\\d{2}';
            else if (dtFormat === '%Y%m%d%H%M%S') dtRegex = '\\d{14}';
            else if (dtFormat === '%Y_%m_%d') dtRegex = '\\d{4}_\\d{2}_\\d{2}';

            // Заменяем наши теги на именованные группы захвата (формат Python)
            // Используем [^-_]+ для телефона и станции, чтобы они не поглощали лишнего
            res = res.replace(/\{телефон\}/g, '(?P<phone>[^-_]+)')
                     .replace(/\{станция\}/g, '(?P<station>[^-_]+)')
                     .replace(/\{дата_время\}/g, '(?P<datetime>' + dtRegex + ')')
                     .replace(/\{любой\}/g, '.*?');
            
            return '^' + res + '(?:\\..+)?$';
        }

        function onFilenamePatternChange(input) {
            ensureFilenameConfig();
            const idx = parseInt(input.getAttribute('data-idx'));
            const field = input.getAttribute('data-field');
            if (!configData.filename.patterns[idx]) return;
            
            if (input.type === 'checkbox') {
                configData.filename.patterns[idx][field] = input.checked;
            } else {
                configData.filename.patterns[idx][field] = input.value;
            }
            
            // Если изменился шаблон или формат даты, обновляем скрытый regex
            if (field === 'template' || field === 'datetime_format') {
                const pattern = configData.filename.patterns[idx];
                pattern.regex = templateToRegex(pattern.template, pattern.datetime_format);
            }
            testActivePatterns();
        }

        function testActivePatterns() {
            const testStr = document.getElementById('filenameTestInput').value.trim();
            const resultDiv = document.getElementById('filenameTestResult');
            
            if (!testStr) {
                resultDiv.innerHTML = '';
                return;
            }

            let found = false;
            const patterns = configData.filename.patterns || [];
            
            for (let p of patterns) {
                let regexStr = templateToRegex(p.template, p.datetime_format);
                if (!regexStr) continue;
                
                try {
                    // Конвертируем Python-style (?P<name>) в JS-style (?<name>) для теста в браузере
                    const jsRegexStr = regexStr.replace(/\(\?P<(\w+)>/g, '(?<$1>');
                    const re = new RegExp(jsRegexStr, 'i');
                    const match = testStr.match(re);
                    if (match) {
                        const phone = (match.groups && match.groups.phone) || '---';
                        const station = (match.groups && match.groups.station) || '---';
                        const dt = (match.groups && match.groups.datetime) || '---';
                        resultDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i> Шаблон: <strong>${p.key || 'Без имени'}</strong></span><br>` +
                                            `<span class="text-muted">Тел: ${phone}, Стац: ${station}, Дата: ${dt}</span>`;
                        found = true;
                        break;
                    }
                } catch(e) {
                    console.error("Ошибка теста регекса:", e);
                }
            }

            if (!found && patterns.length > 0) {
                resultDiv.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i> Ни один шаблон не подошёл</span>';
            }
        }

        function addFilenamePattern() {
            ensureFilenameConfig();
            configData.filename.patterns.push({ 
                key: '', 
                template: '', 
                regex: '', 
                datetime_format: '%Y-%m-%d-%H-%M-%S',
                direction: 'auto',
                process_checklist: true,
                example: '' 
            });
            renderFilenamePatterns();
        }

        function removeFilenamePattern(idx) {
            ensureFilenameConfig();
            configData.filename.patterns.splice(idx, 1);
            renderFilenamePatterns();
        }

        function renderFilenameExtensions() {
            ensureFilenameConfig();
            const container = document.getElementById('filenameExtensionsContainer');
            const exts = configData.filename.extensions || [];
            if (exts.length === 0) {
                container.innerHTML = '<span class="text-muted">Нет расширений</span>';
                return;
            }
            container.innerHTML = exts.map(ext => `
                <span class="badge bg-light text-dark border">
                    ${ext}
                    <button class="btn btn-sm btn-link text-danger p-0 ms-1" type="button" onclick="removeFilenameExtension('${ext}')">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join(' ');
        }

        function addFilenameExtension() {
            ensureFilenameConfig();
            const input = document.getElementById('filenameExtensionInput');
            let value = (input.value || '').trim();
            if (!value) return;
            if (!value.startsWith('.')) {
                value = '.' + value;
            }
            if (!configData.filename.extensions.includes(value)) {
                configData.filename.extensions.push(value);
                renderFilenameExtensions();
            }
            input.value = '';
        }

        function removeFilenameExtension(ext) {
            ensureFilenameConfig();
            configData.filename.extensions = (configData.filename.extensions || []).filter(e => e !== ext);
            renderFilenameExtensions();
        }

        async function saveAllConfig() {
            try {
                const sourceType = document.querySelector('input[name="sourceType"]:checked').value;
                const basePath = sourceType === 'ftp' 
                    ? document.getElementById('baseRecordsPathFtp').value 
                    : document.getElementById('baseRecordsPath').value;

                ensureFilenameConfig();
                
                // Собираем все данные в один объект
                const fullPayload = {
                    api_keys: {
                        speechmatics_api_key: document.getElementById('speechmaticsApiKey').value,
                        thebai_api_key: document.getElementById('thebaiApiKey').value,
                        telegram_bot_token: document.getElementById('telegramBotToken').value
                    },
                    telegram: {
                        alert_chat_id: document.getElementById('alertChatId').value,
                        tg_channel_nizh: document.getElementById('tgChannelNizh').value,
                        tg_channel_other: document.getElementById('tgChannelOther').value
                    },
                    paths: {
                        base_records_path: basePath,
                        prompts_file: document.getElementById('promptsFile').value,
                        additional_vocab_file: document.getElementById('additionalVocabFile').value,
                        script_prompt_file: document.getElementById('scriptPromptFile').value,
                        source_type: sourceType,
                        ftp_connection_id: sourceType === 'ftp' ? parseInt(document.getElementById('ftpConnectionId').value) || null : null
                    },
                    transcription: {
                        tbank_stereo_enabled: document.getElementById('tbankStereoEnabled').checked,
                        auto_detect_operator_name: document.getElementById('autoDetectOperatorName').checked
                    },
                    filename: {
                        enabled: document.getElementById('filenameEnabled').checked,
                        patterns: configData.filename.patterns,
                        extensions: (configData.filename.extensions || []).map(e => e.trim()).filter(Boolean)
                    },
                    stations: {
                        nizh_station_codes: configData.nizh_station_codes,
                        stations: configData.stations, // Мы не меняем это здесь напрямую, но отправляем для целостности
                        station_chat_ids: configData.station_chat_ids,
                        station_mapping: configData.station_mapping
                    },
                    employee_by_extension: configData.employee_by_extension || {}
                };

                const response = await fetch('/api/config/save_all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullPayload)
                });

                const result = await response.json();
                if (result.success) {
                    showAlert('Все настройки успешно сохранены', 'success');
                    // Если изменились пути, воркер перезапустится автоматически через API (нужно добавить в бэкенд)
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Ошибка сохранения конфигурации:', error);
                showAlert('Ошибка сохранения конфигурации: ' + error.message, 'danger');
            }
        }
        
        async function saveConfigSection(type, data) {
            const response = await fetch('/api/config/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: type,
                    data: data
                })
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
        }

        function togglePassword(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                button.title = 'Скрыть пароль';
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                button.title = 'Показать пароль';
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>


